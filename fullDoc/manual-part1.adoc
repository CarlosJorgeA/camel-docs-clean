= Camel Spring XML Auto Configuration

This is only applicable when using Spring XML files with the `camel-spring-xml` JAR.

A spring XML file is the XML files that uses `<beans>` as root tag and have an embedded `<camelContext>`.
This is the classic way of using XML DSL with Apache Camel. That was implemented before Spring Boot.

If you use Camel on Spring Boot, then look at xref:camelcontext-autoconfigure.adoc[Camel Context Auto Configuration] instead.

== Autoconfiguration of Optional Services

Camel will configure these functions by doing a lookup in the Spring
bean registry to find beans of the given type.

The following list all requires at most one bean defined. If there is
more than one bean of this type, then Camel will *not* use it.

[width="100%",cols="34%,33%,33%",options="header",]
|=======================================================================
|Type |Number of beans |Description
|`AsyncProcessorAwaitManager` |0..1 |To use a third-party async process await manager.
|`BacklogTracer` |0..1 |To use a third-party xref:backlog-tracer.adoc[BacklogTracer].
|`ClassResolver` |0..1 |To use a third-party class resolver. More details at xref:pluggable-class-resolvers.adoc[Pluggable Class Resolvers].
|`Debugger` |0..1 |To use a xref:debugger.adoc[Debugger] usually for tooling.
|`Delayer` |0..1 |To use a third-party xref:components:eips:delay-eip.adoc[Delayer].
|`EventFactory` |0..1 |To use a third-party event factory.
|`ExecutorServiceManager` |0..1 |To use a third-party executor service manager. More details at xref:threading-model.adoc[Threading Model].
|`ExecutorServiceStrategy` |0..1 |To use a third-party executor service strategy. More details at xref:threading-model.adoc[Threading Model].
|`FactoryFinderResolver` |0..1 |To use a third-party factory finder.
|`HeadersMapFactory` |0..1|To use a third-party HeadersMapFactory implementation.
|`HealthCheckRegistry` |0..1|To use a third-party xref:health-check.adoc[HealthCheckRegistry] implementation.
|`InflightRepository` |0..1 |To use a third-party in flight repository.
|`Logger` |0..1 |To use provided org.slf4j.Logger for xref:components::log-component.adoc[Log] component and xref:components:eips:log-eip.adoc[log() EIP].
|`ManagementObjectNameStrategy` |0..1 |To use a third-party strategy for naming `MBeans` for xref:jmx.adoc[management].
|`ManagementStrategy` |0..1 |To use a third-party strategy for xref:jmx.adoc[management], for example, JMX management.
|`MessageHistoryFactory` |0..1 |To use a third-party MessageHistoryFactory implementation.
|`ModelJAXBContextFactory` |0..1 |To use a third-party model JAXB ContextFactory
|`NodeIdFactory` |0..1 |To use a third-party node id factory.
|`PackageScanClassResolver` |0..1 |To use a third-party package scan resolver. More details at xref:pluggable-class-resolvers.adoc[Pluggable Class Resolvers].
|`ProcessorFactory` |0..1 |To use a third-party processor factory.
|`Registry` |0..1 |To use a third-party bean registry. By default, Camel will use Spring ApplicationContext (when using Spring) as registry.
|`RuntimeEndpointRegistry` |0..1 |To use a third-party `RuntimeEndpointRegistry` implementation.
|`RuntimeEndpointRegistry` |0..1|To use a third-party `RuntimeEndpointRegistry` implementation.
|`ShutdownStrategy` |0..1 |To use a third-party shutdown strategy.
|`StreamCachingStrategy` |0..1 |To use a third-party xref:stream-caching.adoc[Stream caching] strategy.
|`ThreadPoolFactory` |0..1 |To use a third-party thread pool factory. More details at xref:threading-model.adoc[Threading Model].
|`TraceFormatter` |0..1 |To use a bean that has the tracing options configured.
|`Tracer`` |0..1 |To use a third-party xref:tracer.adoc[Tracer].
|`UnitOfWorkFactory`` |0..1 |To use third-party `UnitOfWork` implementations created by the factory.
|`UuidGenerator`` |0..1 |To use a third-party xref:uuidgenerator.adoc[UuidGenerator].
|=======================================================================

And the following options have support for any number of beans defined.

[width="100%",cols="34%,33%,33%",options="header",]
|=======================================================================
|Type |Number of beans |Description
|`CamelClusterService` |0..n |To detect xref:clustering.adoc[Clustering] services.
|`EndpointStrategy` |0..n |To use third-party endpoint strategies.
|`EventNotifier` |0..n |To use third-party event notifiers.
|`HealthCheckRepository` |0..n|To use Camel xref:health-check.adoc[Health Check] repositories.
|`InterceptStrategy` |0..n |To use your own xref:components:eips:intercept.adoc[Intercept]that intercepts every processing step in all routes in the xref:camelcontext.adoc[CamelContext]. For instance, you can use this to do an AOP like performance timer interceptor.
|`LifecycleStrategy` |0..n |To use third-party lifecycle strategies.
|`LogListener` |0..n|To use custom `LogListener` implementations.
|`MainListener` |0..n|To use custom `MainListener` implementations.
|`ModelLifecycleStrategy` |0..n |To use third-party model lifecycle strategies.
|`RoutePolicyFactory` |0..n |To use a third-party route policy factory to create a route policy for every route.
|`ServiceRegistry` |0..n |To use camel-cloud xref:service-registry.adoc[Service Registries].
|=======================================================================

= AdviceWith

AdviceWith is used for testing Camel routes where you can _advice_ an existing route before its being tested.

What `adviceWith` allows is to change some factors on the route before the test is being run, such as:

* Intercept sending to endpoints
* Replace incoming endpoint with another
* Take out or replace node(s) of the route
* Insert new node(s) into the route
* Mock endpoints

All these features are available from `AdviceWithRouteBuilder`, which is a specialized
`RouteBuilder`.

== AdviceWithRouteBuilder API

The `AdviceWithRouteBuilder` extends the regular `RouteBuilder` adding specialized methods for _advicing_ routes. The table below lists
the most commonly used methods:

[width="100%",cols="1m,4",options="header",]
|=======================================================================
|Method |Description
| mockEndpoints | Mocks all endpoints in the route.
| mockEndpoints(patterns) | Mocks all endpoints in the route that matches the patterns. You can use wildcards and regular expressions in the given pattern to match multiple endpoints.
| mockEndpointsAndSkip(patterns) | Mocks all endpoints and skip sending to the endpoint in the route that matches the patterns. You can use wildcards and regular expressions in the given pattern to match multiple endpoints.
| replaceFromWith(uri) | To replace the route input with a new endpoint.
| weaveByUri(pattern) | Manipulates the route at the nodes sending to endpoints matching the pattern.
| weaveById(pattern) | Manipulates the route at the node IDs that matches the pattern.
| weaveByToString(pattern) | Manipulates the route at the node string representation(output from toString method) that matches the pattern.
| weaveByType(Class) | Manipulates the route at the node type (class name) that matches the pattern.
| weaveAddFirst | Easily weaves in new nodes at the beginning of the route.
| weaveAddLast | Easily weaves in new nodes at the end of the route.
|=======================================================================

=== Pattern matching

The pattern option is used for matching. It uses the same rules as xref:components:eips:intercept.adoc[Intercept], which is applied in the following order:

* match exact
* match by wildcard (`*`)
* match by regular expression

For example, to match exact, you can use `weaveById("foo")` which will match only the id in the route which has the value foo.
The wildcard is when the pattern ends with a `\*` character, such as: `weaveById("foo*")` which will match any id's starting with foo, such as: foo, foobar, foobie and so forth.
The regular expression is more advanced and allows you to match multiple ids, such as `weaveById("(foo|bar)")` which will match both foo and bar.

If you try to match a pattern on an exact endpoint URI, then mind that URI options ordering may influence, and hence it's best to match by wildcard.

For example, using `mockEndpointsAndSkip("activemq:queue:foo?*")` To match the foo queue and disregard any options.

== Using AdviceWith

To _advice_ you need to use the `AdviceWithRouteBuilder` for manipulating the route.
But first, you need to select which route to manipulate which you can do by the route ID or the route index.

[source,java]
----
AdviceWith.adviceWith(context, "myRoute", new AdviceWithRouteBuilder() {
        @Override
        public void configure() throws Exception {
            weaveAddLast().to("mock:result");
        }
});
----

We introduce a more modern API for _advicing_ routes using Java lambda style.

Below, we are _advicing_ the route with ID myRoute:

[source,java]
----
AdviceWith.adviceWith(context, "myRoute", a ->
     a.weaveAddLast().to("mock:result")
);
----

The variable `a` is a lambda style of the `AdviceWithRouteBuilder` which can be used as shorthand
for inlining the route manipulation.

IMPORTANT: Before using `adviceWith` then it is best to tell Camel that advice is in use, which is covered in the following section.

=== Enabling advice during testing

When `adviceWith` is being used, then Camel will restart the adviced routes. This happens
because the route is manipulated, and Camel needs to:

1. Stop the existing route
2. Remove the existing route
3. Add the new advised route
4. Start the new route

This happens for every _adviced_ route during startup of your unit tests. It happens
quickly: a route is started and then is immediately stopped and removed. This is
an undesired behavior; you want to avoid restarts of the _adviced_ routes.
This is solved by following the following steps:

1. Tell Camel that routes are being _adviced_, which will prevent Apache Camel from automatic starting routes.
2. Advice the routes in your unit test methods
3. Start Camel after you have _adviced_ the routes

When using xref:components:others:test-junit5.adoc[camel-test-junit5] for unit testing, then you can tell Camel that advice is in use by either
overriding the `isUsedAdviceWith` method from `CamelTestSupport` as shown:

[source,java]
----
public class MyAdviceWithTest extends CamelTestSupport {
    @Override
    public boolean isUseAdviceWith() {
        return true; // turn on advice with
    }
}
----

Or when using xref:components:others:test-spring-junit5.adoc[camel-test-spring-junit5] for unit testing you can use the `@UseAdviceWith` annotation as shown:

[source,java]
----
@UseAdviceWith
public class MyAdviceWithTest extends CamelSpringTestSupport {
}
----

Then you advise the routes followed by starting Camel:

[source,java]
----
@Test
public void testMockEndpoints() throws Exception {
    AdviceWith.adviceWith(context, "myRoute", a ->
         a.mockEndpoints();
    );

    context.start();
----

In the unit test method above, we first advise the route by ID, where we auto mock all the endpoints.
After that we start Camel.

=== Logging before and after advicing routes

When using `adviceWith` then Camel will automatically log, the before and after, of each adviced route, in XML format.

However, this requires to have `camel-xml-jaxb` as dependency, which you can add as test scoped if using Maven:

[source,xml]
----
<dependency>
    <groupId>org.apache.camel</groupId>
    <artifactId>camel-xml-jaxb</artifactId>
    <version>x.x.x</version>
    <!-- use the same version as your Camel core version -->
    <scope>test</scope>
</dependency>
----

It is possible to turn of logging as XML, by setting the logging to `false` as shown:

[source,java]
----
AdviceWith.adviceWith(context, "myRoute", false, a ->
     a.mockEndpoints();
);
----

=== Replacing route endpoints

You may have built Camel routes that start from endpoints that consume from databases,
message brokers, cloud systems, or other external systems.

To make unit testing these kinds of routes easier, you can replace the
route input endpoints with internal endpoints such as xref:components::direct-component.adoc[direct],
xref:components::seda-component.adoc[seda], xref:components::stub-component.adoc[stub].

The following illustrates how to do this:

[source,java]
----
@Test
public void testReplaceFrom() throws Exception {
    AdviceWith.adviceWith(context, "myRoute", a ->
        a.replaceFromWith("direct:start");
    );

    context.start();
----

This replaces the input endpoint (from) in the route with ID myRoute, with a direct endpoint, which makes it
easy to send a message to the route when unit testing.

=== Mocking endpoints

When using the `mockEndpoints` methods when _advicing_ routes, then Camel will log during startup
which endpoints have been _adviced_ and their corresponding mock uri, such as:

[source,log]
----
INFO  ceptSendToMockEndpointStrategy - Adviced endpoint [seda://camel] with mock endpoint [mock:seda:camel]
INFO  ceptSendToMockEndpointStrategy - Adviced endpoint [seda://other] with mock endpoint [mock:seda:other]
----

Here Camel have _adviced_ two endpoints:

- seda:camel --> mock:seda:camel
- seda:other --> mock:seda:other

This allows using the mock endpoints in your unit tests for testing, such as:

[source,java]
----
public void testMockEndpoints() throws Exception {
    // advice the route goes here
    // start camel after advice

    // use the auto mocked uris during testing
    getMockEndpoint("mock:seda:camel").expectedMessageCount(3);
    getMockEndpoint("mock:seda:other").expectedMessageCount(1);

    // send messages

    MockEndpoint.assertIsSatisfied(context);
}
----

Replacing the input endpoints, or mocking endpoints in Camel routes by using `adviceWith` is just the beginning
of the route manipulation capabilities available. The following section covers how to go even deeper.

=== Using weave to amend routes

When testing your Camel routes, you can use `adviceWith` to _weave_ the routes before testing.

The following methods are available for the `weave` methods:

[width="100%",cols="1m,4",options="header",]
|=======================================================================
|Method |Description
| remove| Removes the selected node(s).
| replace | Replaces the selected node(s) with the following nodes.
| before | Before the selected node(s), the following nodes is added.
| after | After the selected node(s), the following nodes is added.
|=======================================================================

For example, given the following route:

[source,java]
----
from("direct:start")
  .to("mock:foo")
  .to("mock:bar").id("bar")
  .to("mock:result");
----

Then let's go over the four methods to see how you can use them in unit tests

==== Replace

[source,java]
----
AdviceWith.adviceWith(context.getRouteDefinitions().get(0), context, new AdviceWithRouteBuilder() {
    @Override
    public void configure() throws Exception {
        // weave the node in the route which has id = bar
        // and replace it with the following route path
        weaveById("bar").replace().multicast().to("mock:a").to("mock:b");
    }
});
----

In this example we replace the `.to("mock:bar").id("bar")` with the `.multicast().to("mock:a").to("mock:b")`.
That means instead of sending the message to a mock:bar endpoint, we do a Multicast to mock:a and mock:b endpoints instead.

==== Remove

In the example below, we simply just remove the `.to("mock:bar").id("bar")` from the route:

[source,java]
----
AdviceWith.adviceWith(context.getRouteDefinitions().get(0), context, new AdviceWithRouteBuilder() {
    @Override
    public void configure() throws Exception {
        // weave the node in the route which has id = bar and remove it
        weaveById("bar").remove();
    }
});
----

==== Before

In the example below, we add the following nodes `to("mock:a").transform(constant("Bye World"))` before the node with the id bar.

[source,java]
----
AdviceWith.adviceWith(context.getRouteDefinitions().get(0), context, new AdviceWithRouteBuilder() {
    @Override
    public void configure() throws Exception {
        // weave the node in the route which has id = bar
        // and insert the following route path before the adviced node
        weaveById("bar").before().to("mock:a").transform(constant("Bye World"));
    }
});
----

That means the message being sent before to mock:bar would have been transformed to a constant message Bye World

==== After

In the example below, we add the following nodes `to("mock:a").transform(constant("Bye World"))` after the node with the id bar.

[source,java]
----
AdviceWith.adviceWith(context.getRouteDefinitions().get(0), context, new AdviceWithRouteBuilder() {
    @Override
    public void configure() throws Exception {
        // weave the node in the route which has id = bar
        // and insert the following route path after the advice node
        weaveById("bar").after().to("mock:a").transform(constant("Bye World"));
    }
});
----

That means the message being sent after mock:bar would have been transformed to a constant message Bye World

=== weave without using IDs

When weaving a route, you need to use one of the `weaveBy` methods
as criteria to select one or more nodes in the route graph.

Suppose you use the xref:components:eips:split-eip.adoc[Split] EIP in a route; then you can use `weaveByType` to select this EIP.
Given the following route:

[source,java]
----
from("file:inbox").routeId("inbox")
    .split(body())
    .transform(simple("${body.toLowerCase()}"))
        .to("mock:line")
    .end()
    .to("mock:combined");
----

Due to that route has only one xref:components:eips:split-eip.adoc[Split] EIP, you can use `weaveByType` to find this single
splitter in the route. Using `weaveByType` requires you to pass in the model type of
the EIP. The name of the model type is using the pattern _name_Definition.

[source,java]
----
weaveByType(SplitDefinition.class)
    .before()
        .transform(simple("${body},Camel is awesome"));
----

Here we weave and select the xref:components:eips:split-eip.adoc[Split] EIP and weave in a message transformation, that
is processed before calling the splitter. This means the message body is appended with _Camel is awesome_.

=== weaveByToUri

The `weaveByToUri` is a handy method that makes it easy to _weave_ a Camel route that
send messages to a given endpoint URI or pattern.

Given the following route having two branches in the xref:components:eips:choice-eip.adoc[Content Based Router] EIP:

[source,java]
----
from("direct:start")
    .choice()
        .when(header("foo")).to("direct:branch-1")
    .otherwise()
        .to("direct:branch-2");
----

Then we want to easily unit test this route, that messages are sent branch-1 or branch-2.
This can be done with the `weaveByToUri` as shown:

[source,java]
----
weaveByToUri("direct:branch*").replace().to("mock:cheese");
----

Notice the `weaveByToUri` method is using a wildcard (`*`) to match the two branches.

TIP: You can also use `mockEndpoints` to auto mock instead of `weaveByToUri` in the example above.
The `weave` methods have a lot more power to manipulate the route, such as message transformation, routing the message or much more.

=== weaveAddFirst and weaveAddLast

The `weaveAddFirst` and `weaveAddLast` is a shorthand to easily add nodes to the route.
These methods can only add to an existing route. If you want to manipulate the route, then use the other `weave` methods as already covered.

The `weaveAddFirst` method adds in the beginning of the route, and `weaveAddLast` at the end.
Using them works the same as the other `weaveBy` methods, so see above for examples.

=== weave using node selection

The `weaveBy` methods, select all matching nodes, which can be anything
from none, one, two, or more nodes. In those situations, you may want to narrow
the selection to a specific node. This can be done by using the select methods:

- `selectFirst` Selects only the first node.
- `selectLast` Selects only the last node.
- `selectIndex(index)` Selects only the nth node. The index is zero-based.
- `selectRange(from, to)` Selects the nodes within the given range. The index is zero-based.
- `maxDeep(level)` Limits the selection to at most N levels deep in the Camel route tree. The first level is number 1. So number 2 is the children of the first-level nodes.

Given the following route which has multiple xref:components:eips:filter-eip.adoc[Filter] EIP,
then we want to only advise the second filter.

[source,java]
----
from("file:inbox").routeId("inbox")
    .filter(header("foo"))
        .to("mock:foo")
    .end()
    .to("mock:a")
    .filter(header("bar"))
        .to("mock:bar")
    .end()
    .to("mock:b")
    .filter(header("cheese"))
        .to("mock:cheese")
    .end()
    .to("mock:c")
----

You can then use `weaveByType` to match the Filter EIPs and selectIndex to match the second found:

[source,java]
----
weaveByType(FilterDefinition.class).selectIndex(1).replace().to("mock:changed");
----

= Architecture

The following diagram shows a high-level view of the main concepts that make up Camel's architecture.

image::images/camel-architecture.png[image]

At the center of the diagram you have the _heart_ of Apache Camel; the xref:camelcontext.adoc[CamelContext].
The `CamelContext` is "Camel" ... the runtime Camel, that contains and holds everything together.

xref:routes.adoc[Routes] are defined using one of Camel’s xref:dsl.adoc[DSLs].
xref:processor.adoc[Processors] are used to transform and
manipulate messages during routing as well as to implement all the
xref:components:eips:enterprise-integration-patterns.adoc[EIP]s, which have
corresponding names in the DSLs. xref:component.adoc[Components] are the extension points in Camel
for adding connectivity to other systems. To expose these systems to the rest of Camel,
components provide an xref:endpoint.adoc[endpoint] interface.

== Routes 101

You use Camel for integration, and a key concept in Camel is xref:routes.adoc[routes] which
tells Camel how messages should be routed between systems.

A route has exactly one input xref:endpoint.adoc[endpoint],
and 0, 1 or more output xref:endpoint.adoc[endpoints].

You use Camel xref:dsl.adoc[DSL] to _code_ the xref:routes.adoc[routes].
For example the route below is coded in xref:java-dsl.adoc[Java DSL]:

[source,java]
----
public class MyRoute extends RouteBuilder {

    public void configure() throws Exception {
        from("ftp:myserver/folder")
            .to("activemq:queue:cheese");
    }
}
----

= BacklogDebugger

Camel supports a backlog debugger that is used for live debugging of
messages that are routed in Camel. 
The backlog debugger has additional functionality for easier debugging
aimed at tooling, than the Debugger. The backlog
debugger is exposed in JMX in the tracer node with the name
`BacklogDebugger`. The JMX API is defined in the
`org.apache.camel.api.management.mbean.ManagedBacklogDebuggerMBean`
interface.

You can enable or disable the BacklogDebugger dynamically, by calling
`enableDebugger` or `disableDebugger` methods.

NOTE: This requires to enabled JMX by including `camel-management` JAR in the classpath.

== Options

[width="100%",cols="10%,20%,70%",options="header",]
|=======================================================================
|Option |Default |Description
|`bodyIncludeFiles` |`true` |Whether to include the message body of file based messages. The overhead is that the file content has to be read from the file.
|`bodyIncludeStreams` |`false` |Whether to include the message body of stream based messages. If enabled then beware the stream may not be re-readable later. See more about Stream Caching.
|`bodyMaxChars` |`32kb` |To limit the message body to a maximum size in the traced message. Use 0 or negative value to use unlimited size.
|`includeExchangeProperties` |`true`|Whether to include the exchange properties in the traced message.
|`includeExchangeVariables` |`true`|Whether to include the exchange variables in the traced message.
|`standby` | `false` |Whether the debugger is standby. If a debugger is in standby then the debugger is activated during startup and are ready to be enabled manually via JMX or calling the enableDebugger method.
|`enabled` |`false` |Whether the debugger is enabled or not.
|`singleStepMode` |`false` |Whether currently in single step mode of a single Exchange.
|`singleStepLast` |`false` |In single step mode, then when the exchange is complete, then simulate a breakpoint as last, that allows to suspend and watch the exchange when complete (you can see message body as response, failed exception etc).
|=======================================================================

== Operations

[width="100%",cols="10%,20%,70%",options="header",]
|=======================================================================
|Option |Type |Description
|`addBreakpoint(nodeId)` |`void` |To add a breakpoint at the given node.
|`addConditionalBreakpoint(nodeId, language, predicate)` |`void` |To add a conditional breakpoint at the given node. The predicate is created from the language parameter.
|`disableBreakpoint(nodeId)` |`void` |To disable a breakpoint.
|`disableDebugger` |`void` |To disable the debugger
|`dumpTracedMessagesAsXml(nodeId)` |`String` |To dump the debugged messages from the give node id in XML format.
|`dumpTracedMessagesAsXml(nodeId, boolean)` |`String` |To dump the debugged messages from the give node id in XML format, optionally including the exchange properties.
|`enableBreakpoint(nodeId)` |`void` |To activate a breakpoint which has been disabled.
|`enableDebugger` |`void` |To enable the debugger
|`evaluateExpressionAtBreakpoint(nodeId, language, expression)` | `String`|To evaluate an expression in any supported language (e.g. Simple, CSimple, etc.) and convert the result to String
|`evaluateExpressionAtBreakpoint(nodeId, language, expression, resultType)` | `Object`|To evaluate an expression in any supported language (e.g. Simple, CSimple, etc.) and return the result as a given result type
|`getBreakpoints` |`Set<String>` |To get a set of all the nodes which has a breakpoint added.
|`getDebuggerCounter` |`long` |Gets the total number of debugged messages.
|`getSuspendedBreakpointNodeIds` |`Set<String>` |To get a set of all the nodes which has suspended breakpoints (eg an Exchange at the breakpoint which is suspended).
|`removeBreakpoint(nodeId)` |`void` |To remove the breakpoint from the given node id.
|`resetDebuggerCounter` |`void` |To reset the debugger counter.
|`resumeAll` |`void` |To resume all suspended breakpoints.
|`resumeBreakpoint(nodeId)` |`void` |To resume a suspend breakpoint, which will then continue routing the Exchange.
|`setExchangePropertyOnBreakpoint(nodeId,exchangePropertyName,value)` |`void` |To update/add the Exchange property on the suspended Exchange at the node.
|`setFallbackTimeout(value)` |`long` |Fallback Timeout in seconds (300 seconds as default) when block the message processing in Camel. A timeout used for waiting for a message to arrive at a given breakpoint. `
|`setMessageBodyOnBreakpoint(nodeId,body)` |`void` |To update the message body on the suspended Exchange at the node.
|`setMessageHeaderOnBreakpoint(nodeId,headerName,value)` |`void` |To update/add the message header on the suspended Exchange at the node.
|`stepBreakpoint(nodeId)` |`void` |To start single step mode from a suspended breakpoint at the given node. Then invoke `step` to step to next node in the route.
|`step` |`void` |To step to next node when in single step mode.
|`validateConditionalBreakpoint` |`String` |Used for validating if a given predicate is valid or not. Returns null if valid, otherwise a string with the error message.
|`messageHistoryOnBreakpointAsXml(nodeId)` |`String` |Returns message history at the given node Id in XML format
|=======================================================================

== Enabling

You would need to enable backlogger debugger using the JMX API.

== See Also

See xref:debugger.adoc[Debugger]= BacklogTracer

Camel supports a backlog tracer interceptor that is used for capturing a
trace message of each message as they are routed in Camel.
The trace message is stored in a backlog queue, which contains the last
N messages for each node in the routes (by default 10).

== What is the difference between BacklogTracer and Tracer

Camel also provides a xref:tracer.adoc[Tracer] which has similar
capabilities as this backlog tracer. The difference is that the backlog
tracer is storing a capture of the message in an internal backlog queue.

The xref:tracer.adoc[Tracer] is event based and logs the messages as they
happen (or route to another Camel destination).

Use the xref:tracer.adoc[Tracer] when all you need is to log the traced messages
as they happen.

The backlog tracer allows you to pull the messages from
the backlog queues on demand. The backlog tracer works better with JMX
capable tooling as it is simpler, allowing to bulk dump all its traced
messages in either a POJO or XML format.

== Options

[width="100%",cols="10%,10%,80%",options="header",]
|===

|Option |Default |Description

|standby | `false` |Whether the tracer is standby. If a tracer is in standby then the tracer is activated during startup and are ready to be enabled manually via JMX or calling the enabled method.
|enabled |`false` |Flag to enable or disable this tracer

|backlogSize |`100` |Maximum number of total traced messages to keep in the backlog (FIFO
queue). Should be between 1 - 1000.

|tracePattern |`null` |Allows to filter tracing using a pattern that matches against the node
id and route id. For example use `"to1,to2"` to match only nodes with
either the name "to1", or "to2". You can use * for wildcards. So you can
do "to*" to match any to. Or use "route-foo*" to match any foo routes.

|traceFilter |`null` |Allow to configure a filter as a xref:predicate.adoc[Predicate] using
any of the Camel xref:languages.adoc[languages]. But default the
xref:components:languages:simple-language.adoc[Simple] language is used. For example to filter on
messages with a given header, use `${header.foo} != null`. To use
xref:components:languages:groovy-language.adoc[Groovy] then prefix the value with "groovy:". And
similar for the other languages.

|traceRests |`false` | Whether tracing should trace inner details from Rest DSL.
Turning this on increases the verbosity of tracing by including events from internal routes by Rest DSL.

|traceTemplates |`false` | Whether tracing should trace inner details from route templates (or kamelets).
Turning this on increases the verbosity of tracing by including events from internal routes in the templates or kamelets.

|removeOnDump |`true` |Whether to remove the traced messages that was returned when invoking
the dump methods.

|bodyMaxChars |`32kb` |To limit the message body to a maximum size in the traced message. Use 0
or negative value to use unlimited size.

|bodyIncludeStreams |`false` |Whether to include the message body of stream based messages. If enabled
then beware the stream may not be re-readable later. See more about
xref:stream-caching.adoc[Stream Caching].

|bodyIncludeFiles |`true` |Whether to include the message body of file based messages. The overhead
is that the file content has to be read from the file.

|includeExchangeProperties |`true` |Trace messages to include exchange properties.

|includeExchangeVariables |`true` |Trace messages to include exchange variables.

|includeException |`true` |Trace messages to include exception if the message failed.

|===

[[BacklogTracer-Operations]]
== Operations

[width="100%",cols="10%,20%,70%",options="header",]
|===

|Option |Default |Description

|getTraceCounter |`long` |Gets the total number of traced messages.

|getQueueSize |`long` |Number of traced messages in the backlog.

|resetTraceCounter |`void` |To reset the trace counter.

|dumpTracedMessages(nodeOrRouteId) |`List<BacklogTracerEventMessage>` |To dump the traced messages from the give node or route id.

|dumpTracedMessagesAsXml(nodeOrRouteId) |`String` |To dump the traced messages from the give node or route id in XML format.

|dumpTracedMessagesAsJSon(nodeOrRouteId) |`String` |To dump the traced messages from the give node or route id in JSon format.

|dumpAllTracedMessages |`List<BacklogTracerEventMessage>` |To dump all the traced messages

|dumpAllTracedMessagesAsXml |`String` |To dump all the traced messages in XML format.

|dumpAllTracedMessagesAsJSon |`String` |To dump all the traced messages in JSon format.

|===

== Enabling

You can turn off backlog tracing on `CamelContext`

[source,java]
----
camelContext.setBacklogTracing(true);
----

And in Spring XML

[source,xml]
----
<camelContext backlogTrace="true">
  ...
</camelContext>
----

And in Camel Main you can enable this  in the `application.properties` file:

[source,properties]
----
camel.main.backlog-tracing = true
----

And in Spring Boot you can enable this in the `application.properties` file:

[source,properties]
----
camel.springboot.backlog-tracing = true
----

=== Tracing payloads of InputStream types

Beware that when enabling backlog tracing, and the message payloads is streaming types (such as `java.io.InputStream`),
then the backlog tracer will read the payload and make a copy as a _trace_ that are stored in the backlog tracer.
Then monitoring tooling is able to view these _traced_ events.

When working with `InputStream` types then Camel has xref:stream-caching.adoc[] that is able to automatic
make such types _safe_ to use as they are cached and able to be _re-read_. See more details at xref:stream-caching.adoc[].

However, Camel's stream caching is **ONLY** for message body. Having message headers of type `InputStream` is discouraged
and not common use. If you add custom message headers, then it is recommended to **NOT** use streaming types, but
convert these headers into `String` or `byte[]` or other standard Java types that are in-memory and _safe_ to re-read.

= Batch Consumer

Batch Consumer is basically a xref:components:eips:polling-consumer.adoc[Polling
Consumer] that is capable of polling multiple
Exchanges in a single pool.

To support batching the consumer must implement the `org.apache.camel.BatchConsumer` interface.

A range of Camel components support batching such as:

* xref:components::aws2-ddb-component.adoc[AWS2 DDB]
* xref:components::aws2-kinesis-component.adoc[AWS2 Kinesis]
* xref:components::aws2-s3-component.adoc[AWS2 S3]
* xref:components::aws2-sqs-component.adoc[AWS2 SQS]
* xref:components::file-component.adoc[File]
* xref:components::ftp-component.adoc[FTP]
* xref:components::ironmq-component.adoc[IronMQ]
* xref:components::jooq-component.adoc[Jooq]
* xref:components::jpa-component.adoc[JPA]
* xref:components::mail-component.adoc[Mail]
* xref:components::minio-component.adoc[Minio]
* xref:components::mybatis-component.adoc[MyBatis]
* xref:components::slack-component.adoc[Slack]
* xref:components::splunk-component.adoc[Splunk]
* xref:components::sql-component.adoc[SQL]

== Options

The `BatchConsumer` supports the following options:

[width="100%",cols="20%,80%",options="header",]
|=======================================================================
|Option |Description
|`maxMessagesPerPoll` |An integer to define a maximum messages to gather per poll. By default,
no maximum is set. It can be used to set a limit of e.g., 1000 to avoid when
starting up the server that there are thousands of files. Set a value of
0 or negative to disable it as unlimited.
|=======================================================================

Very often a `BatchConsumer` is scheduled and is based of the `ScheduledBatchPollingConsumer`
that has many options for configuring the scheduling. These options are listed with _(scheduler)_
as label in the endpoint options' in the xref:components::index.adoc[Components] documentation.

== Exchange Properties

The following properties are set on the Exchange for
each Exchange polled in the same batch.

[width="100%",cols="20%,80%",options="header",]
|=======================================================================
|Property |Description
|`CamelBatchSize` |The total number of Exchanges that was polled in this batch.
|`CamelBatchIndex` |The current index of the batch. Starts from 0.
|`CamelBatchComplete` |A boolean indicating the last Exchange in the batch.
Is only `true` for the last entry.
|=======================================================================

= Bean Binding

Bean Binding in Camel defines both which methods are invoked and also
how the xref:components:eips:message.adoc[Message] is converted into the parameters of
the method invoked.

NOTE: This requires to include `camel-bean` as dependency on the classpath.

== Choosing the method to invoke

The binding of a Camel xref:components:eips:message.adoc[Message] to a bean method call
can occur in different ways, in the following order of importance:

* You can qualify parameter types to select
exactly which method to use among overloads with the same name (see
below for more details).
* You can specify parameter values directly in
the method option (see below for more details).
* you can explicitly specify the method name in the xref:dsl.adoc[DSL]
or when using xref:pojo-consuming.adoc[POJO Consuming] or
xref:pojo-producing.adoc[POJO Producing].
* if the bean has a method annotated with the `@Handler` annotation, then
that method is selected.
* if the bean can be converted to a xref:processor.adoc[Processor] using
the xref:type-converter.adoc[Type Converter] mechanism, then this is
used to process the message. The ActiveMQ component
used this mechanism (in Camel 3) to allow any JMS MessageListener to be invoked
directly by Camel without having to write any integration glue code. You
can use the same mechanism to integrate Camel into any other
messaging/remoting frameworks.
* the type of the body is used to find a matching method; an
error is thrown if a single method cannot be chosen unambiguously.
* you can also use `Exchange` as the parameter itself
* the return type cannot be `Exchange`. However, you can use `Exchange` as input parameter, and let
the method be `void`, or return some other Object type (cannot be `Exchange`).
* if the bean class is private (or package-private), interface methods
will be preferred since Camel can't invoke class methods on such beans

In cases when Camel cannot choose a method to invoke, an
`AmbiguousMethodCallException` is thrown.

By default, the return value is set in the outbound message body.

== Asynchronous processing

You can return a `CompletionStage` implementation (e.g. `CompletableFuture`)
to implement asynchronous processing.

Please be sure to properly complete the CompletionStage with the result
or exception, including any timeout handling. Exchange processing would
wait for completion and would not impose any timeouts automatically.
It's extremely useful to
monitor `org.apache.camel.spi.InflightRepository` for any hanging messages.

Note that completing with `"null"` won't set out body message body to `null`,
but would keep message intact. This is useful to support methods that
don't modify exchange and return `CompletableFuture<Void>`. To set body to
null, just add `Exchange` method parameter and directly modify exchange messages.

Examples:

Simple asynchronous processor, modifying message body.

[source,java]
----
public CompletableFuture<String> doSomethingAsync(String body)
----

Composite processor that do not modify exchange

[source,java]
----
 public CompletableFuture<Void> doSomethingAsync(String body) {
     return CompletableFuture.allOf(doA(body), doB(body), doC()); 
 }
----

== Parameter binding

When a method has been chosen for invocation, Camel will bind to the
parameters of the method.

The following Camel-specific types are automatically bound:

* `org.apache.camel.Exchange`
* `org.apache.camel.Message`
* `org.apache.camel.CamelContext`
* `org.apache.camel.TypeConverter`
* `org.apache.camel.spi.Registry`
* `java.lang.Exception`

So, if you declare any of these types, they will be provided by Camel.
*Note that `Exception` will bind to the caught exception in the
xref:exchange.adoc[Exchange]* - so it's often usable if you employ a
xref:components::bean-component.adoc[Bean] to handle, e.g., an `onException` route.

What is most interesting is that Camel will also try to bind the body of
the xref:exchange.adoc[Exchange] to the first parameter of the method
signature (albeit not any of the types above). So if, for instance,
we declare a parameter as `String body`, then Camel will bind the message
body to this type. Camel will also automatically convert to the type
declared in the method signature.

Let's review some examples:

Below is a simple method with a body binding. Camel will bind the IN
body to the `body` parameter and convert it to a `String`.

[source,java]
----
public String doSomething(String body)
----

In the following sample we got one of the automatically bound types as
well. For instance, a `Registry` that we can use to lookup beans.

[source,java]
----
public String doSomething(String body, Registry registry) 
----

We can use xref:exchange.adoc[Exchange] as well:

[source,java]
----
public String doSomething(String body, Exchange exchange) 
----

You can also have multiple types:

[source,java]
----
public String doSomething(String body, Exchange exchange, TypeConverter converter) 
----

And imagine you use a xref:components::bean-component.adoc[Pojo] to handle a given custom
exception `InvalidOrderException` - we can then bind that as well:

[source,java]
----
public String badOrder(String body, InvalidOrderException invalid) 
----

Notice that we can bind to it even if we use a subtype of
`java.lang.Exception` as Camel still knows it's an exception and can
bind the cause (if any exists).

So what about headers and other stuff? Well, now it gets a bit tricky.
We can use annotations to help us or specify the binding in the method name option.

See the following sections for more detail.

== Binding Annotations

You can use the xref:parameter-binding-annotations.adoc[Parameter
Binding Annotations] to customize how parameter values are created from
the xref:components:eips:message.adoc[Message]

=== Examples

For example, a xref:components:eips:bean-eip.adoc[Bean] such as:

[source,java]
----
public class Bar {
    public String doSomething(String body) {
        // process the in body and return whatever you want
        return "Bye World";
    }
}
----

Or the Exchange example. Notice that the return type must be *void* when
there is only a single parameter of the type
`org.apache.camel.Exchange`:

[source,java]
----
 public class Bar {
     public void doSomething(Exchange exchange) {
         // process the exchange 
         exchange.getIn().setBody("Bye World");
     }
 }
----

=== Using @Handler

You can mark a method in your bean with the `@Handler` annotation to
indicate that this method should be used for xref:bean-binding.adoc[Bean
Binding].

This has an advantage as you don't need to specify a method name in the Camel
route, and therefore do not run into problems after renaming the method
in an IDE that can't find all its references.

[source,java]
----
public class Bar {
    @Handler 
    public String doSomething(String body) {
        // process the in body and return whatever you want 
        return "Bye World"; 
    }
} 
----

== Parameter binding using method option

Camel uses the following rules to determine if it's a parameter value in
the method option

* The value is either `true` or `false` which denotes a boolean value
* The value is a numeric value such as `123` or `7`
* The value is a String enclosed with either single or double quotes
* The value is null which denotes a `null` value
* It can be evaluated using the xref:components:languages:simple-language.adoc[Simple] language, which
means you can use, e.g., `$\{body}`, `${header.foo}` and others
xref:components:languages:simple-language.adoc[Simple] tokens. Notice the tokens must be enclosed with
`${ }`.
* The value ends with `.class` then it's a type declaration instead - see the
next section about specifying types for overloaded methods.

When invoking a xref:components:eips:bean-eip.adoc[Bean] you can instruct Camel to invoke a
specific method by providing the method name:

[source,java]
----
.bean(OrderService.class, "doSomething")
----

Here we tell Camel to invoke the `_doSomething_` method.
Camel handles the parameters' binding.
Now suppose the method has 2 parameters, and the
second parameter is a boolean where we want to pass in a true value:

[source,java]
----
public void doSomething(String payload, boolean highPriority) {
    ... 
}
----

This can be done as follows:

[source,java]
----
.bean(OrderService.class, "doSomething(*, true)") 
----

In the example above, we defined the first parameter using the wild card
symbol `*`, which tells Camel to bind this parameter to any type, and let
Camel figure this out. The second parameter has a fixed value of `true`.
Instead of the wildcard symbol, we can instruct Camel to use the message
body as shown:

[source,java]
----
.bean(OrderService.class, "doSomething(${body}, true)") 
----

The syntax of the parameters is using the xref:components:languages:simple-language.adoc[Simple]
language so we have to use `${ }` placeholders in the body to
refer to the message body.

If you want to pass in a `null` value, then you can explicitly define this
in the method option as shown below:

[source,java]
----
.to("bean:orderService?method=doSomething(null, true)")
----

Specifying `null` as a parameter value instructs Camel to force passing
a `null` value.

Besides the message body, you can pass in the message headers as a
`java.util.Map`:

[source,java]
----
.bean(OrderService.class, "doSomethingWithHeaders(${body}, ${headers})") 
----

You can also pass in other fixed values besides booleans. For example,
you can pass in a String and an integer:

[source,java]
----
.bean(MyBean.class, "echo('World', 5)") 
----

In the example above, we invoke the echo method with two parameters. The
first has the content 'World' (without quotes), and the second has the
value of 5. Camel will automatically convert these values to the parameters' types.

Having the power of the xref:components:languages:simple-language.adoc[Simple] language allows us to
bind to message headers and other values such as:

[source,java]
----
.bean(OrderService.class, "doSomething(${body}, ${header.high})") 
----

You can also use the OGNL support of the xref:components:languages:simple-language.adoc[Simple]
expression language. Now suppose the message body is an object that has
a method named `asXml`. To invoke the `asXml` method we can do as
follows:

[source,java]
----
.bean(OrderService.class, "doSomething(${body.asXml}, ${header.high})") 
----

Instead of using `.bean` as shown in the examples above, you may want to
use `.to` instead as shown:

[source,java]
----
.to("bean:orderService?method=doSomething(${body.asXml}, ${header.high})") 
----

=== Using type qualifiers to select among overloaded methods

If you have a xref:components:eips:bean-eip.adoc[Bean] with overloaded methods, you can now
specify parameter types (must use `.class` style, e.g. `com.foo.MyClass.class`) in the method name so Camel can match the method
you intend to use.

Given the following bean:

[source,java]
----
 from("direct:start")
    .bean(MyBean.class, "hello(String.class)")
    .to("mock:result");
----

Then the `MyBean` has 2 overloaded methods with the names `hello` and
`times`. So if we want to use the method which has two parameters, we can
do as follows in the Camel route:

[source,java]
----
from("direct:start")
    .bean(MyBean.class, "hello(String.class, String.class)")
    .to("mock:result"); 
----

We can also use a `*` as wildcard, so we can just say we want to execute
the method with two parameters we do:

[source,java]
----
 from("direct:start")
    .bean(MyBean.class, "hello(*,*)")
    .to("mock:result");
----

By default, Camel will match the type name using the simple name, e.g.,
any leading package name will be disregarded. However, if you want to
match using the FQN, then specify the FQN type and Camel will leverage
that. So if you have a parameter of type `com.foo.MyOrder` and you want to match against
the FQN, and *not* the simple name "MyOrder", then follow this example:

[source,java]
----
.bean(OrderService.class, "doSomething(com.foo.MyOrder.class)")
----

=== Declaring parameter type and value

*Available as of Camel 4.0*

Camel 3.x only supports either specifying parameter binding or
type per parameter in the method name option. You *cannot* specify both
at the same time, such as:

[source,text]
----
doSomething(com.foo.MyOrder.class ${body}, boolean ${header.high}, int 123)
----

However, we have implemented support for this in Camel 4,
where you can declare both using _name.class value_ syntax as shown:

[source,text]
----
doSomething(com.foo.MyOrder.class ${body}, boolean.class ${header.high}, int.class 123)
----

Notice that you *MUST* use `name.class` when declaring the type, also for String, int, boolean, etc.
= Bean Injection

We support the injection of various resources using `@EndpointInject` or
`@BeanInject`. This can be used to inject

* xref:endpoint.adoc[Endpoint] instances which can be used for testing
when used with xref:components::mock-component.adoc[Mock] endpoints; see the
xref:testing.adoc[Testing] for an example.
* xref:producertemplate.adoc[ProducerTemplate] instances for
xref:pojo-producing.adoc[POJO Producing]
* client side proxies for xref:pojo-producing.adoc[POJO Producing]

== Using @BeanInject

You can inject beans (obtained from the
xref:registry.adoc[Registry]) into your beans such as `RouteBuilder`
classes.

For example to inject a bean named foo, you can enlist the bean in the
xref:registry.adoc[Registry] such as in a Spring XML file:

[source,xml]
----
<bean id="foo" class="com.foo.MyFooBean"/>
----

And then in a Java `RouteBuilder` class, you can inject the bean using
`@BeanInject` as shown below:

[source,java]
----
public class MyRouteBuilder extends RouteBuilder {

   @BeanInject("foo")
   MyFooBean foo;

   public void configure() throws Exception {
     ..
   }
}
----

If you omit the name, then Camel does a lookup by type, and injects the
bean if there is exactly only one bean of that type enlisted in the
xref:registry.adoc[Registry].

[source,java]
----
   @BeanInject
   MyFooBean foo;
----

== Bean Injection with Quarkus

When using Camel with Spring Boot, or Quarkus, then the `@Inject`, or `@Named` annotations can
be used to inject Camel resources as well.

== Bean Injection with Spring Boot

Camel has first-class support for Spring Boot, and you can use the Spring annotations
such as `@Autowired` to also inject Camel resources.= Bean Integration

Camel supports the integration of beans and POJOs in a number of ways.

== Annotations

If a bean is defined in Spring XML or scanned using
the Spring component scanning mechanism, and a *<camelContext>* is used
or a `CamelBeanPostProcessor` then we process a number of Camel
annotations to do various things such as injecting resources or
producing, consuming or routing messages.

The following annotations is supported and inject by Camel's
`CamelBeanPostProcessor`

[width="100%",cols="10%,90%",options="header",]
|=======================================================================
|Annotation |Description
|`@EndpointInject` |To inject an endpoint, see more details at xref:pojo-producing.adoc[POJO Producing].
|`@BeanInject` |To inject a bean obtained from the xref:registry.adoc[Registry]. See xref:bean-injection.adoc[Bean Injection].
|`@BeanConfigInject` |To inject a configuration bean obtained from the xref:registry.adoc[Registry]. The bean is a POJO that represents
a set of configuration options, which is automatically configured with values loaded via Camel xref:using-propertyplaceholder.adoc[Property Placeholders].
|`@PropertyInject` |To inject a value using property placeholder.
|`@Produce` |To inject a producer to send a message to an endpoint. See xref:pojo-producing.adoc[POJO Producing].
|`@Consume` |To inject a consumer on a method. See xref:pojo-consuming.adoc[POJO Consuming].
|`@BindToRegistry` |Used for binding a bean to the registry.
  If no name is specified, then the bean will have its name auto computed based on the class name,
 field name, or method name where the annotation is configured.
|`@DeferredContextBinding` | Used to indicate that if the target type is `CamelContextAware` then the `CamelContext` is deferred and injected later; after the bootstrap of Camel so the `CamelContext` is ready for use.
|=======================================================================

See more details at:

* xref:pojo-consuming.adoc[POJO Consuming] to consume and possibly route messages from Camel
* xref:pojo-producing.adoc[POJO Producing] to make it easy to produce camel messages from your POJOs
* `@DynamicRouter` Annotation for creating a xref:components:eips:dynamicRouter-eip.adoc[Dynamic Router] from a POJO method
* `@RecipientList` Annotation for creating a xref:components:eips:recipientList-eip.adoc[Recipient List] from a POJO method
* `@RoutingSlip` Annotation for creating a xref:components:eips:routingSlip-eip.adoc[Routing Slip] for a POJO method
* xref:bean-injection.adoc[Bean Injection] to inject Camel related resources into your POJOs
* xref:using-exchange-pattern-annotations.adoc[Using Exchange Pattern Annotations]
  describes how the pattern annotations can be used to change
  the behaviour of method invocations with Spring Remoting or POJO Producing

*Example*

See the https://github.com/apache/camel-examples/tree/main/pojo-messaging[POJO Messaging Example]
for how to use the annotations for routing and messaging.

== Using @PropertyInject

Camel allows injecting property placeholders in POJOs using
the `@PropertyInject` annotation which can be set on fields and setter
methods. For example, you can use that with `RouteBuilder` classes,
such as shown below:

[source,java]
----
public class MyRouteBuilder extends RouteBuilder {

    @PropertyInject("hello")
    private String greeting;

    @Override
    public void configure() throws Exception {
        from("direct:start")
            .transform().constant(greeting)
            .to("{{result}}");
    }
}
----

Notice we have annotated the greeting field with `@PropertyInject` and
define it to use the key `hello`. Camel will then lookup the property
with this key and inject its value, converted to a String type.

You can also use multiple placeholders and text in the key, for example
we can do:

[source,java]
----
@PropertyInject("Hello {{name}} how are you?")
private String greeting;
----

This will lookup the placeholder with they key `name`.

You can also add a default value if the key does not exist, such as:

[source,java]
----
@PropertyInject(value = "myTimeout", defaultValue = "5000")
private int timeout;
----

=== Using @PropertyInject with arrays, lists, sets or maps

You can also use `@PropertyInject` to inject an array of values. For example, you may configure multiple hostnames
in the configuration file, and need to inject this into an `String[]` or `List<String>` field.
To do this, you need to tell Camel that the property value should be split using a separator, as follows:

[source,java]
----
@PropertyInject(value = "myHostnames", separator = ",")
private String[] servers;
----

TIP: You can also use list/set types, such as `List<String>` or `Set<String>` instead of array.

Then in the `application.properties` file you can define the servers:

[source,properties]
----
myHostnames = serverA, serverB, serverC
----

TIP: This also works for fields that are not String based, such as `int[]` for numeric values.

For `Map` types then the values are expected to be in `_key=value_` format, such as:

[source,properties]
----
myServers = serverA=http://coolstore:4444,serverB=http://megastore:5555
----

You can then inject this into a `Map` as follows:

[source,java]
----
@PropertyInject(value = "myServers", separator = ",")
private Map servers;
----

You can use generic types in the Map such as the values should be `Integer` values:

[source,java]
----
@PropertyInject(value = "ports", separator = ",")
private Map<String, Integer> ports;
----

NOTE: The generic type can only be a single class type, and cannot be a nested complex type such as `Map<String,Map<Kind,Priority>>`.

== See Also

** xref:bean-injection.adoc[Bean Injection]
** xref:bean-binding.adoc[Bean Binding]
= Getting Started with Apache Camel

This content was moved to the link:/camel-core/getting-started[Getting Started].
= BrowsableEndpoint

The `BrowseableEndpoint` is an extension interface an `Endpoint` may implement
to support the browsing of the Message xref:exchange.adoc[Exchanges]
which are pending or have been sent on it.

Some implementations include:

* xref:components::jms-component.adoc[JMS] for queues only
* xref:components::mock-component.adoc[Mock]
* xref:components::seda-component.adoc[SEDA]

= Building Camel from Source

This content was moved to link:/camel-core/contributing[Contributing To Apache Camel Core].

= Apache Camel 2.x to 3.0 Migration Guide

This document is intended to help you migrate your Apache Camel applications
from version 2.x to 3.0.

IMPORTANT: If you are upgrading Camel 3.x to 3.y then use the
xref:camel-3x-upgrade-guide.adoc[Camel 3.x Upgrade Guide].

== Java versions

Camel 3 supports Java 11. Support for Java 8 is best effort for early versions of Camel 3. However, at some time in the 3.x lifeline we will drop support for Java 8.

In Java 11, the JAXB modules have been **removed** from the JDK, therefore, you will need to add them as Maven dependencies (if you use JAXB such as when using XML DSL or the camel-jaxb component):

[source,xml]
----
<dependency>
    <groupId>javax.xml.bind</groupId>
    <artifactId>jaxb-api</artifactId>
    <version>2.3.1</version>
</dependency>

<dependency>
    <groupId>com.sun.xml.bind</groupId>
    <artifactId>jaxb-core</artifactId>
    <version>2.3.0.1</version>
</dependency>

<dependency>
    <groupId>com.sun.xml.bind</groupId>
    <artifactId>jaxb-impl</artifactId>
    <version>2.3.2</version>
</dependency>
----

== Modularization of camel-core

One of the biggest changes is the modularization of camel-core.
In Camel 2.x camel-core was one JAR file, it has now been split up into many JARs as follows:

- camel-api
- camel-base
- camel-caffeine-lrucache
- camel-cloud
- camel-core
- camel-jaxp
- camel-main
- camel-management-api
- camel-management
- camel-support
- camel-util
- camel-util-json

Maven users of Apache Camel can keep using the dependency `camel-core` which has transitive dependencies on all of its modules, except for `camel-main`, and therefore no migration is needed.
However, users who want to trim the size of the classes on the classpath, can use fine-grained Maven dependencies on only the modules needed.
You may find how to do that in the examples.

We have also modularized many of the core components and moved them out of `camel-core` to individual components:

- camel-attachments
- camel-bean
- camel-browse
- camel-controlbus
- camel-dataformat
- camel-dataset
- camel-direct
- camel-directvm
- camel-file
- camel-language
- camel-log
- camel-mock
- camel-ref
- camel-rest
- camel-saga
- camel-scheduler
- camel-seda
- camel-stub
- camel-timer
- camel-validator
- camel-vm
- camel-xpath
- camel-xslt
- camel-xslt-saxon
- camel-zip-deflater

== Spring Boot starters Maven coordinate change

The Maven `groupId` for the Spring Boot starters changed to: `org.apache.camel.springboot`.

Instead of:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel</groupId>
  <artifactId>camel-component-starter</artifactId>
</dependency>
----

Use:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel.springboot</groupId>
  <artifactId>camel-component-starter</artifactId>
</dependency>
----

== Multiple CamelContexts per application not supported

Support for multiple CamelContexts has been removed, and only 1 CamelContext per deployment is supported.
The latter was not recommended anyway and was also not 100% implemented, for example, in `camel-cdi`.
For Camel 3, only 1 `CamelContext` per deployment is recommended and supported.

The `context` attribute on the various Camel annotations such as `@EndpointInject`, `@Produce`, `@Consume` etc. has therefore been removed.

== Migrating custom components

You should depend on `camel-support` and not `camel-core` directly.

The classes from `org.apache.camel.impl` that are intended to support Camel developers building custom components have been moved out of `camel-core` into `camel-support` into the `org.apache.camel.support` package. For example classes such as `DefaultComponent`, `DefaultEndpoint` etc. have been moved and migration is necessary.

== Migrating custom languages

The `LanguageAnnotation` annotation class has been moved from package `org.apache.camel.language` to `org.apache.camel.support.language`.

== Migrating DefaultShutdownStrategy

The `DefaultShutdownStrategy` class has been moved from package `org.apache.camel.impl` to `org.apache.camel.impl.engine`.

== Deprecated APIs and Components

All deprecated APIs and components from Camel 2.x have been removed in Camel 3.

== Migrating Camel applications

=== Main class

The Camel `Main` class has been moved out of `camel-core` into `camel-main` so you should add that as dependency if you use Main.

=== Properties component

The `properties` component has configuring custom prefix and suffix tokens removed as if in use, they had potential issues with clashing with simple languages and elsewhere. The default tokens are now hardcoded and always in use.

The `properties` component has some advanced options removed: `propertyPrefix`, `propertySuffix`, and `fallbackToUnaugmented`; these options was never really useable for end users anyway. The option `propertiesResolver` has also been removed as you should use `PropertiesSource` instead.

The properties component will now use OS environment variables as preferred value. This means you can set an OS environment variable which will override any property values that has been set in property files, JVM system properties etc. You can configure this with the `environmentVariableMode` option on the properties component.

The `properties` component no longer support using endpoints, such as `properties:myKey`. The properties component is now only a property placeholder service.
You can therefore no longer lookup the properties component via `camelContext.getComponent("properties")`.
Instead, you can use `camelContext.getPropertiesComponent()`, which also returns an interface of the properties component as `org.apache.camel.spi.PropertiesComponent`.
The implementation is still named `org.apache.camel.component.properties.PropertiesComponent`, however, it should rarely be used, as you should favour using the interface instead.


=== Removed components

We have removed all deprecated components from Camel 2.x, including the old `camel-http`, `camel-hdfs`, `camel-mina`, `camel-mongodb`, `camel-netty`, `camel-netty-http`, `camel-quartz`, `camel-restlet` and `camel-rx` components.

We removed `camel-jibx` component which wasn't working on JDK 8.

We removed `camel-boon` dataformat which wasn't working on JDK 9 and later.

We removed the `camel-linkedin` component and there is no replacement.

The `camel-zookeeper` has its route policy functionality removed, instead use `ZooKeeperClusterService` or the `camel-zookeeper-master` component.

The `camel-jetty` component no longer supports producer (eg to) which has been removed, use `camel-http` component instead.

The `twitter-streaming` component has been removed as it relied on the deprecated Twitter Streaming API and is no longer functional.

=== Renamed components

The `test` component has been renamed to `dataset-test` and moved out of `camel-core` into `camel-dataset` JAR.

The `http4` component has been renamed to `http`, and it's corresponding component package from `org.apache.camel.component.http4` to `org.apache.camel.component.http`. The supported schemes are now only `http` and `https`.

The `hdfs2` component has been renamed to `hdfs`, and it's corresponding component package from `org.apache.camel.component.hdfs2` to `org.apache.camel.component.hdfs`. The supported scheme is now `hdfs`.

The `mina2` component has been renamed to `mina`, and it's corresponding component package from `org.apache.camel.component.mina2` to `org.apache.camel.component.mina`. The supported scheme is now `mina`.

The `mongodb3` component has been renamed to `mongodb`, and it's corresponding component package from `org.apache.camel.component.mongodb3` to `org.apache.camel.component.mongodb`. The supported scheme is now `mongodb`.

The `netty4-http` component has been renamed to `netty-http`, and it's corresponding component package from `org.apache.camel.component.netty4.http` to `org.apache.camel.component.netty.http`. The supported scheme is now `netty-http`.

The `netty4` component has been renamed to `netty`, and it's corresponding component package from `org.apache.camel.component.netty4` to `org.apache.camel.component.netty`. The supported scheme is now `netty`.

The `quartz2` component has been renamed to `quartz`, and it's corresponding component package from `org.apache.camel.component.quartz2` to `org.apache.camel.component.quartz`. The supported scheme is now `quartz`.

The `rxjava2` component has been renamed to `rxjava`, and it's corresponding component package from `org.apache.camel.component.rxjava2` to `org.apache.camel.component.rxjava`.

We have also renamed `camel-jetty9` to `camel-jetty`. The supported scheme is now `jetty`.

=== Hystrix EIP

The Hystrix EIP has been generalized as a circuit breaker to allow plugging in other implementations.

In the Java DSL you need to migrate from `.hystrix()` to `.circuitBreaker()`.
And in XML DSL `<hystrix>` should be `<circuitBreaker>`.


=== Using endpoint options with consumer. prefix

Endpoints with `consumer.` prefix such as `consumer.delay=5000` are no longer supported (deprecated in latest Camel 2.x) and you should just use the option without the `consumer.` prefix, eg `delay=5000`.

=== Calling a processor as an endpoint

Calling a processor as an endpoint from a route such as:

[source,java]
----
from("jms:cheese")
  .to("myProcessor");
----

Is no longer supported. Instead either use the bean component to call the processor or use `process`:

[source,java]
----
from("jms:cheese")
  .to("bean:myProcessor");
----

Or

[source,java]
----
from("jms:cheese")
  .process("myProcessor");
----

=== Tracing

A new tracer has been implemented and the old tracer has been removed.
The new tracer logs messages at the `org.apache.camel.Tracing` logger name which is hardcoded. The format of the output is also updated to make it better. The tracer can be customized.

In JMX the `BacklogTracer` is no longer enabled by default, which you need to enable by setting `backlogTracing=true` on CamelContext. The backlog tracer and tracer are not the same. The former is used for capturing a backlog of traced messages which you can poll via JMX (needed for 3rd party tooling), where as tracer is writing to the log. Neither of them are enabled by default, and they must be enabled to be in use.

=== <setHeader> and <setProperty> in XML DSL

We have renamed the attribute `headerName` and `propertyName` in the XML DSL for the `<setHeader>` and `<setProperty`> EIPs, to be just `name`.

So migrate

[source,xml]
----
<setHeader headerName="foo"><simple>Hello ${body}</simple></setHeader>
----

To

[source,xml]
----
<setHeader name="foo"><simple>Hello ${body}</simple></setHeader>
----

And the same for `<setProperty>`.

=== <aggregate> EIP in XML DSL

The aggregate EIP has renamed the expressions (not the attributes) for setting correlation size/timeout to avoid a name clash, so migrate:

[source,xml]
----
<completionSize>
  <header>mySize</header>
</completionSize>
----

To

[source,xml]
----
<completionSizeExpression>
  <header>mySize</header>
</completionSizeExpression>
----

And the same for `<completionTimeout>`.

=== <threads> <delay> <sample> <throttle> EIP in XML

These EIPs have been improved to no longer use children for routing, instead they
are collapsed as a single element like other EIPs.

So before you may have

[source,xml]
----
<route>
    <from uri="jms:cheese"/>
    <to uri="log:before"/>
    <threads poolSize="2">
        <to uri="bean:foo"/>
        <to uri="bean:bar"/>
    </threads>
    <to uri="log:after"/>
</route>
----

And now you would do:

[source,xml]
----
<route>
    <from uri="jms:cheese"/>
    <to uri="log:before"/>
    <threads poolSize="2"/>
    <to uri="bean:foo"/>
    <to uri="bean:bar"/>
    <to uri="log:after"/>
</route>
----

It is the same for the other EIPs `<delay>`, `<sample>`, and `<throttle>`.


==== camel-cdi

Support for multiple CamelContexts has been removed, and therefore `@ContextName` has been removed. Instead, use standard CDI annotations such as `@Named` and `@ApplicationScoped`.

=== javax.script

The `camel-script` component has been removed, and there is no support for `javax.script`, which is also deprecated in the JDK and to be removed from Java 11 onwards.

=== Attachments API on Message

The attachments API (`javax.activation`) has been moved out of `org.apache.camel.message` into an extension `org.apache.camel.attachment.AttachmentMessage` from the `camel-attachments` JAR.

To use this API, you can get it via the `getMessage` method on `Exchange`:

  AttachmentMessage am = exchange.getMessage(AttachmentMessage.class);
  am.addAttachment("myAtt", new DataHandler(...));

=== Fault API on Message

The fault API has been removed from `org.apache.camel.Message` as it was only used for SOAP-WS fault message. The `camel-cxf` and `camel-spring-ws` components for SOAP-WS has been modified to support fault messages from their components. The option `handleFault` has also been removed and you now need to turn this on as endpoint or component option on `camel-cxf` or `camel-spring-ws`.

=== getOut on Exchange

The `hasOut` and `getOut` methods on `Exchange` has been deprecated in favour of using `getMessage` instead.
(Side note: `camel-core` is still using these methods in a few places to be backwards compatible and relies on this logic as Camel was initially designed with the concept of IN and OUT messages inspired by the JBI and SOAP-WS specifications.)

=== OUT message removed from Simple language and Mock component

The simple language has removed the OUT message concepts eg `${out.body}`.
Also, the mock component has removed OUT message from its assertion API, eg

  mock.message(0).outBody()...

Also, the `@OutHeaders` annotation for bean parameter binding has been removed, instead use `@Headers` instead.

=== Mock component

The `mock` component has been moved out of `camel-core` and as part of this work, we had to remove a number of methods on its _assertion clause builder_ that were seldom in use.

=== ActiveMQ

If you are using the `activemq-camel` component, then you should migrate to use `camel-activemq` component, where the component name has changed from `org.apache.activemq.camel.component.ActiveMQComponent` to `org.apache.camel.component.activemq.ActiveMQComponent`.

=== AWS

The component `camel-aws` has been split into multiple components:

- camel-aws-cw
- camel-aws-ddb (which contains both ddb and ddbstreams components)
- camel-aws-ec2
- camel-aws-iam
- camel-aws-kinesis (which contains both kinesis and kinesis-firehose components)
- camel-aws-kms
- camel-aws-lambda
- camel-aws-mq
- camel-aws-s3
- camel-aws-sdb
- camel-aws-ses
- camel-aws-sns
- camel-aws-sqs
- camel-aws-swf

So you'll have to explicitly add the dependencies for these components. From the OSGi perspective, there is still a `camel-aws` Karaf feature, which includes all the components features.

=== FHIR

The camel-fhir component has upgraded it's hapi-fhir dependency to 4.1.0; Karaf support has been dropped until the hapi-fhir Karaf features are fixed and released.
The default FHIR version has been changed to R4. Therefore, if DSTU3 is desired, it has to be explicitly set.

=== Kafka

The `camel-kafka` component has removed the options `bridgeEndpoint` and `circularTopicDetection` as this is no longer needed as the component is acting as bridging would work on Camel 2.x. In other words `camel-kafka` will send messages to the topic from the endpoint uri. To override this use the `KafkaConstants.OVERRIDE_TOPIC` header with the new topic. See more details in the `camel-kafka` component documentation.

=== Telegram

The `camel-telegram` component has moved the authorization token from uri-path to a query parameter instead, e.g. migrate

    telegram:bots/myTokenHere

to

    telegram:bots?authorizationToken=myTokenHere

=== JMX

If you run Camel standalone with just `camel-core` as a dependency, and you want JMX enabled out of the box, then you need to add `camel-management` as a dependency.

For using `ManagedCamelContext` you now need to get this an extension from `CamelContext` as follows:

    ManagedCamelContext managed = camelContext.getExtension(ManagedCamelContext.class);

=== XSLT

The XSLT component has moved out of camel-core into `camel-xslt` and `camel-xslt-saxon`. The component is separated so `camel-xslt` is for using the JDK XSTL engine (Xalan), and `camel-xslt-saxon` is when you use Saxon.
This means that you should use `xslt` and `xslt-saxon` as component name in your Camel endpoint URIs.
If you are using XSLT aggregation strategy, then use `org.apache.camel.component.xslt.saxon.XsltSaxonAggregationStrategy` for Saxon support.
And use `org.apache.camel.component.xslt.saxon.XsltSaxonBuilder` for Saxon support if using xslt builder. Also notice that `allowStax` is also only supported in `camel-xslt-saxon` as this is not supported by the JDK XSLT.

=== camel-sql

The `JdbcAggregationRepository` optimistic locking feature has been fixed to work on a distributed environment and every database.
There is a new `version` column that is required and must be added to the repository:

[source,sql]
----
CREATE TABLE aggregation (
 id varchar(255) NOT NULL,
 exchange blob NOT NULL,
 version BIGINT NOT NULL,
 constraint aggregation_pk PRIMARY KEY (id)
);
CREATE TABLE aggregation_completed (
 id varchar(255) NOT NULL,
 exchange blob NOT NULL,
 version BIGINT NOT NULL,
 constraint aggregation_completed_pk PRIMARY KEY (id)
);
----

=== Configuring global options on CamelContext

In Camel 2.x we have deprecated `getProperties` on `CamelContext` in favour of `getGlobalOptions`, so you should migrate to:

[source,java]
----
context.getGlobalOptions().put("CamelJacksonEnableTypeConverter", "true");
context.getGlobalOptions().put("CamelJacksonTypeConverterToPojo", "true");
----

and in XML:

[source,xml]
----
<globalOptions>
  <globalOption key="CamelJacksonEnableTypeConverter" value="true"/>
  <globalOption key="CamelJacksonTypeConverterToPojo" value="true"/>
</globalOptions>
----

=== Main class

The `Main` class from `camel-core`, `camel-spring` and `camel-cdi` has been modified to only support a single `CamelContext` which was really its intention, but there was some old crufty code for multiple Camels. The methods `getCamelContextMap` and `getCamelContexts` have been removed, and there is just a `getCamelContext` method now.

=== POJO annotations

The `ref` attribute on `@Consume`, `@Produce` and `@EndpointInject` has been removed. Instead use the ref component in the `uri` attribute, eg `uri = "ref:myName"`.

The uri attribute has been deprecated, instead use value, which allows a shorthand style, from using `@Consume(uri = "jms:cheese")` to `@Consume("jms:cheese")`.

=== Routes with multiple inputs

In Camel 2.x you could have 2 or more inputs to Camel routes, however this was not supported in all use-cases in Camel, and this functionality is seldom in use. This has
also been deprecated in Camel 2.x. In Camel 3 we have removed the remaining code for specifying multiple inputs to routes, and its now only possible to specify exactly only 1 input to a route.

=== Crypto Component

The default signature algorithm has changed for the Crypto (JCE) Component - it
is now SHA256withRSA (before it was SHA1WithDSA).

=== Crypto DataFormat

The default encryption algorithm has changed for the Crypto (JCE) DataFormat -
it is now required to set a value for it (meaning that the default is null).
Before the default value was "DES/CBC/PKCS5Padding".

=== JSon DataFormat

The default JSON library with the JSON dataformat has changed from `XStream` to `Jackson`.

=== Shiro Component

The default encryption key for the Shiro component has been removed, so now it
is mandatory to supply the key/passphrase.

=== XML Security Component

The default signature algorithm has changed for the XML Security Component - it
is now RSA-SHA256 (before it was RSA-SHA1).

=== XML Security DataFormat

The default encryption key for the XML Security DataFormat has been removed,
so it is now mandatory to supply the key String/bytes if you are using
symmetric encryption. This means that some methods are removed that
used the `XMLSecurityDataFormat` without specifying a key.

In addition, the default symmetric encryption algorithm has changed from
Triple DES to AES-256 in GCM mode.

=== Zip and GZip DataFormat

The zip and gzip dataformat has been renamed to zipdeflater and gzipdeflater as they are for deflating using the zip/gzip compression; and not for working with zip/gzip files. Instead use camel-zipfile dataformat. Also these dataformats has been moved out of `camel-core` into `camel-zip-deflater` JAR. The XML and Java DSL has also been modified so you should migrate there too to use their new names. And if you use these data formats you need to add the `camel-zip-deflater` as dependency as they are no longer included as transitive dependency with `camel-core`.

=== Simple language

The functionality to change the simple language tokens for start/end functions has been removed. The default tokens with `+++${xxx}+++` and `+++$simple{xxx}+++` is now hardcoded (optimized). The functionality to change these tokens was never really in use and would only confuse Camel users if a new syntax are in use.

=== Moved APIs

The following API changes may affect your existing Camel applications, which needs to be migrated.

==== CamelContext

The methods on `CamelContext` that are related to catalog has been moved into a new `CatalogCamelContext` interface, which you can access by adapting:

  CatalogCamelContext ccc = context.adapt(CatalogCamelContext.class);

The `loadRouteDefinitions` and `loadRestDefinitions` on `ModelCamelContext` has been changed to `addRouteDefinitions` and `addRestDefinitions` to be aligned with the other methods. You can find `getModelToXMLDumper` and `getXMLRoutesDefinitionLoader` loader methods on the `ExtendedCamelContext` class.

==== ModelCamelContext

If you need to access the routes model (such as `addRouteDefinitions`, etc.), then you need to adapt form CamelContext as shown:

    ModelCamelContext mcc = camelContext.adapt(ModelCamelContext.class);

==== Extended CamelContext

The APIs on `CamelContext` has been reduced a bit to focus on relevant API for Camel end users. The advanced use-cases and for SPI and component developers, then some of the APIs from `CamelContext` has been moved to `ExtendedCamelContext` which you can access via adapt:

  ExtendedCamelContext ecc = context.adapt(ExtendedCamelContext.class);


=== Checked vs unchecked exceptions

Most of the Camel exception classes have been migrated to be unchecked (e.g., extends `RuntimeException`).

Also, the lifecycle of the `start`, `stop` and `suspend`, `resume` methods on `Service` and `SuspendableService` has been changed to not throw checked exceptions.

==== Generic Information

The class `SimpleRegistry` is moved from `org.apache.camel.impl` to `org.apache.camel.support`. Also you should favour using the `org.apache.camel.support.DefaultRegistry` instead. Also you should use the `bind` operation instead of `put` to add entries to the `SimpleRegistry` or `DefaultRegistry`.

The class `CompositeRegistry` and `PropertyPlaceholderDelegateRegistry` has been deleted. Instead use `DefaultRegistry`.

The classes from `org.apache.camel.impl` that was intended to support Camel developers building custom components has been moved out of `camel-core` into `camel-support` into the `org.apache.camel.support` package. If you have built custom Camel components that may have used some of these APIs you would then need to migrate.  A large part of classes from the `org.apache.camel.impl` package have been moved to the `org.apache.camel.impl.engine` package in `camel-base`.

All the classes in `org.apache.camel.util.component` has been moved from the camel-core JAR to the package `org.apache.camel.support.component` in the `camel-support` JAR.

The method `xslt` has been removed from `org.apache.camel.builder.AggregationStrategies`. Instead use the `XsltAggregationStrategy` from `camel-xslt` JAR directly.

The getter/setter for `bindingMode` on `RestEndpoint` has been changed to use type `org.apache.camel.spi.RestConfiguration.RestBindingMode` from `camel-api` JAR. Instead of using this type class you can also call the setter method with string type instead.

The `activemq-camel` component has been moved from ActiveMQ into Camel and it is now called `camel-activemq`, the package has been changed accordingly to `org.apache.camel.component.activemq`

The method `includeRoutes` on `RouteBuilder` has been removed. This functionality was not fully in use and was deprecated in Camel 2.x.

The exception `PredicateValidationException` has been moved from package `org.apache.camel.processor.validation` to `org.apache.camel.support.processor.PredicateValidationException`.

The class `org.apache.camel.util.toolbox.AggregationStrategies` has been moved to `org.apache.camel.builder.AggregationStrategies`.

The class `org.apache.camel.util.toolbox.AggregationStrategies` has been moved to `org.apache.camel.builder.AggregationStrategies`.

The class `org.apache.camel.processor.RedeliveryPolicy` has been moved to `org.apache.camel.processor.errorhandler.RedeliveryPolicy`.

The class `org.apache.camel.processor.loadbalancer.SimpleLoadBalancerSupport` has been removed, instead use `org.apache.camel.processor.loadbalancer.LoadBalancerSupport`.

The class `org.apache.camel.management.JmxSystemPropertyKeys` has been moved to `org.apache.camel.api.management.JmxSystemPropertyKeys`.

The class `org.apache.camel.builder.xml.XPathBuilder` has been moved to `org.apache.camel.language.xpath.XPathBuilder` and in the `camel-xpath` JAR.

The annotation `org.apache.camel.language.XPath` has been moved to `org.apache.camel.language.xpath.XPath` and in the `camel-xpath` JAR.

The exception `org.apache.camel.builder.xml.InvalidXPathExpression` has been renamed to `org.apache.camel.language.xpath.InvalidXPathException` and in the `camel-xpath` JAR.

The annotation `org.apache.camel.language.Bean` has been moved to `org.apache.camel.language.bean.Bean` and in the `camel-bean` JAR.

The annotation `org.apache.camel.language.Simple` has been moved to `org.apache.camel.language.simple.Simple`.

The annotation `org.apache.camel.Constant` has been removed, use `@Simple` instead.

The annotation `org.apache.camel.language.SpEL` has been moved to `org.apache.camel.language.spel.SpEL` and in the `camel-spring` JAR.

The annotation `org.apache.camel.InvokeOnHeader` and `org.apache.camel.InvokeOnHeaders` has been moved to the `org.apache.camel.spi` package.

The class `OutputStreamBuilder` has been moved from package `org.apache.camel.converter.stream` to `org.apache.camel.support.builder` package.

Rename various APIs in camel-core to fix the typo `chiper` to `cipher`.

The classes `ReloadStrategySupport` and `FileWatcherReloadStrategy` has been removed.

The `MessageHistoryFactory` interface has some options to filter and copy the message and a slight change in its API.

Removed `TypeConverterAware` as you should instead use `Exchange` as parameter to the type converter method.

The `Component` and `DataFormat` interfaces now extend `Service` as components and data formats should also have service contract to manage their lifecycle. The default base classes already implements these interfaces.

The class `FactoryFinder` has changed its API to use `Optional` as return types instead of throwing checked `FactoryNotFoundException` or `ClassNotFoundException` etc.

The option `resolvePropertyPlaceholders` on all the components has been removed,
as property placeholders are already supported via Camel Main, Camel Spring Boot and other means.

=== camel-test

If you are using camel-test and override the `createRegistry` method, for example to register beans from the `JndiRegistry` class, then this is no longer necessary, and instead
you should use the `bind` method from the `Registry` API which you can call directly from `CamelContext`, such as:

  context.getRegistry().bind("myId", myBean);

=== Controlling routes

The `startRoute`, `stopRoute`, `suspendRoute`, `resumeRoute`, `getRouteStatus`, and other related methods on `CamelContext` has been moved to the `RouteController` as shown below:

  context.getRouteController().startRoute("myRoute");

=== JMX events

All the events from package `org.apache.camel.management.event` has been moved to the class `org.apache.camel.spi.CamelEvent` as sub-classes, for example the event for CamelContext started would be `CamelEvent.CamelContextStartedEvent`.

=== AdviceWith

Testing using `adviceWith` currently needs to be changed from:

[source,java]
----
context.getRouteDefinition("start").adviceWith(camelContext, new AdviceWithRouteBuilder() {
  ...
}
----

to using style:

[source,java]
----
ModelCamelContext mcc = camelContext.adapt(ModelCamelContext.class);
RouteReifier.adviceWith(mcc.getRouteDefinition("start"), mcc, new AdviceWithRouteBuilder() {
  ...
}
----

However its even easier using lambda style with `AdviceWithRouteBuilder` directly:

[source,java]
----
AdviceWith.adviceWith(context, "myRoute", a -> {
  a.replaceFromWith("direct:start");
}
----

=== Generic Classes

The class `JNDIContext` has been moved from `org.apache.camel.util.jndi.JNDIContext` in the camel-core JAR to `org.apache.camel.support.jndi.JNDIContext` and moved to the `camel-support` JAR.

=== EIPs

The `circuitBreaker` load-balancer EIP was deprecated in Camel 2.x, and has been removed. Instead use Hystrix EIP as the load-balancer.

The class `ThreadPoolRejectedPolicy` has been moved from `org.apache.camel.ThreadPoolRejectedPolicy` to `org.apache.camel.util.concurrent.ThreadPoolRejectedPolicy`.

=== Languages

The simple language `property` function was deprecated in Camel 2.x and has been removed. Use `exchangeProperty` as function name.

The terser language has been renamed from `terser` to `hl7terser`.

=== JSSE

The classes from `org.apache.camel.util.jsse` has been moved to `org.apache.camel.support.jsse`.

=== Helpers and support

The class `AsyncProcessorHelper` has been moved from `org.apache.camel.util.AsyncProcessorHelper` in the camel-core JAR to `org.apache.camel.support.AsyncProcessorHelper` and moved to the `camel-support` JAR.

The class `AsyncProcessorConverterHelper` has been moved from `org.apache.camel.util.AsyncProcessorConverterHelper` in the camel-core JAR to `org.apache.camel.support.AsyncProcessorConverterHelper` and moved to the `camel-support` JAR.

The class `CamelContextHelper` has been moved from `org.apache.camel.util.CamelContextHelper` in the camel-core JAR to `org.apache.camel.support.CamelContextHelper` and moved to the `camel-support` JAR.

The class `EndpointHelper` has been moved from `org.apache.camel.util.EndpointHelper` in the camel-core JAR to `org.apache.camel.support.EndpointHelper` and moved to the `camel-support` JAR.

The class `EventHelper` has been moved from `org.apache.camel.util.EventHelper` in the camel-core JAR to `org.apache.camel.support.EventHelper` and moved to the `camel-support` JAR.

The class `ExchangeHelper` has been moved from `org.apache.camel.util.ExchangeHelper` in the camel-core JAR to `org.apache.camel.support.ExchangeHelper` and moved to the `camel-support` JAR.

The class `GZIPHelper` has been moved from `org.apache.camel.util.GZIPHelper` in the camel-core JAR to `org.apache.camel.support.GZIPHelper` and moved to the `camel-support` JAR.

The class `JsonSchemaHelper` has been moved from `org.apache.camel.util.JsonSchemaHelper` in the camel-core JAR to `org.apache.camel.support.JsonSchemaHelper` and moved to the `camel-support` JAR.

The class `MessageHelper` has been moved from `org.apache.camel.util.MessageHelper` in the camel-core JAR to `org.apache.camel.support.MessageHelper` and moved to the `camel-support` JAR.

The class `ObjectHelper` has been moved from `org.apache.camel.util.ObjectHelper` in the camel-core JAR and split into `org.apache.camel.support.ObjectHelper` and moved to the `camel-support` JAR and into `org.apache.camel.util.ObjectHelper` and moved to the `camel-util` JAR. This has been done to isolate the methods using `camel-api` JAR: those method are in the `camel-support` JAR, the other in the `camel-util` JAR.

The class `PlatformHelper` has been moved from `org.apache.camel.util.PlatformHelper` in the camel-core JAR to `org.apache.camel.support.PlatformHelper` and moved to the `camel-support` JAR.

The class `PredicateAssertHelper` has been moved from `org.apache.camel.util.PredicateAssertHelper` in the camel-core JAR to `org.apache.camel.support.PredicateAssertHelper` and moved to the `camel-support` JAR.

The class `ResolverHelper` has been moved from `org.apache.camel.util.ResolverHelper` in the camel-core JAR to `org.apache.camel.support.ResolverHelper` and moved to the `camel-support` JAR.

The class `ResourceHelper` has been moved from `org.apache.camel.util.ResourceHelper` in the camel-core JAR to `org.apache.camel.support.ResourceHelper` and moved to the `camel-support` JAR.

The class `RestProducerFactoryHelper` has been moved from `org.apache.camel.spi.RestProducerFactoryHelper` in the camel-core JAR to `org.apache.camel.support.RestProducerFactoryHelper` and moved to the `camel-support` JAR.

The class `ServiceHelper` has been moved from `org.apache.camel.util.ServiceHelper` in the camel-core JAR to `org.apache.camel.support.service.ServiceHelper` and moved to the `camel-api` JAR.

The class `UnitOfWorkHelper` has been moved from `org.apache.camel.util.UnitOfWorkHelper` in the camel-core JAR to `org.apache.camel.support.UnitOfWorkHelper` and moved to the `camel-support` JAR.

=== Idempotent Repositories

The class `FileIdempotentRepository` has been moved from `org.apache.camel.processor.idempotent.FileIdempotentRepository` in the camel-core JAR to `org.apache.camel.support.processor.idempotent.FileIdempotentRepository` and moved to the `camel-support` JAR.

The class `MemoryIdempotentRepository` has been moved from `org.apache.camel.processor.idempotent.MemoryIdempotentRepository` in the camel-core JAR to `org.apache.camel.support.processor.idempotent.MemoryIdempotentRepository` and moved to the `camel-support` JAR.

=== Route Policies

The class `org.apache.camel.support.RoutePolicySupport` has been moved to the `camel-support` JAR. The return type from `startConsumer` and `stopConsumer` has been changed from `boolean` to `void` as they always returned `true` before.

The class `org.apache.camel.impl.ThrottlingInflightRoutePolicy` has been moved to `org.apache.camel.throttling.ThrottlingInflightRoutePolicy`

=== Aggregation

The class `XsltAggregationStrategy` has been moved from `org.apache.camel.util.toolbox.XsltAggregationStrategy` in the camel-core JAR to `org.apache.camel.component.xslt.XsltAggregationStrategy` and moved to the `camel-xslt` JAR.

When using the option `groupedExchange` on the aggregator EIP then the output of the aggregation is now longer also stored in the exchange property `Exchange.GROUPED_EXCHANGE`. This behaviour was already deprecated from Camel 2.13 onwards.

=== Fallback type converters

The `@FallbackConverter` annotation has been removed, and you should use `@Converter(fallback = true)` instead. Also you can set `@Converter(generateLoader = true)` on the converter class to allow Camel to generate source code for loading type converters in a faster way.

=== Removed JMX APIs for explaining EIPs, components, etc.

The APIs that could find, and explain EIPs, components, endpoints, etc. have been removed. These APIs have little value for production runtimes, and you can obtain this kind of information via the `camel-catalog`. Also the related Camel Karaf commands that used these APIs has been removed.

=== Other changes

The default for use breadcrumbs has been changed from `true` to `false`.

The `ProducerTemplate` and `ConsumerTemplate` now fails when being used, if `CamelContext` has not been started first.

=== XML DSL Migration

The XML DSL has been changed slightly.

The custom load balancer EIP has changed from `<custom>` to `<customLoadBalancer>`

The XMLSecurity data format has renamed the attribute `keyOrTrustStoreParametersId` to `keyOrTrustStoreParametersRef` in the `<secureXML>` tag.

The `<zipFile>` data format has been renamed to `<zipfile>`.

== Migrating Camel Maven Plugins

The `camel-maven-plugin` has been split up into two maven plugins:

- camel-maven-plugin
- camel-report-maven-plugin

The former has the `run` goal, which is intended for quickly running Camel applications standalone.

The `camel-report-maven-plugin` has the `validate` and `route-coverage` goals which is used for generating reports of your Camel projects such as validating Camel endpoint URIs and route coverage reports, etc.

== Known Issues

There is an issue with MDC logging and correctly transferring the Camel breadcrumb id's under certain situations with routing over asynchronous endpoints, due to the internal routing engine refactorings. This change also affects the `camel-zipkin` component, which may not correctly transfer the span id's when using MDC logging as well.
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.0 to 3.1

=== camel-ahc, camel-netty-http, camel-undertow

These Camel components now no longer have dependency on Javax Servlet.

=== camel-undertow

The exception class `HttpOperationFailedException` is now from package `org.apache.camel.http.base` instead of `org.apache.camel.http.common`.
The Camel undertow producer throws this exception.

=== camel-bean

The bean component has been changed to behave as singleton scoped by default.
This means that the bean is created or looked up once and reused.

The option `cache` has been deprecated in favour of the new `scope` option that by default is `Singleton`. You can set this to `Prototype` to use the old behaviour.

[NOTE]
====
Setting this to Prototype will let Camel create/lookup a new bean instance, per use; which acts as prototype scoped. However beware that if you lookup the bean, then the registry that holds the bean, would return a bean accordingly to its configuration, which can be singleton or prototype scoped. For example if you use Spring, or CDI, which has their own settings for setting bean scopes.
====

=== camel-etcd

The `camel-etcd` component has changed its endpoint syntax from `etcd:action/path` to
`etcd-keys:path`, `etcd-stats:path`, or `etcd-watch:path`.

For example before

[source,text]
----
etcd:stats/leader
----

Should be changed to
----
etcd-stats:leader
----

This change was needed as the 3 actions could not share the same component/endpoint and had to be separated.

=== camel-ftp

 The stepwise functionality (stepwise=true) is not supported for stream download (treamDownload=true).

=== camel-irc

The `camel-irc` component has changed its endpoint syntax and removed option #room as a part of the url path. Allowed syntax is:

[source,text]
----
irc:nick@host[:port]?[options]
----

=== camel-milo

The `camel-milo` client component has changed its endpoint syntax from `milo-client:tcp` to `milo-client:opc.tcp`.
For example before

[source,text]
----
milo-client:tcp://foo:bar@localhost:1234
----

Should be changed to
----
milo-client:opc.tcp://foo:bar@localhost:1234
----

The `camel-milo` server component requires Java 9 at runtime.
Property `strictEndpointUrlsEnabled` is no longer supported.
Properties`hostName` and `serverName` are replaced by `path`.
To successfully use certificates for secured communication, JCE Jurisdiction Policy File Default
has to be *Unlimited* (which is by default since Java 9+).

=== camel-nats

The `camel-nats` component has changed its endpoint syntax from `nats:servers` to `nats:topic`.
For example before

[source,text]
----
nats:myserver:4222?topic=myTopic
----

Should be changed to
----
nats:myTopic?servers=myserver:4222
----

This change is motivated by allowing to configure servers on component level,
and also for Spring Boot auto-configuration etc.

=== camel-nsq

The `camel-nsq` component has changed its endpoint syntax from `nsq:servers` to `nsq:topic`.
For example before

[source,text]
----
nsq:myserver:4161/myTopic
----

Should be changed to
----
nsq:myTopic?servers=myserver:4161
----

This change is motivated by allowing to configure servers on component level,
and also for Spring Boot auto-configuration etc.

=== camel-ipfs

The `camel-ipfs` component has changed its endpoint syntax from `nsq:host:port/command` to `ipfs:command`.
The host and port is now configured on the component level instead.

For example before

[source,text]
----
ipfs:127.0.0.1:5001/add
----

Should be changed to
----
ipfs:add
----

=== camel-xmlsecurity

The `camel-xmlsecurity` component has changed its endpoint syntax from `xmlsecurity:command/name` to
`xmlsecurity-sign:name`, `xmlsecurity-verify:name`.

For example before

[source,text]
----
xmlsecurity:verify/foo
----

Should be changed to
----
xmlsecurity-verify:foo
----

This change was needed as the 2 commands could not share the same component/endpoint and had to be separated.

=== spi-annotations

The `spi-annotations` JAR is mandatory but was mistakenly defined as optional scope. The content of this JAR
is now embedded directly into `camel-api` JAR so end users does not have to include or depend on `spi-annotations` JAR anymore.

=== camel-core-engine and camel-jaxp

XML and JAXB has been moved out of camel-base and camel-core-engine.

The module camel-jaxp has been renamed to camel-xml-jaxp.

The camel-xml-jaxp JAR has XML parsers and type converters.
The camel-xml-jaxb has support for loading XML DSL routes using JAXB.
An alternative is to use the new camel-xml-io for loading XML routes which is more light-weight and faster than JAXB.

=== JAXB is now optional

JAXB is now optional in Camel and only needed when using XML routes with the `camel-xml-jaxb` JAR
for loading and parsing the routes with JAXB. There is an alternative implementation with `camel-xml-io` (see above).

This means that `jaxb-core` and `jaxb-impl` JARs no longer are needed on the classpath and as such has been removed
as dependency in the various Camel `pom.xml` files.

There are a number of components that uses JAXB such as `camel-spring`, `camel-blueprint`, `camel-cdi` for their support
of using XML for beans and Camel XML routes. And a few components such as `camel-soap` etc.

But at general then Camel is now lighter in classpath dependency by not requiring to have JAXB present.

=== Package scanning @TypeConverter

Camel has now been configured to not package scan for custom `@Converter` classes on startup.
Type converters are now loaded and registered in faster way via source code generated loader classes
by having `@Converter(loader = true)` specified. If you have custom converters and have not migrated to use
source code generated loaders, you can enable package scanning by setting

[source,java]
----
camelContext.setLoadTypeConverters(true);
----

And in XML:
[source,xml]
----
<camelContext loadTypeConverters="true">
...
</camelContext>
----

And in Spring Boot `application.properties`:
[source,properties]
----
camel.loadTypeConverters=true
----

=== Graceful Shutdown Timeout

When shutting down Camel, then the default timeout has changed from 300 seconds (5 minutes) to 45 seconds.
The 45 seconds was chosen as 30 seconds is a common timeout to use for remote protocols, so we wanted to give
Camel a bit more time, and hence added 15 seconds so the default is 45 seconds.

=== Message History

The message history is now default disabled (due to optimize core for lower footprint out of the box).
See the xref:components:eips:message-history.adoc[Message History] documentation for how to enabled message history.

=== Inflight Repository

The inflight repository now does no longer allow browsing each individual exchange (due to optimize core for lower footprint out of the box).
To enable browsing then you can turn this on via:

[source,java]
----
    context.getInflightRepository().setInflightBrowseEnabled(true);
----

And in XML DSL:

[source,xml]
----
<camelContext inflightRepositoryBrowseEnabled="true">

</camelContext>
----

=== Component Extension Verifier

When using component verifier (`org.apache.camel.component.extension.ComponentVerifierExtension`) then you
would know need to add `camel-core-catalog` to the classpath to make this useable. If the JAR is missing,
there will be an exception stating that `RuntimeCamelCatalog` is not found and that this JAR should be added.

=== ManagedRuntimeCatalog

The `ManagedRuntimeCatalog` JMX MBean is removed and no longer available.

=== Spring Boot JMX

The `camel-management` dependency of `camel-spring-boot` was removed as Spring Boot 2.2+ disables JMX by default.

To continue using JMX with Camel Spring Boot add the following dependency:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel</groupId>
  <artifactId>camel-management</artifactId>
</dependency>
----

=== Custom components

Camel now uses Camel Package Maven Plugin instead of `camel-apt` APT compiler to generate component meta data.

Custom components should then change in the pom.xml from:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel</groupId>
  <artifactId>apt</artifactId>
  <scope>provided</scope>
</dependency>
----

To the following:

[source,xml]
----
      <plugin>
        <groupId>org.apache.camel</groupId>
        <artifactId>camel-package-maven-plugin</artifactId>
        <version>${camel-version}</version>
        <executions>
          <execution>
            <id>generate</id>
            <goals>
              <goal>generate-component</goal>
            </goals>
            <phase>process-classes</phase>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>build-helper-maven-plugin</artifactId>
        <executions>
          <execution>
            <phase>initialize</phase>
            <goals>
              <goal>add-source</goal>
              <goal>add-resource</goal>
            </goals>
            <configuration>
              <sources>
                <source>src/generated/java</source>
              </sources>
              <resources>
                <resource>
                  <directory>src/generated/resources</directory>
                </resource>
              </resources>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <!--
      Recompile source after generated loader classes have been created.
      The maven-compiler-plugin must be defined in the POM after the
      camel-package-maven-plugin so recompile runs after generated
      sources have been created.

      Adjust configuration for the JDK version your project uses.
      -->
      <plugin>
          <groupId>org.apache.maven.plugins</groupId>
          <artifactId>maven-compiler-plugin</artifactId>
          <version>3.8.1</version>
          <configuration>
              <source>1.11</source>
              <target>1.11</target>
          </configuration>
          <executions>
              <execution>
                  <id>recompile</id>
                  <goals>
                      <goal>compile</goal>
                  </goals>
                  <phase>process-classes</phase>
              </execution>
          </executions>
      </plugin>
----

=== API changes

==== log changed to private static LOG

The `ServiceSupport` class has changed its logging from instance to static, which means any inherited class that
uses `log` would need to change the code to compile. This may happen in custom Camel components.

Before you may have:

[source,java]
----
    log.debug("Sending message to foobar service: {}", messageId);
----

You then need to migrate the logging to also be static:

[source,java]
----
    private static final Logger LOG = LoggerFactory.getLogger(FooBarProducer.class);

    LOG.debug("Sending message to foobar service: {}", messageId);
----

==== Exchange

The `Exchange` API has been modified slightly as part of an optimization effort.
The return value of `getCreated` was changed from `java.util.Date` to `long` which is the time millis.
The `Exchange.CREATED_TIMESTAMP` is no longer stored as exchange property, but you should use the `getCreated` method on `Exchange`.
The return value of `isExternalRedelivered` was changed from `Boolean` to `boolean`.

Some of the advanced and API for component developers on `Exchange` has been moved to an extended interface `ExtendedExchange`.
The following methods have been moved:

- setFromEndpoint
- setFromRouteId
- setUnitOfWork
- addOnCompletion
- containsOnCompletion
- handoverCompletions

You can use these methods by adapting to the extended exchange as shown below:

[source,java]
----
exchange.adapt(ExtendedExchange.class).addOnCompletion(...);
----

==== Message

The message ID will now default to use the same id as Exchange ID as messages are associated with the exchange
and using different IDs does not offer much value. Another reason is to optimize for performance to avoid generating new IDs.
A few Camel components do provide their own message IDs such as the JMS components.

==== UnitOfWork

Advanced Camel users whom implement a custom `UnitOfWork` should implement the new `isBeforeAfterProcess()' method and return true or false,
whether Camel should invoke the before and after processor methods.

The method `getId` has been removed.

==== Cookies

Cookies from `camel-http-common` has been moved into a new `camel-http-base` JAR.
The package `org.apache.camel.http.common.cookie` is renamed to `org.apache.camel.http.base.cookie`.

==== Exchange.ROUTE_STOP

To signal an `Exchange` to stop continue routing has changed from setting the exchange property `Exchange.ROUTE_STOP` to true.
Instead you should now use the `setRouteStop` method on the `Exchange` API.

[source,java]
----
    exchange.setProperty(Exchange.ROUTE_STOP, Boolean.TRUE);
----

Should now be:
[source,java]
----
    exchange.setRouteStop(true);
----

==== Exchange.ROLLBACK_ONLY and Exchange.ROLLBACK_ONLY_LAST

To signal an `Exchange` to rollback a transaction has changed from setting the exchange property `Exchange.ROLLBACK_ONLY` to true.
Instead you should now use the `setRollbackOnly` method on the `Exchange` API (the same for rollback only last).

[source,java]
----
    exchange.setProperty(Exchange.ROLLBACK_ONLY, Boolean.TRUE);
----

Should now be:

[source,java]
----
    exchange.setRollbackOnly(true);
----

==== Exchange.ERRORHANDLER_HANDLED

The exchange property `Exchange.ERRORHANDLER_HANDLED` was used to indicate that the error handling mechanism for a given exchange
had completed.  This property sometimes had to be conveyed by aggregation strategies, so instead of

[source,java]
----
    oldExchange.getProperties().put(
            Exchange.ERRORHANDLER_HANDLED,
            newExchange.getProperties().get(Exchange.ERRORHANDLER_HANDLED));
----

one should now use:

[source,java]
----
    Boolean handled = newExchange.adapt(ExtendedExchange.class)
            .getErrorHandlerHandled();
    oldExchange.adapt(ExtendedExchange.class)
            .setErrorHandlerHandled(handled);
----

==== ModelHelper removed

The class `org.apache.camel.model.ModelHelper` has been removed. Instead you can use its functionality from `ExtendedCamelContext` by
the `getModelToXMLDumper` and `getXMLRoutesDefinitionLoader` methods which has APIs similar to `ModelHelper`.

==== JsonSchemaHelper removed

The class `org.apache.camel.tooling.util.JSonSchemaHelper` has been removed. Instead you can use utils coming from camel-util-json
and the class `org.apache.camel.tooling.util.PackageHelper`

==== camel-xml-jaxp

The class `org.apache.camel.processor.validation.PredicateValidatingProcessor` has moved from `camel-xml-jaxp` JAR
to `camel-support` JAR and renamed to `org.apache.camel.support.processor.PredicateValidatingProcessor`.

==== Java DSL

The Java DSL has been revisited and the following methods have been removed:

* ExpressionClause::body(Supplier<Object>)
* MulticastDefinition::onPrepare(Supplier<Processor>)
* ProcessorDefinition::process(Supplier<Processor>)
* ProcessorDefinition::setBody(Supplier<Result>)
* RecipientListDefinition::onPrepare(Supplier<Processor>)
* SplitDefinition::onPrepare(Supplier<Processor>)
* WireTapDefinition::newExchange(Supplier<Processor>)
* WireTapDefinition::onPrepare(Supplier<Processor>)

This change is motivated by the need to remove method ambiguity for untyped languages such as Groovy and JavaScript, for more info see https://issues.apache.org/jira/browse/CAMEL-14300

==== CamelContext

Some unused methods have been removed from `CamelContext` which were not part of the public API. The following methods have been removed:

* getProducerServicePool
* setProducerServicePool
* getPollingConsumerServicePool
* setPollingConsumerServicePool

==== Internal API changes

Removed the method `getProcessors` from `Pipeline` as you should use the `next` method instead to access a read-only view of the processors.

==== @Experimental

The `@Experimental` annotation is moved from `meta-annotations` JAR to `camel-api`
and moved from package `org.apache.camel.meta` to `org.apache.camel`.
And the meta-annotations has been removed.

==== Property Placeholders

The support for out-of-band property placeholders has been removed.
This means that XML that were using the `http://camel.apache.org/schema/placeholder`
namespace and that the java builders using the `.placeholder(key, value).` have to
be modified.

[source,java]
----
    from("direct:start")
        .multicast()
        .placeholder("stopOnException", "stop")
        .to("mock:a")
----
should be rewritten as:
[source,java]
----
    from("direct:start")
        .multicast()
        .stopOnException("{{stop}}")
        .to("mock:a")
----

and
[source,xml]
----
   <route>
        <from uri="direct:start"/>
        <multicast prop:stopOnException="stop">
            <to uri="mock:a"/>
        </multicast>
    </route>
----
should be rewritten as:
[source,xml]
----
   <route>
        <from uri="direct:start"/>
        <multicast stopOnException="{{stop}}">
            <to uri="mock:a"/>
        </multicast>
    </route>
----

= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.9 to 3.10

=== API changes

The method `concurrentTasks` on `org.apache.camel.support.DefaultScheduledPollConsumerScheduler ` has been renamed to `concurrentConsumers`.

The `org.apache.camel.cloud.ServiceFilter` and `org.apache.camel.cloud.ServiceLoadBalancer` 
functional interface methods take the current `Exchange` as additional parameter 
to allow for content-based filtering of service candidates. `RibbonServiceLoadBalancer` 
has no notion of a current exchange, service filters therefore receive a dummy exchange when used with Ribbon.

The two methods `filterTypeInOutputs` on `org.apache.camel.model.ProcessorDefinitionHelper` has changed
to return `Collection` instead of `Iterator`.

The annotation `@Consume` has removed its target for field/constructor injection as the `@Consume` is only to be used on methods.
The annotations `@Produce` and `@EndpointInject` has removed its target for constructor injection as that is not supported (Camel only does bean post processing)

=== camel-scheduler

The option `concurrentTasks` has been renamed to `poolSize` to better reflect its purpose.
The scheduler has also been fixed to only schedule triggering by one, and not as mistakenly by causing
concurrent triggering which causes routing mistakes.

The option configures the pool size of the scheduled thread pool used by the scheduler.

If the scheduler thread is being blocked by anywhere in the downstream routing, and you want the scheduler
to schedule with a fixed interval, you can use the Threads EIP as queue for pending tasks.

=== camel-jdbc

The `camel-jdbc` component no longer depends on Spring Framework, instead a new `camel-spring-jdbc` component
has been created. You should use `camel-spring-jdbc` if you use Spring and need Spring Transaction support.
The `camel-jdbc` is using plain Java JDBC API only.

=== camel-jsonpath

This component now uses Jackson as the default json parser instead of json-smart.

Usage of `JacksonJsonAdapter` has been slightly changed.

Component was trying to use `JacksonJsonAdapter` ahead of automatic conversion of the payload to the `InputStream`
in the previous version. New version tries to convert the payload into `InpuStream` first. `JacksonJsonAdapter` is used
only if conversion to `InputStream` is not possible.

Order of the basic payload types (like `String`, `Map`, `File`) has not been changed.

=== camel-huaweicloud-smn

Initialization options for SMN client has slightly changed. 

Earlier, the library configured the smn server url based on the region parameter provided in endpoint configurations. Now, it provides more flexibility by allowing camel users by providing fully qualified http url for more customizability.

When endpoint URL is provided, it carries the higher precedence than region based configuration. Any region configuration entered along with endpoint url will be ignored.

=== Camel-Azure-Storage-Blob

The service client is now autowired. No need to set explicitly on your route if it is already in the registry. This is the reason why the autoDiscoverClient option has been removed.

=== Camel-Azure-Storage-Queue

The service client is now autowired. No need to set explicitly on your route if it is already in the registry.

=== Spring Boot Starters

Some of the Camel Spring Boot starters have additional auto configuration options that clashed with component.
Therefore those configurations has renamed their configuration keys:

|====
| *Old Key prefix* | *New key prefix*
| camel.component.atomix.cluster.service | camel.cluster.atomix
| camel.component.consul.cluster.service | camel.cluster.consul
| camel.component.consul.service-registry | camel.cloud.consul.service-registry
| camel.component.file.cluster.service | camel.cluster.file
| camel.component.hystrix.mapping | camel.hystrix.mapping
| camel.component.jgroups.lock.cluster.service | camel.cluster.jgroups
| camel.component.jgroups.raft.cluster.service | camel.cluster.jgroups-raft
| camel.component.kubernetes.cluster.service | camel.cluster.kubernetes
| camel.component.servlet.mapping | camel.servlet.mapping
| camel.component.undertow.spring.security | camel.security.undertow
| camel.component.zookeeper.cluster.service | camel.cluster.zookeeper
| camel.component.zookeeper.service-registry | camel.cloud.zookeeper
|====
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example, if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.10 to 3.11

=== Bean Language

When using `beanType` (full qualified class name) with the bean language,
then the bean language will *now* look up in the registry, and if there is a single instance of the same type, then the existing bean is used.
If not, then a new bean is created (same behavior as before).

=== Aggregate EIP

The aggregate EIP will now always use a worker thread pool for processing outgoing messages.
Previously a worker pool was only created when `parallelProcessing=true`. When having `parallelProcessing=false`
then a single-threaded worker pool is created and used by the aggregator.

Camels routing engine works better when a dedicated worker pool that eliminates a _hack_ that otherwise was necessary in other EIPs that
was affected if using the aggregator in some special configurations.

=== RemoveHeader EIP

In XML and YAML DSL the `headerName` attribute has been deprecated, and you should use `name` instead.
This is to make the EIP consistent with the naming used by other similar EIPs.

=== Routes loader

The default pattern for discovering Camel routes et all from the classpath has changed from only including XML files to now include all files.

The option `routesIncludePattern` is changed  from:
----
classpath:camel/*.xml,classpath:camel-template/*.xml,classpath:camel-rest/*.xml`
----

to:

----
classpath:camel/*,classpath:camel-template/*,classpath:camel-rest/*
----

This is from the `camel-main` module which is for running Camel standalone, but also reused for Camel on Spring Boot, or Camel on Quarkus.

=== camel-apns

The `camel-apns` component has been removed as the APNS (Apple Push Notification Service) online service has been retired y Apple.

=== camel-mongodb

The `streamFilter` option should now be configured as endpoint uri parameter, instead of a route property.

=== camel-saxon

The camel-saxon component no longer depends on camel-xslt-saxon.
Any applications in need of XSLT transformation with saxon should now declare an explicit dependency upon camel-xslt-saxon.

=== camel-maven-plugin with OSGi blueprint

The `run` goal of the `camel-maven-plugin` has moved its OSGi Blueprint support out to its own `camel-karaf-maven-plugin`.

This means if you use Camel on OSGi Blueprint then you need to migrate from:
[source,xml]
----
<plugin>
    <groupId>org.apache.camel</groupId>
    <artifactId>camel-maven-plugin</artifactId>
    <version>3.11.0</version>
</plugin>
----

to

[source,xml]
----
<plugin>
    <groupId>org.apache.camel.karaf</groupId>
    <artifactId>camel-karaf-maven-plugin</artifactId>
    <version>3.11.0</version>
</plugin>
----

In the `pom.xml` file.

Also remember to execute the `run` goal, you should use `camel-karaf:run` instead of `camel:run` as shown:

[source,bash]
----
mvn camel-karaf:run
----

=== camel-sql

Support for deprecated use of named dataSource in the URI has been removed.

You have to use `sql:select * from table where id=# order by name?dataSource=\#myDS` instead of `sql:select * from table where id=# order by name?dataSource=myDS`.

=== Spring Boot Starters

Some of the Camel Spring Boot starters have additional autoconfiguration options that clashed with component.
Therefore, those configurations have renamed their configuration keys:

|====
| *Old Key prefix* | *New key prefix*
| camel.component.consul.service-registry | camel.cloud.consul
| camel.cloud.consul.service-registry | camel.cloud.consul
|====

=== Apache Karaf

The `camel-grpc` feature has been removed.
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.11 to 3.12

=== API changes

The methods `getComponentNames` and `getLanguageNames` on `CamelContext` have been changed to
return `Set<String>` instead of `List<String>`.

Added `getExchangePattern` to `Endpoint` which is a method that already exists on `DefaultEndpoint`.
However the method is needed to be exposed in the API as well.

The `ThroughputLogger` has changed the return type from `int` to `long` in the `getReceivedCounter` method.

Removed the `dataSonnet(Expression)` methods from `RouteBuilder` as they should not be used;
use the methods that take `String` as type.

=== Data Formats

We had to fix all the data-formats options that take a Java classname to support
using the `.class` type in Java vs using a string value in XML/YAML.

This means the following options have been renamed:

- `camel-asn1` renamed `clazzName` to `unmarshalType`
- `camel-avro` renamed `collectionTypeName` to `collectionType`, and `jsonViewTypeName` to `jsonView`, and `unmarshalTypeName` to `unmarshalType`
- `camel-cbor` renamed `collectionTypeName` to `collectionType`, and `unmarshalTypeName` to `unmarshalType`
- `camel-jacksonxml` renamed `collectionTypeName` to `collectionType`, and `jsonViewTypeName` to `jsonView`, and `unmarshalTypeName` to `unmarshalType`
- `camel-json` renamed `collectionTypeName` to `collectionType`, and `jsonViewTypeName` to `jsonView`, and `unmarshalTypeName` to `unmarshalType`
- `camel-protobuf` renamed `collectionTypeName` to `collectionType`, and `jsonViewTypeName` to `jsonView`, and `unmarshalTypeName` to `unmarshalType`
- `camel-yaml` renamed `unmarshalTypeName` to `unmarshalType`

=== Rest DSL

The `clientRequestValidation` now includes one more check:

- Parsing error of the message body (JSon, XML or Auto binding mode must be enabled). (Returns HTTP Status 400)


=== camel-aws2-ddb

The `iteratorType` option has been dropped in favour of the `streamIteratorType` option. Possible values are `FROM_LATEST` and `FROM_START`.

The `sequencenumberprovider` functionality is no longer supported.

=== camel-catalog

Remove the APIs to return the website documentation in ascii doc and html format, it is the methods
with naming pattern `...AsciiDoc` and `...HtmlDoc`.

=== camel-cdi

The XML DSL with `camel-cdi` has removed the deprecated `<proxy>` functionality.

=== camel-http-common

The method `org.apache.camel.http.common.HttpHelper.readResponseBodyFromInputStream` is renamed to `cacheResponseBodyFromInputStream`,
because it must cache the response body as it is used with the `PollingConsumer` in `camel-http`,
that otherwise may fail if the original `InputStream` is closed by the underlying HTTP client.

=== camel-jms

The `camel-jms` component now better support Apache Artemis in streaming mode for large messages support,
when Artemis is using a pooled connection pool (previously pooled was not supported). Now the option `artemisStreamingEnabled`
must explicit be set to `true` to enable support for Artemis streaming mode. Previously Camel tried to auto-detect this.

=== camel-google-sheets

The `google-sheets-stream` component has changed the syntax, from: `google-sheets-stream:apiName` to: `google-sheets-stream:spreadsheetId`

The old `apiName` option was not in use, and therefore it has been replaced with `spreadsheetId`
which used to be query parameter.

=== camel-kamelet / route templates

Kamelet parameters that are named such as `host`, `port` are now always used with their configured value.
Before the value in use may have been from an ENV variable with the same name.

=== camel-kafka

The `camel-kafka` component was refactored to avoid blocking API calls in the Kafka consumer. As part of the refactoring the configuration `consumerStreams` was removed. In previous versions this setting configured the size thread pool used by the component to create Kafka consumers. As of 3.12, the size of the thread pool is set to be the same as the number of concurrent consumers (set by `consumersCount`).

=== camel-spark

The `camel-spark` component has been upgraded from Spark 2.x to 3.x.

=== camel-influxdb

The `camel-influxdb` won't autocreate the database if not present anymore.
With CAMEL-16892 we introduced the checkDatabaseExistence and autoCreateDatabase options for this purpose. 
Both of the options are false by default. So, you'll need to set both to true if you want to have the older releases' behavior, or create the database yourself before using the camel component.

=== camel-huawei

All Huawei Cloud components use AK/SK as security keys to authenticate against the hauwei cloud backend services. Initally AK was mapped to authenticationKey in the endpoint class. To be in-line with Huawei Cloud's naming conventions, we have renamed this option from `authenticationKey` to `accessKey` for all components. This is a breaking change for users who are already using huawei cloud components until version 3.11.x. 

=== camel-spring-cloud-*-starter

The deprecated camel-spring-boot cloud-starter components camel-spring-cloud-starter, camel-spring-cloud-consul-starter, camel-spring-cloud-netflix-starter and camel-spring-cloud-zookeeper-starter have been removed.
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.12 to 3.13

=== API changes

Added method `getStartedEventNotifiers` to `org.apache.camel.spi.ManagementStrategy`.

Added method `scheduleQueue` to `org.apache.camel.spi.ReactiveExecutor`.

The `org.apache.camel.support.ObjectHelper#createIterable` now supports `java.util.Map` returning
an `Iterable<Map.Entry>` iterating each row in the map.

The `org.apache.camel.spi.RestApiProcessorFactory` has removed
the following two parameters (`String contextIdPattern, boolean contextIdListing`)
from the `createApiProcessor` method.

=== Split EIP

The Split EIP now supports splitting message bodies that are of type `java.util.Map`, which
now splits that into a `Set<Map.Entry>` - eg a set of each map entry as key/value pairs.

=== SimpleBuilder

The `org.apache.camel.builder.SimpleBuilder` has been deprecated. This builder
was mostly used internally in Camel with the Java DSL in some situations.

End users that may use `SimpleBuilder` in Camel Java DSL can migrate from:

[source,java]
----
simple("1").resultType(Integer.class))
----

to

[source,java]
----
simple("1", Integer.class)
----

=== CamelContextInitializing and CamelContextInitialized events

These two events are fired during bootstrap of `CamelContext` even if a custom `EventNotifier`
may not have been fully started. This is due to that these events happen very early in the
bootstrap process, but are of importance for event notifiers to be able to react upon.

=== Using custom Debugger

Previously when setting a custom `org.apache.camel.spi.Debugger`, then Camel would automatically
enable debug mode. Now debugging must be enabled by setting `setDebugging(true)` on `CamelContext`.

=== Using Transactions

The routing engine has been changed to route exchanges in a different order
when using transactions (`.transacted()`). When an `Exchange` is continued
routed a task is scheduled to the `ReactiveExecutor`. This fixed issues
with could lead to `StackOverflowException`.

=== camel-couchdb

The `since` configuration was replaced by the `resumeStrategy`. Integrations can now manage the last update sequence for tracking the changes directly. Check the samples section on the component documentation page for a sample.

=== camel-file

In order to reduce memory pressure, the component was modified to avoid using Lists for certain file operations (CAMEL-17059). This affected the APIs of some the APIs and interfaces provided by the component.

- `GenericFileOperations`: the return type for the methods `listFiles` and `listFiles(String)` was modified to return an array of (generic) objects instead of a List
- `GenericFileConsumer`: the signature of the methods `isValidFile` and `isMatched` was modified to receive an array of files.

=== camel-ftp

The `FtpConsumer`, `FtpOperations`, `SftConsumer` and `SftpOperations` classes were modified to comply with the API changes on the `camel-file` component.

=== camel-hazelcast-starter

The `camel-hazelcast-starter` for Spring Boot no longer has _customer_ auto configuration options for all its components

eg the following configuration keys have been removed

- `...customizer.hazelcast-instance.enabled`
- `...customizer.hazelcast-instance.override`

Any Camel component can be customized by using the `org.apache.camel.spi.ComponentCustomizer` SPI.

=== camel-jsch

The `ScpOperations` class were modified to comply with the API changes on the `camel-file` component.

=== camel-kafka

The `KafkaManualCommit` class were modified in order to support async manual commit. Please use the new function `commit()` instead of the old deprecated one `commitSync()`.

=== camel-mllp

This component has been refactored to be similar to other Camel components.
The old component had an unusual static configuration of the `MllpComponent` which now is
refactored to be Camel standard with regular getter/setters. The component is now also
configured _reflection free_. We also cleaned up how the component dealt with which charset
to use when processing HL7 messages. Users using `camel-mllp` is recommended to test
their applications when upgrading to ensure this continues to work.

=== camel-openapi-java / camel-swagger-java

When using Rest DSL and the `restConfiguration` has a `contextPath` configured, then this value
is used as leading base path for all API services that are in the generated api-docs.

This is i.e. needed when using `camel-servlet` which runs under a specific `context-path`.

Support for rendering api docs by discovering other CamelContext via JMX in the same JVM has been removed.
Rendering of api docs is now only supported for the same CamelContext.

=== camel-quartz

The `fireNow` parameter was removed because have no effect.
The `triggerStartDelay` parameter supports negative value to shift trigger start time in the past. It allows to fire the trigger immediately by configured `MISFIRE_INSTRUCTION_FIRE_ONCE_NOW`.

=== camel-aws2-sqs

Since the maximum number of attributes per SQS message is 10, we are limiting the number of headers to be converted to attributes to 10.

=== When using muteException

HTTP based components that are using `muteException=true` will return an empty message body,
instead of the text `Exception`.

This applies to camel-jetty, camel-undertow, camel-servlet, camel-netty-http
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example, if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.14.x to 3.14.10

The option `synchronous` in `camel-ftp` has been removed, as this is always enabled to ensure
thread safety for the underlying FTP client.

== Upgrading Camel 3.13 to 3.14

=== API changes

Added method `updateRoutesToCamelContext` to `org.apache.camel.RoutesBuilder` interface.

Added parameter `Resource` in `createRoute` method on `org.apache.camel.spi.RouteFactory`.

Added method `reloadProperties` to `org.apache.camel.spi.LoadablePropertiesSource`.

Removed the deprecated `headerName` option from RemoveHeader EIP. Use `name` instead.

=== camel-kafka

The APIs in `camel-kafka` component changed from using the Kafka Client classes `org.apache.kafka.clients.producer.KafkaProducer` and `org.apache.kafka.clients.consumer.KafkaConsumer`
to their interfaces `org.apache.kafka.clients.producer.Producer` and `org.apache.kafka.clients.consumer.Consumer` instead.

The option `KafkaManualCommitFactory` on component is now autowired, if there exists a single
custom factory in the registry.

=== camel-jbang

The option `debug-level` has been renamed to `logging-level` because the option is for configuring the logging level.

=== camel-zookeeper/camel-master

When using Zookeeper with the Master component, the given namespace is now used to define leadership. In other words, a route defined with `master:lock1` will result in one leader election, while a route defined with `master:lock2` will result in a separate leader election, which may or may not result in the same leader as `lock1`. This matches the existing behavior of the Master component when using Consul.

=== camel-aws2-ses

The to and replyTo parameters are now comma separated String and no more List of Strings, this is true even for the related headers.
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.14 to 3.15

IMPORTANT: Java 8 is no longer supported. Camel 3.15 onwards requires Java 11 or 17.

=== Removed components

The `camel-kamelet-reify` and `camel-spring-javaconfig` has been removed.

=== Removed Maven Archetypes

The `camel-archetype-endpointdsl` has been removed.

=== API changes

Added `getScheme` method to `org.apache.camel.spi.Resource`.

=== Core Dependency changes

As part of CAMEL-17429 and CAMEL-17435, the following dependencies are no longer included by default on all the Camel modules:

 * com.sun.xml.messaging.saaj:saaj-impl
 * jakarta.xml.bind:jakarta.xml.bind-api
 * javax.annotation:javax.annotation-api
 * javax.xml.soap:javax.xml.soap-api
 * javax.xml.ws:jaxws-api
 * org.apache.geronimo.specs:geronimo-jta_1.1_spec
 * org.apache.geronimo.specs:geronimo-ws-metadata_2.0_spec
 * org.glassfish.jaxb:jaxb-runtime

These dependencies were included on the specific modules and components that required them on a per-case basis.

Applications with dependency on any of those, but using them transitively, should be modified to include them.

=== camel-core

Removed the deprecated `Classic` value from `startupSummaryLevel` enums.

The deprecated `propertyName` on `removeProperty` EIP has been removed, use `name` instead.

=== Data Formats

The data formats naming has been made consistent to use Camel Case:

[width="100%",cols="1m,1m",options="header"]
|====
| Old Name | New Name
| bindy-csv | bindyCsv
| bindy-fixed | bindyFixed
| bindy-kvp | bindyKvp
| customDataFormat | custom
| gzip-deflater | gzipDeflater
| jacksonxml | jacksonXml
| json-fastjson | fastjson
| json-gson | gson
| json-jackson | jackson
| json-johnzon | johnzon
| json-jsonb | jsonb
| json-xstream | xstreamJson
| mime-multipart | mimeMultipart
| protobuf-jackson | protobufJackson
| secureXML | xmlSecurity
| soapjaxb | soap
| tarfile | tarFile
| univociy-csv | univociyCsv
| univociy-fixed | univociyFixed
| univociy-tsv | univociyTsv
| yaml-snakeyaml | snakeYaml
| zip-deflater | zipDeflater
| zipfile | zipFile
|====

The Spring Boot auto-configuration names has also been renamed
(uses dash case as this is Spring Boot naming style):

[width="100%",cols="1m,1m",options="header"]
|====
| Old Name | New Name
| camel.dataformat.fhirjson | camel.dataformat.fhir-json
| camel.dataformat.fhirxml | camel.dataformat.fhir-xml
| camel.dataformat.gzipdeflater | camel.dataformat.gzip-deflater
| camel.dataformat.jacksonxml | camel.dataformat.jackson-xml
| camel.dataformat.jsonapi | camel.dataformat.json-api
| camel.dataformat.mimemultipart | camel.dataformat.mime-multipart
| camel.dataformat.securexml | camel.dataformat.xml-security
| camel.dataformat.tarfile | camel.dataformat.tar-file
| camel.dataformat.tidymarkup | camel.dataformat.tidy-markup
| camel.dataformat.univocitycsv | camel.dataformat.univocity-csv
| camel.dataformat.univocityfixed | camel.dataformat.univocity-fixed
| camel.dataformat.univocitytsv | camel.dataformat.univocity-tsv
| camel.dataformat.yaml-snakeyaml | camel.dataformat.snake-yaml
| camel.dataformat.zipdeflater | camel.dataformat.zip-deflater
| camel.dataformat.zipfile | camel.dataformat.zip-file
|====

==== Message History

The message history output has changed to include source column, which refers to the Java class/XML file
from the DSL the message was at the given time. (line precise error reporting).

This default formatting are (Source, ID, Processor, Elapsed):

[source,properties]
----
MESSAGE_HISTORY_HEADER = "%-40s %-30s %-50s %-12s";
MESSAGE_HISTORY_OUTPUT = "%-40.40s %-30.30s %-50.50s %12.12s";
----

If you are using custom sizes then you need to adjust accordingly.

=== camel-endpointdsl

The Endpoint DSL is now more type-safe, where previously an option would be declared as `Object` type,
is now declared using its actual type, such as `javax.sql.DataSource`.

Option that are enums is now using the real enum FQN class name, instead of a duplicate enum
class that was embedded inside the Endpoint DSL. For example when using `aws2sq` the
namingStrategy enum is changed from `org.apache.camel.builder.endpoint.dsl.AWS2S3EndpointBuilderFactory`
to `org.apache.camel.component.aws2.s3.stream.AWSS3NamingStrategyEnum` class name.

=== camel-management

The route controller MBeans are moved from `routecontrollers` to the existing `services`
node in the JMX MBean tree.

Removed deprecated operations on `CamelContextMBean` and `CamelRouteMBean`.

=== camel-util

Deleted the `replaceAll` method of `org.apache.camel.util.StringHelper`. Please use the `replace` method of `java.lang.String` instead, as it is much faster from Java 11 onward.

=== camel-yaml-dsl

Removed `steps` from `route` because steps should only be configured on `from` making
the DSL consistent and similar to Java DSL.

Before it was possible to do:

[source,yaml]
----
- route:
    id: demo-route
    from:
      uri: "timer:info"
    steps:
      - log: "message"
----

This should correctly be done with `steps` as child of `from`:

[source,yaml]
----
- route:
    id: demo-route
    from:
      uri: "timer:info"
      steps:
        - log: "message"
----

The `tod` EIP name has been removed, the correct names to use is `toD`.

=== camel-jbang

The JBang app that was previously named `CamelJBang` is now named `camel`. It is still possible to use the older name by installing it using `CamelJBang@apache/camel` but this approach is deprecated and should not be used in the future.

=== camel-debezium

Upgraded to Debezium 1.8 which requires Java 11 and Kafka Client 3.0 JARs.

=== camel-cdi

The legacy XML in `camel-cdi` with `<camelContext>` is deprecated, instead the XML DSL route loader should be used.

JTA support is moved out of `camel-cdi` to its own `camel-cdi-jta` module.

The `org.apache.camel.cdi.Main` class has moved from `camel-cdi` to `camel-cdi-main` JAR.

=== camel-kafka

The following classes were moved from `org.apache.camel.component.kafka` to `org.apache.camel.component.kafka.consumer`:

* `DefaultKafkaManualAsyncCommit`
* `DefaultKafkaManualAsyncCommitFactory`
* `DefaultKafkaManualSyncCommit`
* `DefaultKafkaManualSyncCommitFactory`
* `KafkaAsyncManualCommit`
* `KafkaManualCommit`
* `KafkaManualCommitFactory`

The signature for `KafkaManualCommitFactory` and its classes has been adjusted to abstract some runtime parameters. The old signature is still available but will be removed in 3.16.0.

=== camel-karaf

The `camel-endpointdsl` and `camel-componentdsl` is no longer supported on Apache Karaf.

The `camel-osg-activator`, `camel-google-calendar`, `camel-google-drive`, `camel-google-mail`, `camel-google-sheets`, and `camel-jooq` has been removed.

=== camel-netty / camel-netty-http

The netty producer has migrated from commons-poll v1 to v2.
The option `producerPoolMaxActive` is renamed to `producerPoolMaxTotal`.

=== camel-quartz

Removed the option `startDelaySeconds` as this does not work correctly and causes problems if in use.

=== camel-rabbitmq

The rabbitmq producer has migrated from commons-poll v1 to v2.

=== camel-openapi-java

The contextPath specified in the REST configuration is no longer added to the paths of the operations in the generated openapi specification.

=== camel-google-drive

The `camel-google-drive` component has upgraded to the latest version of `google-api-services-drive`. This means that support for access to the Google Drive Realtime APIs 
via URIs like `google-drive:drive-realtime` has been removed. Google deprecated and retired the realtime APIs some time ago.  
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.15 to 3.16

=== camel-core

Change the default from `Override` to `Ignore` in the `TypeConverterExists` option,
and the TypeConverterExistsLoggingLevel from `WARN` to `DEBUG`.

Previously when Camel detected a duplicate type converter during startup, Camel would
override the existing converter and log a WARN. A more correct behaviour would be
to keep the existing and ignore the duplicate.

Removed the deprecated class `org.apache.camel.impl.RouteIdFactory`.

=== Rest DSL

The Rest DSL have some changes.

==== Removed support for embedded routes

The Rest DSL no longer allows embedding routes directly into each REST service.
Instead, you must use `to` to route to a Camel endpoint. If you have an embedded
route you can them make this into an individual route using `direct` as the input endpoint,
and then link to this route from the REST service.

For example

[source,java]
----
rest("/users")
  .get("/{id}")
  .route().
    // embedded route here
----

Should now be:

[source,java]
----
rest("/users")
  .get("/{id}")
  .to("direct:users-by-id");

from("direct:users-by-id")
    // embedded route here
----

And in XML:

[source,xml]
----
<rest path="/users">
  <get path="/{id}">
    <route>
      ...
   </route>
  </get>
</rest>
----

Should now be:

[source,xml]
----
<rest path="/users">
  <get path="/{id}">
    <to uri="direct:users-by-id"/>
  </get>
</rest>

<route>
  <from uri="direct:users-by-id"/>
  ...
</route>
----

==== Renamed uri to path

Rename `uri` to `path` on the verb classes listed above.
When using XML or YAML DSL then migration is needed such as:

[source,xml]
----
<rest>
  <get uri="/hello/{name}">
    ...
  </get>
</rest>
----

Should be:

[source,xml]
----
<rest>
  <get path="/hello/{name}">
    ...
  </get>
</rest>
----

And in YAML DSL:

[source,yaml]
----
rest:
  get:
    - uri: "/hello/{name}"
      to: "direct:hello"
----

Should be:

[source,yaml]
----
rest:
  get:
    - path: "/hello/{name}"
      to: "direct:hello"
----

==== Renamed classes

The generic verb-based definition, where the HTTP verb can be specified as a string value
is no longer supported for defining a REST service.
Only the built-in verbs (get, post, put etc.) must be used.

Renamed the following classes in package `org.apache.camel.model.rest`:

- `DeleteVerbDefinition` to `DeleteDefinition`
- `GetVerbDefinition` to `GetDefinition`
- `HeadVerbDefinition` to `HeadDefinition`
- `PatchVerbDefinition` to `PatchDefinition`
- `PostVerbDefinition` to `PostDefinition`
- `PutVerbDefinition` to `PutDefinition`
- `RestSecurityApiKey` to `ApiKeyDefinition`
- `RestSecurityBasicAuth` to `BasicAuthDefinition`
- `RestSecurityBearerToken` to `BearerTokenDefinition`
- `RestSecurityMultalTLS` to `MutalTLSDefinition`
- `RestSecurityOAuth2` to `OAuth2Definition`
- `RestSecurityOpenIdConnect` to `OpenIdConnectDefinition`
- `RestOperationParamDefinition` to `ParamDefinition`
- `RestOperationResponseHeaderDefinition` to `ResponseHeaderDefinition`
- `RestOperationResponseMsgDefinition` to `ResponseMessageDefinition`

==== Removed classes

For the sake of simplicity, the class `RestSecuritiesRequirement` has been removed because it contains only elements of type `SecurityDefinition` which have been moved directly into `RestDefinition`.

=== Aggregate EIP

Renamed `strategyRef` to `aggregationStrategy`, and marked this option as required.
Renamed `strategyMethodName` to `aggregationStrategyMethodName`.
Renamed `strategyMethodAllowNull` to `aggregationStrategyMethodAllowNull`.
Renamed `aggregationRepositoryRef` to `aggregationRepository`.
Renamed `aggregateControllerRef` to `aggregateController`.
Renamed `executorServiceRef` to `executorService`.
Renamed `timeoutCheckerExecutorServiceRef` to `timeoutCheckerExecutorService`.
Removed some deprecated methods, and some unnecessary methods in Java DSL.

=== Circuit Breaker EIP

Renamed `circuitBreakerRef` to `circuitBreaker`.
Renamed `configRef` to `config`.
Renamed `bulkheadExecutorServiceRef` to `bulkheadExecutorService`.
Renamed `timeoutScheduledExecutorServiceRef` to `timeoutScheduledExecutorService`.

=== Claim Check EIP

Renamed `strategyRef` to `aggregationStrategy`, and marked this option as required.
Renamed `strategyMethodName` to `aggregationStrategyMethodName`.
Removed some unnecessary methods in Java DSL.

=== Delay EIP

Renamed `executorServiceRef` to `executorService`.

=== DoSwitch EIP

Replaced by Choice EIP in precondition mode.

Before it was:
[source,java]
----
.doSwitch()
    .when(simple("{{?red}}")).to("mock:red")
    .when(simple("{{?blue}}")).to("mock:blue")
.end()
----

Now it is:
[source,java]
----
.choice().precondition()
    .when(simple("{{?red}}")).to("mock:red")
    .when(simple("{{?blue}}")).to("mock:blue")
.end()
----

=== Enrich & Poll Enrich EIPs

Renamed `strategyRef` to `aggregationStrategy`, and marked this option as required.
Renamed `strategyMethodName` to `aggregationStrategyMethodName`.
Renamed `strategyMethodAllowNull` to `aggregationStrategyMethodAllowNull`.
Removed some deprecated methods, and some unnecessary methods in Java DSL.

=== Idempotent Consumer EIP

Renamed `messageIdRepositoryRef` to `idempotentRepository`.
Removed some unnecessary methods in Java DSL.

=== Log EIP

Renamed `loggerRef` to `logger`.

=== Multicast, Recipient List & Split EIP

Renamed `strategyRef` to `aggregationStrategy`.
Renamed `strategyMethodName` to `aggregationStrategyMethodName`.
Renamed `strategyMethodAllowNull` to `aggregationStrategyMethodAllowNull`.
Renamed `onPrepareRef` to `onPrepare`.
Renamed `executorServiceRef` to `executorService`.
Removed some deprecated methods, and some unnecessary methods in Java DSL.

=== OnCompletion EIP

Renamed `executorServiceRef` to `executorService`.

=== Resequence EIP

Renamed `comparatorRef` to `comparator`.

=== Sort EIP

Renamed `comparatorRef` to `comparator`.

=== Threads EIP

Renamed `executorServiceRef` to `executorService`.

=== Throttle EIP

Renamed `executorServiceRef` to `executorService`.

=== Saga EIP

Renamed `sagaServiceRef` to `sagaService`.
Removed the deprecated `timeoutInMilliseconds` option, use `timeout` instead.

In the `<option>` the `optionName` is renamed to `key`. When using XML DSL then this is affected as follows:

[source,xml]
----
<saga sagaServiceRef="mySagaService">
    <compensation uri="mock:compensation"/>
    <completion uri="mock:completion"/>
    <option optionName="myOptionKey">
        <constant>myOptionValue</constant>
    </option>
    <option optionName="myOptionKey2">
        <constant>myOptionValue2</constant>
    </option>
</saga>
----

To:

[source,xml]
----
<saga sagaServiceRef="mySagaService">
    <compensation uri="mock:compensation"/>
    <completion uri="mock:completion"/>
    <option key="myOptionKey">
        <constant>myOptionValue</constant>
    </option>
    <option key="myOptionKey2">
        <constant>myOptionValue2</constant>
    </option>
</saga>
----

=== WireTap EIP

Renamed `onPrepareRef` to `onPrepare`.
Renamed `executorServiceRef` to `executorService`.
Removed the _new message_ mode as this functionality is better done by using onPrepare processor in copy mode.

=== camel-health

The `HealthCheck` API has been simplified and removed the following configurations:

- interval
- success threshold
- failure threshold

These options would complicate health checks as they affect the outcome of health checks.
It is better the checks always execute and the responsibility of the monitoring systems
how to deal with interval between checks and thresholds.

Removed the option to disable context health check as it should always be enabled.

==== Disabling health checks

The configuration for disabling individual health-checks has changed

Before each health-check could be configured and set `enabled=false`. For example
to disable health-checks for route with id `netty` you would do:

[source,properties]
----
camel.health.config[netty].check = routes
camel.health.config[netty].enabled = false
----

With Camel 3.16 onwards you instead specify pattern(s) for health checks to be excluded
from being invoked, which is done in a single configuration:

[source,properties]
----
camel.health.exclude-pattern = netty
----

You can specify multiple patterns (and use wildcards) such as:

[source,properties]
----
camel.health.exclude-pattern = netty,foo,bar*
----

=== camel-main

The option `camel.main.packageScanRouteBuilders` has been renamed to `camel.main.basePackageScan`.

Using configuration classes must now implement the interface `org.apache.camel.main.CamelConfiguration`
and the `configure` method now takes a `CamelContext` as argument.

=== camel-any23

The option `baseURI` is renamed to `baseUri`.

=== camel-aws2-kinesis

The `camel-aws2-kinesis` component will now set only the raw data as body while consuming from a stream. The data will be an input stream.
This changes the behavior from the old versions because in the past the component was returning the full record as part of the body.

=== camel-aws2-sqs

The `camel-aws2-sqs` component will now map message headers from their original type
such as boolean, integer, etc. This requires using Camel for both sending and receiving
as AWS only have string or binary types, so Camel stores custom metadata in the message header
to know its original type.

=== camel-stream

The producer will now by default append new line character to end of output.
The option `appendNewLine` can be used to turn this off.

=== camel-testcontainers

This component was deprecated and is removed on this version. Users should migrate to xref:test-infra.adoc[camel-test-infra].

=== camel-testcontainers-junit5

This component was deprecated and is removed on this version. Users should migrate to xref:test-infra.adoc[camel-test-infra].

=== camel-testcontainers-spring

This component was deprecated and is removed on this version. Users should migrate to xref:test-infra.adoc[camel-test-infra].

=== camel-testcontainers-spring-junit5

This component was deprecated and is removed on this version. Users should migrate to xref:test-infra.adoc[camel-test-infra].

=== camel-salesforce

The `sObjectName` query parameter and header now take precedence over the class name of the `AbstractSObjectBase` DTO for
determining the name of the SObject. We suggest testing your existing routes to identify any potential issues. See
https://issues.apache.org/jira/browse/CAMEL-17608 for more details.
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.16 to 3.17

=== camel-core

==== Stream Caching

We have enabled xref:stream-caching.adoc[Stream Caching] by default on `CamelContext`. The reason is that Camel users
may often hit this problem without knowing what is causing this, and blaming it on Apache Camel.

This means that Camel would automatically cache message bodies that are based on `java.util.InputStream`
such as often seen with HTTP components. This makes it safe to log the message body, and elsewhere.

The cost is a tiny overhead in the routing engine as Camel will automatic type convert
to `StreamCache` if needed. Users can turn this off:

[source,java]
----
CamelContext context = ...
context.setStreamCaching(false);
----

Or via Camel Main / Camel K / Quarkus:

[source,properties]
----
camel.main.streamCachingEnabled=false
----

Or in Spring Boot

[source,properties]
----
camel.springboot.streamCachingEnabled=false
----

And in legacy Spring XML or OSGi Blueprint:

[source,xml]
----
<streamCaching enabled="true" .../>
----

We also changed the default settings for stream caching to not spool to disk, meaning that the cache
is an in-memory on cache.

To enable spool to disk, you can configure this as follows:

[source,java]
----
CamelContext context = ...
context.getStreamCachingStrategy().setSpoolEnabled(true);
----

Or via Camel Main / Camel K / Quarkus:

[source,properties]
----
camel.main.streamCachingSpoolEnabled=true
----

Or in Spring Boot

[source,properties]
----
camel.springboot.streamCachingSpoolEnabled=true
----

And in legacy Spring XML or OSGi Blueprint:

[source,xml]
----
<streamCaching spoolEnabled="true" .../>
----

=== camel-health

Camel now reports DOWN when Camel is being stopped, during the graceful shutdown process.
This ensures that Camel reports that it's not ready to accept new traffic.

=== camel-main

Added method `findRouteResourcesFromDirectory` to `org.apache.camel.main.RoutesCollector`.

=== camel-yaml-dsl

Removed deprecated `spec/flows` and `spec/flow` from the kamelet yaml loader.
Must use `spec/template` as key for the kamelet template.

Removed _endpoint-dsl_ notation which was not well known,
causing problems for tools, and yaml-validation against the json-schema standard.

For example the following notation:

[source,yaml]
----
- from:
    uri: "direct:start"
    steps:
      - to:
          kafka:
            topic: cheese
            brokers: mykafka:1234
----

Should be change to:

[source,yaml]
----
- from:
    uri: "direct:start"
    steps:
      - to:
          uri: "kafka:cheese?brokers=mykafka:1234"
----

Or

[source,yaml]
----
- from:
    uri: "direct:start"
    steps:
      - to:
          uri: "kafka"
          parameters:
            topic: "cheese"
            brokers: "mykafka:1234"
----

=== camel-spring-xml / camel-blueprint

The error handling has been made universal and exposed generally in the `camel-core-model`
with intent to align error handling across DSLs.

However, the XML DSL for Spring `<beans>` and OSGi blueprint is legacy, and they
have their own special XML parsing and error handling.

This means the model classes has been renamed, which only affect Camel end users whom
has defined error handling as `<bean>` in Spring or Blueprint XML files:

- `org.apache.camel.builder.DeadLetterChannelBuilder` to `org.apache.camel.builder.LegacyDeadLetterChannelBuilder`
- `org.apache.camel.builder.DefaultErrorHandlerBuilder` to `org.apache.camel.builder.LegacyDefaultErrorHandlerBuilder`
- `org.apache.camel.builder.NoErrorHandlerBuilder` to `org.apache.camel.builder.LegacyNoErrorHandlerBuilder`
- `org.apache.camel.spring.spi.TransactionErrorHandlerBuilder` to `org.apache.camel.spring.spi.LegacyTransactionErrorHandlerBuilder`

Users who has been configured error handling using `<errorHandler>` in Spring or Blueprint XML files should not be affected.

=== camel-cdi / camel-cdi-jta

The class `org.apache.camel.cdi.CdiRouteBuilder` has been removed as you can use `jtaTransactionErrorHandler` builder
methods from `camel-core` instead.

The class `org.apache.canel.jta.JtaTransactionErrorHandlerBuilder` has been removed, as the JTA error handler builder
can be used with the `jtaTransactionErrorHandler` from `camel-core-model`.

=== camel-kafka

The option `autoCommitOnStop` was removed from the Camel Kafka component. When using `autoCommitEnable` (which is enabled by default) the Kafka consumer will automatically commit on close.

When the `autoCommitEnable` is turned off, the component issues a call to the respective commit manager during shutdown.

Asynchronous, Synchronous or NO-OP commit policies from the former `autoCommitOnStop` are now determined by automatically by the value of the `kafkaManualCommitFactory` option:

* NO-OP is the default behavior if no `kafkaManualCommitFactory` is provided
* Async can be set using `kafkaManualCommitFactory=#class:org.apache.camel.component.kafka.consumer.DefaultKafkaManualAsyncCommitFactory`
* Sync can be set using `kafkaManualCommitFactory=#class:org.apache.camel.component.kafka.consumer.DefaultKafkaManualCommitFactory`

The deprecated constructors for the kafkaManualCommitFactory have been removed. The constructor should now receive the following parameters:

[source,java]
----
CamelExchangePayload camelExchangePayload, KafkaRecordPayload kafkaRecordPayload, CommitManager commitManager
----

=== camel-platform-http-vertx

The configuration for body handler file uploads has changed from `true` to `false`.
The configuration can be enabled via the `VertxPlatformHttpServerConfiguration` class.

=== camel-opentracing / camel-opentelemetry

We aligned the MDC keys with OpenTelemetry, so they are changed from:

- `traceId` -> `trace_id`
- `spanId` -> `span_id`

=== camel-atom

This component was refactored to support the Resume API v2. As such, the options `filter` and `lastUpdate` where removed.

[source,java]
----
from("atom:file:src/test/data/feed.atom?splitEntries=true&delay=500")
    .resumable().resumeStrategy(new UpdatedDateFilter(new Date()))
    .to("mock:result");
----

More complex filters can be implemented by extending the `UpdatedDateFilter` or by implementing a new `EntryFilter` resume strategy.

=== camel-cdi

The support for the Camel XML configuration import, that had been marked as deprecated in previous releases, was removed.

=== camel-cxf-blueprint

When using OSGi Blueprint with CXF endpoints defined in their own namespace as below,
then you must use `depends-on` to refer to the ID of the `<camelContext>`.

Notice how we must use `depends-on="VerySimple-context"` in the `cxf:cxfEndpoint` to refer to the `CamelContext`.

[source,xml]
----
<?xml version="1.0" encoding="utf-8"?>
<osgi:blueprint xmlns:xs="http://www.w3.org/2001/XMLSchema"
                xmlns:camel="http://camel.apache.org/schema/blueprint"
                xmlns:osgi="http://www.osgi.org/xmlns/blueprint/v1.0.0"
                xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf">

	<camel:camelContext id="VerySimple-context">
		<camel:route id="VerySimple-route">
			<camel:from uri="VerySimple"/>
			<camel:to uri="log:proxy.VerySimple"/>
		</camel:route>
	</camel:camelContext>

	<cxf:cxfEndpoint id="VerySimple" depends-on="VerySimple-context" address="http://localhost:8088/VerySimple" serviceName="tns:VerySimple" endpointName="tns:VerySimplePort" wsdlURL="file:deploy/VerySimple.wsdl" xmlns:tns="http://www.talend.org/service/">
		<cxf:properties>
			<osgi:entry key="dataFormat" value="PAYLOAD"/>
		</cxf:properties>
	</cxf:cxfEndpoint>

</osgi:blueprint>
----

=== camel-sftp

The underlying JSch library has been updated (https://issues.apache.org/jira/browse/CAMEL-17835[CAMEL-17835]) to a
more secure and actively maintained fork which has removed key types and algorithms that rely on SHA1. For
information on how these can be restored, consult the xref:components::sftp-component.adoc[SFTP component] documentation.

=== camel-rabbitmq

When using `skipQueueDeclare=true` you now must also set `skipQueueBind=true` to skip both declaring and binding the queue.

=== Deprecated Components

The following components that had been marked as deprecated, were removed in this release:

* camel-atomix
* camel-beanstalk
* camel-beanio
* camel-etcd
* camel-elsql
* camel-ganglia
* camel-nsq
* camel-hystrix
* camel-jing
* camel-leveldb-legacy
* camel-msv
* camel-nagios
* camel-ribbon
* camel-sip
* camel-soroush
* camel-tagsoup
* camel-yammer
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example, if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.17 to 3.18

=== camel-core

Camel will now mask all known secret values when logging endpoint URIs to avoid leaking sensitive details
such as from stack traces. Previously only a subset of known _secret_ keys was masked.

The type converter from `InputStream` to `byte[]` will now close the input stream after the conversion.

The `TimeUtils.printDuration` method outputs now in a more compact format (especially for long durations).
Before `4d12h57m49s` and now `4d12h`. Use `precise=true` to include all details.

=== camel-console

The `AbstractDevConsole` has changed the method `doCall` into two separate methods `doCallText` and `doCallJson`
to better separate output between text and json based.

=== camel-cxf

The `camel-cxf` JAR has been split up into SOAP vs. REST and Spring and non-Spring JARs.

Users should therefore choose `camel-cxf` to migrate among the following JARs:

- `camel-cxf-soap`
- `camel-cxf-spring-soap`
- `camel-cxf-rest`
- `camel-cxf-spring-rest`
- `camel-cxf-transport`
- `camel-cxf-spring-transport`

For example, if you were using CXF for SOAP and with Spring XML, then you would need to migrate
from using `camel-cxf` to `camel-cxf-spring-soap` and `camel-cxf-spring-transport`.

When using Spring Boot, then you need to migrate from `camel-cxf-starter` to use SOAP or REST:

- `camel-cxf-soap-starter`
- `camel-cxf-rest-starter`

The `camel-cxf` XML XSD schemas have also changed namespaces:

|===
|Old Namespace | New Namespace

| `http://camel.apache.org/schema/cxf`
| `http://camel.apache.org/schema/cxf/jaxws`

| `http://camel.apache.org/schema/cxf/camel-cxf.xsd`
| `http://camel.apache.org/schema/cxf/jaxws/camel-cxf.xsd`

| `http://camel.apache.org/schema/cxf`
| `http://camel.apache.org/schema/cxf/jaxrs`

| `http://camel.apache.org/schema/cxf/camel-cxf.xsd`
| `http://camel.apache.org/schema/cxf/jaxrs/camel-cxf.xsd`

|===

IMPORTANT: The namespace for Apache Camel Karaf (`camel-cxf-blueprint`) has *not* changed.
This module has not been split-up and comes with both SOAP and REST combined as before.

And the `camel-cxf` SOAP component is moved to a new `jaxws` sub-package,
i.e. `org.apache.camel.component.cxf` is now `org.apache.camel.component.cxf.jaws`.

This means, for example, the `CxfComponent` class is now located
in `org.apache.camel.component.cxf.jaxws`.

Some classes in the following packages were refactored, and the package was updated.
If you were using one of those packages and, after the migration, a `ClassNotFoundException` is thrown,
an update should be considered

|===
|Old Package | New Package

| `org.apache.camel.component.cxf`
| `org.apache.camel.component.cxf.common`

| `org.apache.camel.component.cxf.interceptors`
| `org.apache.camel.component.cxf.util`

| `org.apache.camel.component.cxf.converter`
| `org.apache.camel.component.cxf.jaxrs`

| `org.apache.camel.component.cxf`
| `org.apache.camel.component.cxf.jaxws`

| `org.apache.camel.component.cxf.spring`
| `org.apache.camel.component.cxf.spring.jaxrs`

| `org.apache.camel.component.cxf.spring`
| `org.apache.camel.component.cxf.spring.jaxws`

| `org.apache.camel.component.cxf`
| `org.apache.camel.component.cxf.spring.jaxws`

| `org.apache.camel.component.cxf.transport.spring`
| `org.apache.camel.component.cxf.spring.transport`

| `org.apache.camel.component.cxf.common.header`
| `org.apache.camel.component.cxf.transport.header`

| `org.apache.camel.component.cxf.common.message`
| `org.apache.camel.component.cxf.transport.message`

|===

=== camel-endpointdsl

The options for `lazyStartProducer` and `bridgeErrorHandler` has moved into the _advanced_ group.

=== camel-google-calendar

The `keyResource` option has been changed to `serviceAccountKey` to match to Google semantic. Then, if you use the `keyResource`
to Google Calendar component, you should update it to  `serviceAccountKey`.

=== camel-google-drive

The `keyResource` option has been changed to `serviceAccountKey` to match to Google semantic. Then, if you use the `keyResource` 
to Google Drive component, you should update it to  `serviceAccountKey`.

=== camel-jsonpath

There is a new option `unpackArray` in *Camel 3.18.3* that unpacks a single-element Json array, matched by a Jsonpath, into an object. This option is disabled by default (this behaviour was enabled by default in previous Camel versions).
There is a new expression `jsonpathUnpack(String text, Class<?> resultType)` that makes use of this new option.

=== camel-yaml-dsl

The YAML DSL schema files `camel-yaml-dsl.json` and `camelYamlDsl.json` has been moved from root to `schema` sub folder in the JAR.

=== camel-karaf

The `camel-milo` feature has been removed.

= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.18 to 3.19

=== camel-api

Added `addClassLoader` method to `org.apache.camel.spi.ClassResolver`.

The default TLS protocol is changed from `TLSv1.2` to `TLSv1.3` in Camel JSSE support.

=== camel-management

The context MBean (`ManagedCamelContextMBean`) total counter is changed to count only once
while an _exchange_ is being routed through multiple routes. Previously the counter was
a total aggregation of all the routes the _exchange_ was processed. For example if an _exchange_
is routed via A, B and C; then previously the total counter was +3 (+1 for route A, +1 for route B, +1 for route C).
This is now corrected so the total is +1 on the context MBean.

=== camel-main

The option `camel.main.eager-classloading` has been removed.

=== camel-ftp

The default TLS protocol is changed from `TLSv1.2` to `TLSv1.3`.

=== camel-kafka

Updated the documentation to reflect the default TLS protocol in Kafka Clients running on JDK11+
is `TLSv1.2,TLSv1.3` (prefer v1.3 but can fall back to v1.2).

=== camel-netty / camel-netty-http

The default TLS protocol is changed from `TLSv1,TLSv1.1,TLSv1.2` to `TLSv1.2,TLSv1.3`.

=== camel-yaml-dsl

Removed using `template` as a custom alias for `routeTemplate` or `route-template`.

Removed the `tod` custom alias for `toD` or `to-d`.

A route template can now also define a `route` which allows specifying route
options that otherwise is not possible when using `from`.

For example, you can now disable stream-caching, as shown in the snippet below that are from a Kamelet:

[source,yaml]
----
spec:
  template:
    route:
      stream-caching: false
      message-history: true
      from:
        uri: timer:tick
        parameters:
          period: "{{period}}"
        steps:
          - set-body:
              constant: "{{message}}"
          - set-header:
              name: "Content-Type"
              constant: "{{contentType}}"
          - to: kamelet:sink
----

=== camel-salesforce

The URI format for consumer operations has changed. All consumer URIs now use the `subscribe` operation. E.g., `salesforce:subscribe:<topic_name>`, `salesforce:subscribe:event/<event_name>`, `salesforce:subscribe:data/ChangeEvents`.

=== camel-consul

The deprecated options were removed and should be replaced by the following options:

|===
|Deprecated |Replace with

|`connectTimeoutMillis`
|`connectTimeout`

|`readTimeoutMillis`
|`readTimeout`

|`writeTimeoutMillis`
|`writeTimeout`
|===

=== camel-google-bigquery-sql

Parameters in form of `@name` are extracted from the body or message and their type is preserved and translated into corresponding `com.google.cloud.bigquery.StandardSQLTypeName`. See the https://cloud.google.com/java/docs/reference/google-cloud-bigquery/latest/com.google.cloud.bigquery.QueryParameterValue[documentation] for more information. (Conversion to StandardSQLTypeName.STRING was used for each type before)


=== camel-telegram

The component was migrated from the Async HTTP Client to the builtin HTTP client from Java 11 and newer. As such,
* the parameter `clientConfig`, that received an `AsyncHTTPClientConfiguration` instance was removed
* the parameter `client`, that received an `AsyncHttpClient` instance, was modified to receive a HTTPClient instance.


=== xtokenize language

The xtokenize language has moved from `camel-xml-jaxp` to `camel-stax` JAR because
a stax parser was needed anyway to use the language.


=== camel-karaf

Upgraded from Karaf 4.3.x to Karaf 4.4.x, which requires JDK11+.

=== camel-http

Added `followRedirects` option with default value `false` on component and endpoint level. 
The introduction of this option changes the default redirect behaviour for producers from following all `GET` and `HEAD` redirects, to not following any redirects.

=== Deprecated Components

The following components that had been marked as deprecated, were removed in this release:

* camel-ahc
* camel-ahc-ws
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.1 to 3.2

=== JndiRegistry

The deprecated class `org.apache.camel.impl.JndiRegistry` has been removed. The class `org.apache.camel.support.jndi.JndiBeanRepository` located in `org.apache.camel:camel-support` should be used instead.

=== Rest Configuration

The rest configuration has been simplified and there is now a single RestConfiguration instance (https://issues.apache.org/jira/browse/CAMEL-13844[CAMEL-13844]) per Camel Context.

The following methods have been removed:

* org.apache.camel.CamelContext#addRestConfiguration(RestConfiguration restConfiguration)
* org.apache.camel.CamelContext#getRestConfiguration(String component, boolean defaultIfNotFound)
* org.apache.camel.CamelContext#getRestConfigurations

https://issues.apache.org/jira/browse/CAMEL-13844

=== Camel Cloud

The following `ServiceDiscovery` implementation has been removed: 

* org.apache.camel.impl.cloud.CachingServiceDiscovery
* org.apache.camel.impl.cloud.CachingServiceDiscoveryFactory

https://issues.apache.org/jira/browse/CAMEL-14813

=== Camel with Karaf and OSGi

Camel on Apache Karaf / OSGi has been moved to its own project at: https://github.com/apache/camel-karaf

The Maven dependencies has changed the groupid from `org.apache.camel` to `org.apache.camel.karaf`.

For example the `camel-blueprint` would be changed from

[source,xml]
----
<dependency>
  <groupId>org.apache.camel</groupId>
  <artifactId>camel-blueprint</artifactId>
  <version>3.1.0</version>
</dependency>
----

To:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel.karaf</groupId>
  <artifactId>camel-blueprint</artifactId>
  <version>3.2.0</version>
</dependency>
----

The Camel Karaf features are the same as before, you can still install Camel in Karaf shell via:
[source,text]
----
feature:repo-add camel 3.2.0
feature:install camel
----

==== Other components involved

- Camel-test-blueprint

[source,xml]
----
<dependency>
  <groupId>org.apache.camel</groupId>
  <artifactId>camel-test-blueprint</artifactId>
  <version>3.1.0</version>
</dependency>
----

To:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel.karaf</groupId>
  <artifactId>camel-test-blueprint</artifactId>
  <version>3.2.0</version>
</dependency>
----

- Camel-test-karaf

[source,xml]
----
<dependency>
  <groupId>org.apache.camel</groupId>
  <artifactId>camel-test-karaf</artifactId>
  <version>3.1.0</version>
</dependency>
----

To:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel.karaf</groupId>
  <artifactId>camel-test-karaf</artifactId>
  <version>3.2.0</version>
</dependency>
----

- Camel-eventadmin

[source,xml]
----
<dependency>
  <groupId>org.apache.camel</groupId>
  <artifactId>camel-eventadmin</artifactId>
  <version>3.1.0</version>
</dependency>
----

To:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel.karaf</groupId>
  <artifactId>camel-eventadmin</artifactId>
  <version>3.2.0</version>
</dependency>
----

- Camel-kura

[source,xml]
----
<dependency>
  <groupId>org.apache.camel</groupId>
  <artifactId>camel-kura</artifactId>
  <version>3.1.0</version>
</dependency>
----

To:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel.karaf</groupId>
  <artifactId>camel-kura</artifactId>
  <version>3.2.0</version>
</dependency>
----

- Camel-osgi-activator

[source,xml]
----
<dependency>
  <groupId>org.apache.camel</groupId>
  <artifactId>camel-osgi-activator</artifactId>
  <version>3.1.0</version>
</dependency>
----

To:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel.karaf</groupId>
  <artifactId>camel-osgi-activator</artifactId>
  <version>3.2.0</version>
</dependency>
----

- Camel-paxlogging

[source,xml]
----
<dependency>
  <groupId>org.apache.camel</groupId>
  <artifactId>camel-paxlogging</artifactId>
  <version>3.1.0</version>
</dependency>
----

To:

[source,xml]
----
<dependency>
  <groupId>org.apache.camel.karaf</groupId>
  <artifactId>camel-paxlogging</artifactId>
  <version>3.2.0</version>
</dependency>
----

==== Introducing a camel-karaf-bom

We introduce a camel-karaf-bom too, so the end-users should be able to have all of this dependencies easier:

[source,xml]
----
    <dependencyManagement>
        <dependencies>
            <!-- Add Camel BOM -->
            <dependency>
                <groupId>org.apache.camel</groupId>
                <artifactId>camel-bom</artifactId>
                <version>${project.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <!-- Add Camel Karaf BOM -->
            <dependency>
                <groupId>org.apache.camel.karaf</groupId>
                <artifactId>camel-karaf-bom</artifactId>
                <version>${camel.karaf.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
----

In this way you'll get both the boms and all the "goodies"

=== camel-elytron

Transitive dependencies from org.wildfly.security:wildfly-elytron were removed.

=== camel-spark-rest

This component has been removed. Use any of the other REST capable components, such as `camel-jetty`, `camel-netty-http`
or `camel-undertow`.

=== EIPs with cacheSize option

The `cacheSize` option on EIPs has been improved to reduce memory usage when the cache is disabled by
setting the value to -1. One of the optimizations is that new endpoints will not be added to the endpoint registry,
but discarded after use. This avoids storing additional endpoints in the cache (memory) as the cache should be disabled (cacheSize=-1).

See more details in the documentation for the `cacheSize` option on the EIPs.

=== Configuring components via Java setters

Configuring Camel components from plain Java code has changed in some components where they were using
delegate setters for a nested configuration class. These delegates has been removed, to ensure configuration
is more consistent and aligned with how endpoints is configured as well, and by using source code generated configurer classes.

The following Camel components has been affected and changed on the component level:

- camel-aws
- camel-aws2
- camel-consul
- camel-etcd
- camel-infinispan
- camel-kafka
- camel-servicenow
- camel-ssh
- camel-stomp
- camel-xmlsecurity
- camel-yammer

This only affects if you are configuring these components using Java code or XML `<bean>` style.

For example

[source,java]
----
KafkaComponent kafka = new KafkaComponent();
kafka.setBrokers("mybroker1:1234,mybroker2:1234");
----

Should now be:

[source,java]
----
KafkaComponent kafka = new KafkaComponent();
kafka.getConfiguration().setBrokers("mybroker1:1234,mybroker2:1234");
----

And in XML:

[source,xml]
----
<bean id="kafka" class="org.apache.camel.component.kafka.KafkaComponent">
  <property name="brokers" value="mybroker1:1234,mybroker2:1234"/>
</bean>
----

Should now be:

[source,xml]
----
<bean id="kafka" class="org.apache.camel.component.kafka.KafkaComponent">
  <property name="configuration">
    <property name="brokers" value="mybroker1:1234,mybroker2:1234"/>
  </property>
</bean>
----

=== Configuring components via Spring Boot auto configuration

Configuring Camel spring boot components has changed its option keys to be flattened and have the `.configuration` prefix
removed now.

Before in application.properties

[source,properties]
----
camel.component.kafka.configuration.brokers=mybroker1:1234,mybroker2:1234
----

Should now be
[source,properties]
----
camel.component.kafka.brokers=mybroker1:1234,mybroker2:1234
----

This applies to all the Camel spring boot _starter_ JARs where basically `.configuration` should be removed.

=== Configuring camel-activemq, camel-amqp and camel-stomp via Spring Boot auto configuration

When configuring these components from spring boot auto-configuration then the URL for the broker was named `broker-u-r-l`
in the spring boot auto configuration support. This has been renamed to `broker-url` and a few other options too.

Before:

[source,properties]
----
camel.component.activemq.broker-u-r-l=tcp://localhost:61616
----

After:

[source,properties]
----
camel.component.activemq.broker-url=tcp://localhost:61616
----

=== camel-any23

The XML DSL has changed for the `<configuration>` element, which now
is flattened so the key/values should be configured on it directly:

Before:
[source,xml]
----
<dataFormats>
  <any23 id="any23" baseURI ="http://mock.foo/bar" outputFormat="TURTLE" >
    <configuration>
      <property key="any23.extraction.metadata.nesting" value="off" />
      <property key="another-key" value="another-value" />
    </configuration>
    <extractors>html-head-title</extractors>
  </any23>
</dataFormats>
----

After:

[source,xml]
----
<dataFormats>
  <any23 id="any23" baseURI ="http://mock.foo/bar" outputFormat="TURTLE" >
    <configuration key="any23.extraction.metadata.nesting" value="off"/>
    <configuration key="another-key" value="another-value"/>
    <extractors>html-head-title</extractors>
  </any23>
</dataFormats>
----

=== camel-avro

The avro component and data format has been split up into two JARs. The dataformat is in `camel-avro` JAR
and the component in `camel-avro-rpc` JAR.

=== camel-infinispan

Camel now requires endpoint URIs to include context-path which means
the endpoint URI `infinispan` should be changed to `infinispan:current`.

=== google-pubnub

The google-pubnub component has been improved to use a new Java library and become faster.

Support for Apache Karaf has been removed.

=== camel-xstream

The XML DSL has changed for the `<converters>`, `<alias>`, `implicitCollections`, and `omitFields` elements,
which now is flattened so the key/values should be configured on it directly.

Before:
[source,xml]
----
<xstream id="xstream-1" mode="NO_REFERENCES"
    permissions="-org.apache.camel.dataformat.xstream.*,org.apache.camel.dataformat.xstream.PurchaseHistory,org.apache.camel.dataformat.xstream.PurchaseOrder">
    <converters>
        <converter class="org.apache.camel.dataformat.xstream.XStreamConfigurationTest$PurchaseOrderConverter" />
    </converters>
    <aliases>
                <alias name="purchase-order" class="org.apache.camel.dataformat.xstream.PurchaseOrder" />
    </aliases>
    <implicitCollections>
       <class name="org.apache.camel.dataformat.xstream.PurchaseHistory">
          <field>history</field>
       </class>
    </implicitCollections>
</xstream>
----

After:
[source,xml]
----
<xstream id="xstream-1" mode="NO_REFERENCES"
    permissions="-org.apache.camel.dataformat.xstream.*,org.apache.camel.dataformat.xstream.PurchaseHistory,org.apache.camel.dataformat.xstream.PurchaseOrder">
    <converters key="purchase-converter" value="org.apache.camel.dataformat.xstream.XStreamConfigurationTest$PurchaseOrderConverter"/>
    <aliases key="purchase-order" value="org.apache.camel.dataformat.xstream.PurchaseOrder"/>
    <implicitCollections key="org.apache.camel.dataformat.xstream.PurchaseHistory" value="history"/>
</xstream>
----

Multiple values for `implicitCollections` and `omitFields` can be separated by comma

For example:
[source,xml]
----
<implicitCollections key="org.apache.camel.dataformat.xstream.PurchaseHistory" value="history,adress"/>
----

=== camel-weather

This component has been upgraded from using Apache Http Client 3.x to 4.x and is therefore not fully backwards compatible.
Some options for configurer and setting proxy is removed. You can however configure this directly on a custom `HttpClient` instance
and set this on the `WeatherComponent` to use.

=== Endpoint URIs without context path

Previously Camel components may work by referring to their name only without a colon and context path (eg `log`)
that for a few components would allow them to create an endpoint anyway.

Now this is not allowed and Camel will throw an `NoSuchEndpointException`.

An endpoint by its logical id can still be referred by the id only, eg
[source,java]
----
Endpoint endpoint = camelContext.getEndpoint("myCoolEndpoint");
----

=== Error handling

The context scope error handling has been modified a bit.  The processors in those `onException` and
`onCompletion` are not shared between routes anymore.  This should have little effect in most cases.
If there is a need to have a single set of processors involved (such as when using a loadbalancer or
other stateful patterns), then an intermediary route needs to be used. The following excerpt:

[source,java]
----
onException(Exception.class).handled(true)
    .loadBalance().roundRobin().id("round")
    .to("mock:error", "mock:error2", "mock:error3");
----

... needs to be rewritten as:

[source,java]
----
onException(Exception.class).handled(true).to("direct:error");

from("direct:error").loadBalance().roundRobin().id("round")
    .to("mock:error", "mock:error2", "mock:error3");
----

=== camel-cluster

The base support for cluster in `org.apache.camel.cluster` has been moved
out of `camel-core-engine` into separate JAR named `camel-cluster`.

=== Configuring milli seconds

NOTE: If upgrading to Camel 3.4 or newer then do NOT do this because Camel 3.4 adds back support for this.

Camel was using a type converter from `String` -> `long` that accepted
a time pattern which allowed to configure long values such as `2s` for 2 seconds, e.g. `2000`.
And more complex such as `8h15m` for 8 hours and 15 minutes.

However as this was implemented as part of `String` -> `long` type conversion
which then adds a little bit of overhead during routing, when converting from String to plain numbers.

To make Camel routing engine as fast as possible this feature has been removed.

For example a timer with a 5 second period

[source,java]
----
from("timer:foo?period=5s")
----

Should now be specified as numeric only:

[source,java]
----
from("timer:foo?period=5000")
----

=== Main in camel-spring

The `org.apache.camel.spring.Main` class has been moved out of `camel-spring` JAR into its own
JAR named `camel-spring-main`.

=== Main in camel-test-blueprint

The `org.apache.camel.test.blueprint.Main` class has been renamed to `org.apache.camel.test.blueprint.Main`
and moved into its own `camel-test-blueprint` JAR.

To use the camel-maven-plugin goal `camel:run` with OSGi plugin, you now need to add the following dependency
to the classpath `org.apache.camel.karaf:camel-blueprint-main`.

=== API changes

==== DefaultComponent

The deprecated method `preProcessUri` has been removed.

==== CamelContext

The method `getEndpoint` now throws `NoSuchEndpointException` directly instead of being wrapped
within an `FailedToResolveEndpoint`.

==== JavaUuidGenerator

The `org.apache.camel.impl.engine.JavaUuidGenerator` class has been removed.
Its a very slow UUID generator and its not recommended to be used.

==== PropertiesComponent

The `org.apache.camel.component.properties.PropertiesFunction` has been moved to `org.apache.camel.spi.PropertiesFunction`
and its now possible to add custom functions on the `org.apache.camel.spi.PropertiesComponent` interface.

====  JMX Connector configuration removed

The JMX Connector configuration in camel-management has been https://issues.apache.org/jira/browse/CAMEL-14811[removed]
in Camel 3.2.0. If you want to support the ability to use JMX with Camel remotely, then
just use the default JVM JMX remote capabilities. For example, use the following (insecure)
JVM settings to be able to manage Camel remotely on localhost, port 9913:

[source]
----
-Dcom.sun.management.jmxremote.port=9913
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false
-Djava.rmi.server.hostname=localhost
----

= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example, if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.20.6 to 3.20.7

The option `replyTimeout` in `camel-spring-rabbitmq` has been fixed and the default value from 5 to 30 seconds
(this is the default used by Spring).

In `camel-jbang` the _Placeholders substitutes_ is changed to use `#name` instead of `$name` syntax.

== Upgrading Camel 3.20.5 to 3.20.6

No changes

== Upgrading Camel 3.20.4 to 3.20.5

In Camel JBang the `-dir` parameter for `init` and `run` goal has been renamed to require 2 dashes `--dir` like all the other options.

== Upgrading Camel 3.20.3 to 3.20.4

No changes

== Upgrading Camel 3.20.2 to 3.20.3

The option `backlogTracing=true` now automatic enabled the tracer on startup. The previous behavior
was _surprisingly_ that the tracer was only made available, and had to be manually enabled afterwards.
The old behavior can be archived by setting `backlogTracingStandby=true`.

The xref:backlog-tracer.adoc[Backlog Tracer] has been enhanced and _fixed_ to trace message headers (also streaming types).
This means that previously headers of type `InputStream` was not traced before, but is now included. This could mean that
the header stream is positioned at the end, and logging the header afterward may appear as the header value is empty.

=== camel-micrometer-starter

The `uri` tags are now static instead of dynamic (by default), as potential too many tags generated due to URI with dynamic values.
This can be enabled again by setting `camel.metrics.uriTagDynamic=true`.

== Upgrading Camel 3.20.1 to 3.20.2

No changes

== Upgrading Camel 3.20.0 to 3.20.1

=== XML DSL

A route now have `<routeProperty>` in the top instead of the bottom.

=== YAML DSL

Using _allowable values_ in Rest with YAML DSL is fixed to use the correct name as other DSLs.

Before:

[source,yaml]
----
    value:
    - available
    - pending
    - sold
----

After:

[source,yaml]
----
    allowableValues:
    - available
    - pending
    - sold
----

=== camel-fhir

The following 4 advanced options in fhir data format has been made available for all DSLs:

- fhirContext
- parserErrorHandler
- parserOptions
- forceResourceId

Previously they were only possible to configure by manually creating a bean instance of the model,
and configure them via Java code or classic Spring XML `<bean>` style.

=== camel-kafka

The following options have changed default value as they were mistakenly out of sync with Apache Kafka.
This caused camel-kafka producer to not enable idempotence out of the box, that otherwise plain Apache Kafka client would do:

- `enableIdempotence`: changed from `false` to `true`
- `requestRequiredAcks`: changed from `1` to `all`
- `retries`: changed from `0` to `_unset_`

== Upgrading Camel 3.19 to 3.20

=== camel-api

The `org.apache.camel.support.jsse.SSLContextParameters` is now using `ResourceLoader` from `CamelContext`
to load keystore and other resources in a standard way. Therefore, the `SSLContextParameters` now must have been pre-configured
with a `CamelContext` otherwise an exception is thrown. This also changes the default resource type from file to classpath.
If using a file resource for a keystore and the keystore is not found, or entries/aliases aren't found, try explicitly
specifying the file resource type, .e.g `file:myKeystore.jks`.

The model class `org.apache.camel.model.errorhandler.ErrorHandlerRefDefinition`
has been renamed to `org.apache.camel.model.errorhandler.RefErrorHandlerDefinition`.

== camel-bom

The `camel-bom` BOM no longer includes dependencies with `<type>test-jar</type>` as these are for internal testing
of the Apache Camel project.

The following Maven Plugins has been fixed to use correct GAV:

- camel-debezium-maven-plugin
- camel-salesforce-maven-plugin
- camel-servicenow-maven-plugin

from `<groupdId>org.apache.camel</groupdId>` to `<groupdId>org.apache.camel.maven</groupdId>`.

Dependencies not intended for end users has been removed, such as all `-parent` JARs.

=== camel-base64

The `base64` property placeholder function will now look up the value as a property key.
For example

[source,text]
----
{{base64:myKey}}
----

Will now look up myKey as a property placeholder value, which then is decoded.
If you want to decode the value as-is, then use `base64:decode:` as shown below:

[source,text]
----
{{base64:decode:Q2FtZWw==}}
----

=== camel-log

The log component now shows cached streams (`org.apache.camel.StreamCache`) message bodies by default.
Camel comes with stream caching enabled out-of-the-box, and therefore using the log component you would
expect to see the message body. Setting `showCachedStreams=false` to use old behaviour.

The log component now does not show MEP by default. You can turn this on by `showExchangePattern=true`.

=== camel-jsonpath

There is a new option `unpackArray` that unpacks a single-element Json array, matched by a Jsonpath, into an object. This option is disabled by default (this behaviour was enabled by default in previous Camel versions). There is a new expression `jsonpathUnpack(String text, Class<?> resultType)` that makes use of this new option.

=== camel-yaml-dsl

The `error-handler` has been refactored to be aligned with `errorHandler` from the `camel-core-model` DSL, meaning
that it is now the same, how error handlers are in other DSLs.

- `none` is now called `no-error-handler`
- `log` has been removed, as you can use `dead-letter-channel` with a log endpoint as the `dead-letter-uri`.
- `ref` is now `ref-error-handler`.

=== camel-mongodb

The Mongodb Driver core has been updated to version 4.8.1

This fully supports MongoDB 6.1

=== camel-google-pubsub

The Camel Google Pubsub headers have been renamed, since dotted keys are not allowed. 

This means all the headers will be "CamelGooglePubsub" prefixed instead of "CamelGooglePubsub."

For more information, have a look at CAMEL-18773

= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example, if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.21 to 3.21.3

=== camel-kafka

The behavior for `breakOnFirstError` was altered as numerous issues were fixed. The behavior related to committing 
the offset is now determined by the `CommitManager` that is configured. 

When the default `CommitManager` is used (`NoopCommitManager`) then no commit is performed. The route implementation will
be responsible for managing the offset using `KafkaManualCommit` to manage the retrying of the payload.

When using the `SyncCommitManager` then the offset will be committed so that the payload is continually retried. This was
the behavior described in the documentation.

When using the `AsyncCommitManager` then the offset will be committed so that the payload is continually retried. This was
the behavior described in the documentation.

== Upgrading Camel 3.20 to 3.21

=== camel-core

XML parsers & XML transformers has been made more secure by disabling DOCTYPE and/or access to external DTD/Schema.

The `org.apache.camel.support.EventNotifierSupport` abstract class now implements `CamelContextAware`.

==== Tracing

The xref:tracer.adoc[Tracer] and xref:backlog-tracer.adoc[Backlog Tracer] no longer includes internal tracing events
from routes that was created by Rest DSL or route templates or Kamelets. You can turn this on, by setting
`traceTemplates=true` in the tracer.

The xref:backlog-tracer.adoc[Backlog Tracer] has been enhanced and _fixed_ to trace message headers (also streaming types).
This means that previously headers of type `InputStream` was not traced before, but is now included. This could mean that
the header stream is positioned at end, and logging the header afterward, may appear as the header value is empty.

==== UseOriginalMessage / UseOriginalBody

When `useOriginalMessage` or `useOriginalBody` is enabled in `OnException`, `OnCompletion` or error handlers,
then the original message body is defensively copied and if possible converted to `StreamCache` to ensure
the body can be re-read when accessed. Previously the original body was not converted to `StreamCache` which
could lead to the body not able to be read or the stream has been closed.

=== camel-console

The class `org.apache.camel.impl.console.AbstractDevConsole` has moved from `camel-console` to `camel-support`
and moved to package `org.apache.camel.support.console.AbstractDevConsole`.

Component developers that has plugins for Camel Developer Console, should just use
`camel-support` and `camel-util-json` as dependencies,
and then extend `AbstractDevConsole` for custom console implementations.

=== camel-health

The `org.apache.camel.health.HealthCheck` method `isLiveness` is now default `false` instead of `true`.

Camel provides the `CamelContextCheck` as both readiness and liveness checks, so there is at least
one of each out of the box.

=== camel-main

The option `camel.main.routesReloadRestartDuration` has changed its default value from `true` to `false`.

=== camel-micrometer

The metrics has been renamed to follow Micrometer naming convention https://micrometer.io/docs/concepts#_naming_meters[Naming Meters].

|===
| Old Name | New Name
| CamelExchangeEventNotifier | camel.exchange.event.notifier
| CamelExchangesFailed | camel.exchanges.failed
| CamelExchangesFailuresHandled | camel.exchanges.failures.handled
| CamelExchangesInflight | camel.exchanges.external.redeliveries
| CamelExchangesSucceeded | camel.exchanges.succeeded
| CamelExchangesTotal | camel.exchanges.total
| CamelMessageHistory | camel.message.history
| CamelRoutePolicy | camel.route.policy
| CamelRoutePolicyLongTask | camel.route.policy.long.task
| CamelRoutesAdded | camel.routes.added
| CamelRoutesRunning | camel.routes.running
|===

=== camel-http-common

The API in `org.apache.camel.http.common.HttpBinding` has changed slightly to be more reusable.
The `parseBody` method now takes in `HttpServletRequest` as input parameter. And all `HttpMessage`
has been changed to generic `Message` types.

=== camel-jaxb

When using schema validation, then access to external DTD/Schema is disabled by default.
To enable access, then set `accessExternalSchemaProtocols=all` or specify allowed protocols, such as
`accessExternalSchemaProtocols=file`.

=== camel-platform-http-vertx

If the route or consumer is suspended, then http status 503 is now returned instead of 404.

=== camel-spring-rabbitmq

The option `replyTimeout` in `camel-spring-rabbitmq` has been fixed and the default value from 5 to 30 seconds
(this is the default used by Spring).

=== camel-stax

XML parser in `StAXJAXBIteratorExpression` has been made more secure by disabling DOCTYPE and/or access to external DTD/Schema.

=== camel-cm-sms

XML parsers have been made more secure by disabling `DOCTYPE` and/or access to external DTD/Schema.

=== camel-schematron

XML parsers have been made more secure by disabling `DOCTYPE` and/or access to external DTD/Schema.

=== camel-xmlsecurity

XML parsers have been made more secure by disabling `DOCTYPE` and/or access to external DTD/Schema.

=== camel-jbang

The command `camel dependencies` has been renamed to `camel dependency`.

In Camel JBang the `-dir` parameter for `init` and `run` goal has been renamed to require 2 dashes `--dir` like all the other options.

The _Placeholders substitutes_ is changed to use `#name` instead of `$name` syntax.

=== camel-java-joor-dsl

The `camel-java-joor-dsl` cannot anymore load routes defined in class files as we consider it no more needed, consequently the ability to configure the compile directory and the compile load first flag using the corresponding `camel-main` properties is no longer possible.

=== camel-elasticsearch

The `certificatePath` parameter can now be specified as resource: for user pointing to a local certificate, the file should be now prefixed with `file:`. It's also possible to use the classic resource helper prefixes, like `classpath`, `https` etc.

=== camel-rest

The deprecated option `componentName` was removed. Please use either `producerComponentName` or `consumerComponentName`.

=== Deprecated Components

The following components that had been marked as deprecated, were removed in this release:

* camel-dozer
* camel-cmis
* camel-vertx-kafka

=== Backlog Tracing

The option `backlogTracing=true` now automatic enabled the tracer on startup. The previous behavior
was _surprisingly_ that the tracer was only made available, and had to be manually enabled afterwards.
The old behavior can be archived by setting `backlogTracingStandby=true`.

Move the following class from `org.apache.camel.api.management.mbean.BacklogTracerEventMessage` in `camel-management-api` JAR
to `org.apache.camel.spi.BacklogTracerEventMessage` in `camel-api` JAR.


== Camel Spring Boot

The `camel-spring-boot` dependency no longer includes `camel-spring-xml`. To use legacy Spring XML files `<beans>`
with Camel on Spring Boot, then include the `camel-spring-boot-xml-starter` dependency.

=== Health Check

The health-check has aligned to be more similar to microprofile-health in the JSon output.
Spring Boot now also includes additional data per check, when using full exposure level.

For example, as shown below for the context health check:

[source,json]
----
{
  "status": "UP",
  "components": {
    "camelHealth": {
      "status": "UP",
      "details": {
        "name": "camel-health-check",
        "context": "UP",
        "context.data": {
          "invocation.count": "1",
          "context.phase": "5",
          "invocation.time": "2022-12-21T09:12:03.307871+01:00[Europe/Oslo]",
          "check.group": "camel",
          "context.name": "MyCamel",
          "success.time": "2022-12-21T09:12:03.307871+01:00[Europe/Oslo]",
          "success.count": "1",
          "check.id": "context",
          "context.version": "3.21.0",
          "context.status": "Started",
          "success.start.time": "2022-12-21T09:12:03.307871+01:00[Europe/Oslo]",
          "check.kind": "READINESS",
          "failure.count": "0"
        }
      }
    }
  }
}
----

=== camel-micrometer-starter

The `uri` tags are now static instead of dynamic (by default), as potential too many tags generated due to URI with dynamic values.
This can be enabled again by setting `camel.metrics.uriTagDynamic=true`.

=== camel-platform-http-starter

If the route or consumer is suspended, then http status 503 is now returned instead of 404.

The `platform-http-starter` has been changed from using `camel-servlet` to use Spring HTTP server directly.
Therefore, all the HTTP endpoints are no longer prefixed with the servlet context-path (default is `camel`).

For example:

[source,java]
----
from("platform-http:myservice")
  .to("...")
----

Then calling `_myservice_` would before require including the context-path, such as `http://localhost:8080/camel/myservice`.
Now the context-path is not in use, and the endpoint can be called with `http://localhost:8080/myservice`.

NOTE: The `platform-http-starter` can also be used with Rest DSL.
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example, if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.21 to 3.22

No changes expected.

== Upgrading Camel 3.22.x to 3.22.3

=== camel-file

The `readLock=changed` with using `readLockMinAge` has been restored to same behaviour as previously in 3.x.

For example, using `readLockMinAge=5s` would pickup files that are older than 5 seconds from startup time.
If you have many existing files on startup that are old, then Camel will now again be fast,
and pick up these files immediately.

= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.2 to 3.3

=== camel-jackson

The dependency on `jackson-module-jaxb-annotations` and the option `enableJaxbAnnotationModule` have been removed. To
enable support for JAXB annotations, users have to:

* explicit add `jackson-module-jaxb-annotations`
* configure the `JacksonDataFormat` and/or the `JacksonTypeConverters` module classes, example:
+
.JacksonDataFormat
[source,java]
----
JacksonDataFormat formatPojo = new JacksonDataFormat(TestJAXBPojo.class);
formatPojo.setModuleClassNames(JaxbAnnotationModule.class.getName());
----
+
.JacksonTypeConverters
[source,java]
----
context.getGlobalOptions().put(JacksonConstants.ENABLE_TYPE_CONVERTER, "true");
context.getGlobalOptions().put(JacksonConstants.TYPE_CONVERTER_TO_POJO, "true");
context.getGlobalOptions().put(JacksonConstants.TYPE_CONVERTER_MODULE_CLASS_NAMES, JaxbAnnotationModule.class.getName());
----

this change affects also the Java DSL and as consequence the `enableJaxbAnnotationModule` option for the Json 
DataFormat definition has been removed.

=== Template components

The template components which supports using a header to specify a dynamic resource to use as template, instead
of the configured template on the endpoint is now enabled out of the box. If you want to use this feature then
you must turn on `allowTemplateFromHeader=true` on either the endpoint or component level.

This applies to the following templating components: camel-freemarker, camel-velocity, camel-mvel, camel-mustache,
camel-string-template, camel-chunk, camel-jolt, camel-jslt, camel-robotframework.

=== SupervisingRouteController

The `SupervisingRouteController` has been refactored and its configuration has been simplified.
And when configuring from spring boot, then the auto configuration parameters has
been changed from `camel.supervising.controller` into the general `camel.springboot` which
allows to share the same configuration across runtimes so its the same in Spring Boot, Camel Main,
Camel K, Camel Quarkus, etc.

=== Camel Karaf

The following components is no longer supported in OSGi and has been removed from the Camel Karaf features file:
camel-undertow, camel-jgroups, camel-jgroups-raft, camel-infinspan.

=== camel-maven-plugin

The `embedded` goal has been removed (was never really in use). Use `run` goal instead.

=== API changes

The dump model classes in package `org.apache.camel.support.dump` has been removed
as they were not in use by Camel.

In relation to the dump model classes removal, in camel-karaf the following commands were removed: `context-info`, `route-info`, `route-profile` and `route-step`.

=== camel-main

The following methods have been https://issues.apache.org/jira/browse/CAMEL-15005[relocated] from `org.apache.camel.main.BaseMainSupport` to `org.apache.camel.main.MainConfigurationProperties`:

- getConfigurationClasses
- setConfigurationClasses
- addConfigurationClass
- addConfiguration
- getConfigurations
- setConfigurations
- getRouteBuilderClasses
- setRouteBuilderClasses
- getRouteBuilders
- getRoutesBuilders
- setRoutesBuilders
- addRoutesBuilder

This means that as example, the following snippet:

[source,java]
----
Main main = new Main();
main.addRoutesBuilder(....)
----

Should become

[source,java]
----
Main main = new Main();
main.configure().addRoutesBuilder(....)
----

See https://issues.apache.org/jira/browse/CAMEL-15005


= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.3 to 3.4

=== camel-test and JMX

The `camel-test` module no longer has dependency on `camel-management` out of the box.
In Camel JMX is optional and to use JMX then `camel-management` must be added as dependency.

For example to use JMX during testing you the following dependency as test scope:

[source,xml]
----
<dependency>
    <groupId>org.apache.camel</groupId>
    <artifactId>camel-management</artifactId>
    <scope>test</scope>
</dependency>
----

=== Health Check

The default health check implementation has been moved out of `camel-base` into `camel-health` as a separate module.
The health check has been refactored and there are some APIs and classes that has been changed.
The health check in `camel-consul` has been removed.

The old health check was not fully implemented and was only targeting Spring Boot.
The new system is more generic and supports all Camel runtimes.

An example is provided in `camel-example-main-health`.

=== Template components

The template components which allows access to the current `Exchange` and `CamelContext` API
from the context map available for templating has now been restricted to only the message body and headers.

This option can be enabled (`allowContextMapAll=true`) for full access to the current Exchange and CamelContext.
Doing so impose a potential security risk as this opens access to the full power of CamelContext API.

This applies to the following templating components: camel-freemarker, camel-velocity, camel-mvel, camel-mustache,
camel-string-template, camel-chunk, camel-robotframework.

=== Using custom language in RouteBuilder

The Java DSL `RouteBuilder` allows referring to a custom language as shown below:

[source,java]
----
from("direct:start")
    .filter(language("foo", "Bla bla bla"))
      .to("mock:camel");
----

This functionality is seldom in use, as you would use the provided languages from Camel.
If using, then the `language` method now requires a static import as shown below:

[source,java]
----
import static org.apache.camel.builder.Builder.language;
----

=== Using custom type converters

If you are using custom type converters, you can now generate loader classes and have Camel discover them automatically. To generate loader class, Change  `@Converter` to `@Converter(generateLoader = true)` at class level and implement maven plugin as described in xref:camel-component-maven-plugin.adoc[here].

If a loader class is not to be used, Camel needs to be instructed to scan for custom converters. This can be done as shown:

[source,java]
----
context.setLoadTypeConverters(true);
----

And in XML:
[source,xml]
----
<camelContext loadTypeConverters="true">

</camelContext>
----

If you are using Camel on Spring Boot, Quarkus or via Camel Main this can also be configured in the `application.properties`:
[source,properties]
----
camel.main.loadTypeConverters=true
----

=== camel-spring-boot

The `/actuator/camelroutes` HTTP endpoint has been removed from provided Spring Boot actuators in `camel-spring-boot`.
This actuator was becoming problematic to maintain during Spring Boot upgrades due to changes in Spring Boot.

=== camel-servlet and camel-http-common

`HttpRegistry` and `DefaultHttpRegistry` classes from camel-servlet are moved from camel-servlet into camel-http-common.
`HttpRegistryProvider` is added and used in `DefaultHttpRegistry` instead of `CamelServlet`.

These changes had effects on camel-atmosphere-websocket and camel-servlet and also camel-resteasy.
Users of these components where they would have custom implemetations on `DefaultHttpRegistry` and using `CamelServlet` class should take this change into account.

=== camel-sql

The `JdbcAggregationRepository` optimistic locking feature has been fixed to work on a distributed environment and every database.
There is a new `version` column that is required and must be added to the repository:

[source,sql]
----
CREATE TABLE aggregation (
 id varchar(255) NOT NULL,
 exchange blob NOT NULL,
 version BIGINT NOT NULL,
 constraint aggregation_pk PRIMARY KEY (id)
);
CREATE TABLE aggregation_completed (
 id varchar(255) NOT NULL,
 exchange blob NOT NULL,
 version BIGINT NOT NULL,
 constraint aggregation_completed_pk PRIMARY KEY (id)
);
----

=== Thread Pool default changed

The thread pools managed and created by Camels 'ExecutorServiceManager' or `ThreadPoolFactory` is now set to default created thread pools
with `allowCoreThreadTimeOut=true`. This means that the thread pool can shrink and terminate also the core threads if the pool is idle.

In older versions this was `allowCoreThreadTimeOut=false` and the default core size was 10, which means thread pools would typically have 10 threads as minimum.
With this change those thread pools can shrink to lower value when core threads become idle as well.

=== camel-lra-starter

The Spring Boot LRA starter component have changed its auto configuration keys to be similar to using camel-lra with camel-main or camel-quarkus.
Change the keys from `camel.service.lra` to `camel.lra`, eg `camel.service.lra.coordinator-url` to `camel.lra.coordinator-url`.

=== Maven Archetypes

The `camel-archetype-java8` has been removed, as you can just use `camel-archetype-java` instead.

=== Maven Plugins

A new maven plugin called `camel-component-maven-plugin` has been added which intents to help third party component developers to generate all required metadata and configurations Java files. For more info on how to use it in your project, please take a look at plugin's documentation xref:camel-component-maven-plugin.adoc[here].

=== Camel-Kafka

From a lot of time, the headerFilterStrategy application in consumer and producer was done in an interchanged way.
You need to have a look at the following issue for more information: https://issues.apache.org/jira/browse/CAMEL-15121

=== Camel-Karaf

Removed `camel-hdfs` and `camel-pulsar` Karaf features.
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.4 to 3.5

=== FluentProducerTemplate

The template will now automatic clear its state when sending the message, this avoids end users having to call `clearAll` after usage,
in case the template should be reused to send other messages.

After the template has been started / used the first time, then its general configuration cannot be altered later,
instead create a new template.

=== PackageScanClassResolver

The `PackageScanClassResolver` will now skip abstract classes in its `findImplementations` method.

=== camel-bean

The `bean(class)` EIP will now lookup in the registry first whether there is a single bean instance of the given class type
and use the existing bean (for singleton scope) instead of creating a new instance.

=== camel-cassandraql

Load-balancing policy has changed. There are no existing load balancing policies (see https://docs.datastax.com/en/developer/java-driver/4.3/upgrade_guide/#load-balancing-policy[upgrade guide]).
To customize load balancing policy, please use the parameter `loadBalancingPolicyClass` and provide own implementation
of load balancing policy.

Session impelentation class has changed from `com.datastax.driver.core.Session` to
`com.datastax.oss.driver.api.core.CqlSession` (see https://docs.datastax.com/en/developer/java-driver/4.3/upgrade_guide/#session[upgrade guide]).
This could have direct impact on the type of parameter `beanRef` if you are using `Provided Session reference`.

There is a new parameter `datacenter` (with default value `datacenter1`). Data center has to be defined for the proper
behavior of the default load balancing policy.

=== camel-sjms

The default value for `keepAliveDelay` was changed from `-1` to `5000` in the batch jms consumer.

=== camel-weather

The option `httpClient` is now a query parameter.

A new parameter `geoLocationProvider` was introduced to allow the use of a custom `GeolocationProvider` implementation.

=== Camel Karaf

The following feature has been removed due to no longer being compatible with OSGi: `camel-couchbase`.

=== LifecycleStrategy

The `LifecycleStrategy` has been enhanced and provides some additional methods and changes in the behavior:

* **onContextInitializing**: is invoked when the context is about to be initialized, this was previopusly achieved by `onContextInitialized` but as the name was a misleading
* **onContextInitialized**: is now invoked when the context is initialized
* **onContextStarting**: is invoked when the context is about to start, this was previously achieved by the `onContextStart` which is now deprecated.
* **onContextStarted**: is now invoked when the context is started
* **onContextStopping**: is invoked when the context is about to be stopped, this was previously achieved by the `onContextStop` which is now deprecated.
* **onContextStop**: is now invoked when the context is stopped

=== JUnit 5 testing

Camel has been migrated from JUnit 4 to JUnit 5 as our default testing in all the components.
The new test components reflect this with the following JAR names:

- camel-test-junit5
- camel-test-spring-junit5
- camel-testcontainers-junit5
- camel-testcontainers-spring-junit5

The older test components supports only JUnit 4.

=== Spring Boot testing with JUnit 5

Testing Camel on Spring Boot with JUnit 5 have also changed slightly to use JUnit 5 APIs and testing style.

The following set of dependencies can be used:

[source,xml]
----
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.apache.camel</groupId>
    <artifactId>camel-test-spring-junit5</artifactId>
    <scope>test</scope>
</dependency>
----

Then in your test classes you should annotate the Spring Boot test class with the new `@CamelSpringBootTest`
(from package `org.apache.camel.test.spring.junit5.CamelSpringBootTest` in camel-test-spring-junit5 JAR)
annotation as shown:

[source,java]
----
@CamelSpringBootTest
@SpringBootTest(classes = MyCamelApplication.class)
public class MyCamelApplicationJUnit5Test {

    @Autowired
    private CamelContext camelContext;

    @Test
    public void shouldProduceMessages() throws Exception {
        // here you can write your unit test
    }

}
----
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.5 to 3.6

=== UUID Generator

The default UUID Generator in Camel has switched to a faster algorithm based on UUID that were used by Camel Quarkus and Camel K.
This generator does not use the hostname as part of the ID generation and avoids any network IO calls during initialization.

The old generator has been renamed and moved into a new package at `org.apache.camel.support.ClassicUuidGenerator`.
The new default generator is now also located in camel-support as `org.apache.camel.support.DefaultUuidGenerator`
where all the out of the box generators reside.

Users that want to use the old UUID generator can configure Camel to use `org.apache.camel.support.ClassicUuidGenerator`
as the generator.

=== Simple language

The simple language have been optimized to handle numeric and boolean values more naturally.
We have also optimized for unneeded type conversions in predicates such as comparing left and right hand side in operators
with their given type as-is, or the least amount of conversion when possible.

The `contains` and `not contains` operator now handles numerics naturally. For example `${header.numbers} contains '123,456'`
would return `false` if the numbers header has the value `-123`, as the operator now compares numerically. Previously it
would compare with String based values.

=== Bean component

We have now implemented bean scope (singleton, request, and prototype) for all kinds of using the bean component, whether
it's the bean endpoint, bean language (method call), bean EIP, or the bean function in the simple language (eg `${bean:foo}`).

The default scope is now singleton. Previously the bean function in simple language would be prototype scope (always lookup the bean on each use).
With singleton scope we improve the performance by avoiding the repetitive lookup of the same bean on each usage.

You can use the old behaviour by setting the scope to prototype.

=== API components upgrade

The `camel-braintree`, `camel-twilio` and `camel-zendesk` has updated to newer versions and regenerated their API
signatures in the Camel components which changed a few existing API methods and adding new API methods as well.

=== API components overhauled

The following API component has been overhauled, by having a new Java source parser to inspect API and fully generate
Camel endpoint configuration and documentation gathered from javadoc.

The components affected are:

- camel-as2
- camel-box
- camel-braintree
- camel-fhir
- camel-google-calendar
- camel-google-drive
- camel-google-email
- camel-google-sheets
- camel-olingo2
- camel-olingo4
- camel-twilio
- camel-zendesk

=== Languages

All the out of the box supported languages (simple, bean, groovy, jsonpath, xpath etc.) have been optmized to be _singleton_
which improves performance for concurrent processing that uses those languages that would be resolved on each use.
Now the languages are resolved once during startup or first usage.

=== Expressions

Expressions built via `ExpressionBuilder` and similar now often require to be initialized by calling `init` before use.
This is part of an effort to optimize Camel to eager initialize its expression and languages.
This only impacts Camel end users whom use the `ExpressionBuilder` directly.
Normal usage of Camel should not be impacted by this change.

=== Customizers

Customizers, which are objects used to configure some of the Camel services such as component, language and data formats, that were previously limited to Camel Spring Boot, are now consistently used across runtimes.
To make that possible, the interfaces have been changed and they do not use generics anymore.

Impacted interfaces:

* org.apache.camel.spi.ComponentCustomizer
* org.apache.camel.spi.LanguageCustomizer
* org.apache.camel.spi.DataFormatCustomizer

As example the signature of the `ComponentCustomizer` interface in Camel 3.5 is:

[source,java]
----
@FunctionalInterface
public interface ComponentCustomizer<T extends Component> {
    /**
     * Customize the specified {@link Component}.
     *
     * @param component the component to customize
     */
    void customize(T component);
}
----

And below the Camel 3.6 version:

[source,java]
----
@FunctionalInterface
public interface ComponentCustomizer {
    /**
     * Customize the specified {@link Component}.
     *
     * @param name   the unique name of the component
     * @param target the component to configure
     */
    void configure(String name, Component target);

    /**
     * Checks whether this customizer should be applied to the given {@link Component}.
     *
     * @param  name   the unique name of the component
     * @param  target the component to configure
     * @return        <tt>true</tt> if the customizer should be applied
     */
    default boolean isEnabled(String name, Component target) {
        return true;
    }

    @Override
    default int getOrder() {
        return 0;
    }
}
----

As the customizers are now taken into account as part of the standard lifecycle of the `CamelContext`, to programmatically configure a component, it is enough to register the appropriate customizer in the `Registry`. For example:

[source,java]
----
public class Application {

    public static void main(String args) throws Exception {
        Main main = new Main();
        main.addConfigurationClass(MyConfiguration.class);
        main.run(args);
    }

    public static class MyConfiguration {
        @BindToRegistry
        public ComponentCustomizer logCustomizer() {
            // Use a fluent Component Customizer builder to ease the process of creating an customizer.
            return ComponentCustomizer.builder(LogComponent.class)
                    .build(component -> component.setExchangeFormatter(new DefaultExchangeFormatter()));
        }
    }
}
----

[NOTE]
====
As a consequence of this change, the Camel Spring Boot starters have been amended to use Customizers instead of creating instances of components, languages or data formats.
====

=== Component Verifiers

Camel components which provides `ComponentVerifierExtension` should have `camel-core-catalog` added as dependency at runtime, if the verifier are in use.
You will see an exception about `camel-core-catalog` not found on classpath otherwise.

=== SendDynamicAware

The API in `org.apache.camel.spi.SendDynamicAware` has changed and any custom implementations must be updated accordingly.
There is a new abstract `org.apache.camel.support.component.SendDynamicAwareSupport` class which can be used as base for custom implementations.

=== Stream Caching

If stream caching is enabled and an exception is thrown while converting the message payload to `StreamCache` then the error handler
can now handle this exception (e.g. `onException`). The exception is regarded as non-recoverable and redelivery is not in use.

=== Camel Caffeine

To configure the component to use a pre-configured cache, it is no longer required to use the now removed `cache` option as the component performs a look-up in the registry based on the `cacheName` URI param.

For example, the following code:

[source,java]
----
.to("caffeine-cache://cache?cache=#myCache&action=PUT&key=1")
----

Should be replaced by:

[source,java]
----
.to("caffeine-cache://myCache?action=PUT&key=1")
----

=== Camel Karaf

The following feature has been removed due to being no longer compatible with OSGi: `camel-atmosphere-websocket`.

=== CamelFileDataSource

The class `CamelFileDataSource` has moved from `camel-http-common` package `org.apache.camel.http.common` to `camel-attachments` package `org.apache.camel.attachment`.

If your code directly depends on this class, you will need to update the package reference to the new location.

=== Message History

When message history is enabled then there is a slight performance overhead as the history data is now stored
in a `java.util.concurrent.CopyOnWriteArrayList` due to the need of being thread safe.

=== Default limit set on decompressed file size

From Apache Camel 3.6.0, a default limit is enforced on the maximum size of a decompressed file, to prevent possible denial of service attacks.
This applies to the camel-zipfile and camel-tarfile data formats. This can be configured as follows:

[source,java]
----
ZipFileDataFormat maxDecompressedSizeZip = new ZipFileDataFormat();
maxDecompressedSizeZip.setMaxDecompressedSize(100000000000L);

.unmarshal(maxDecompressedSizeZip)
----

The default value if not specified corresponds to one gigabyte. An `IOException` will be thrown if the decompressed size exceeds this amount.
Set to `-1` to disable setting a maximum decompressed size.

=== Camel RabbitMQ

The `camel-rabbitmq` server component properties have been changed. The properties prefix `rabbitmq.` was replaced by `CamelRabbitmq`.

=== Camel-Slack

The options username, iconUrl and iconEmoji have been deprecated and they will be removed in 3.7.0.

=== Camel-Hipchat

This component has been removed.
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example, if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.6 to 3.7

=== Modularized core

The core has been further modularized and is now split up into three new core modules:

- camel-core-model
- camel-core-reifier
- camel-core-processor

This separates the route model from the runtime processors via the reifiers, by having the classes in their own modules.

=== API changes

The class `BreakpointSupport` has moved from `org/apache/camel/processor/interceptor/BreakpointSupport` to `org.apache.camel.support.BreakpointSupport`.

The following internal classes have been moved to locations that better suit where other similar processors are located:

The class `org.apache.camel.impl.validator.ProcessorValidator` moved to `org.apache.camel.processor.validator.ProcessorValidator`.
The class `org.apache.camel.impl.transformer.ProcessorTransformer` moved to `org.apache.camel.processor.transformer.ProcessorTransformer`.
The class `org.apache.camel.impl.transformer.DataFormatTransformer` moved to `org.apache.camel.processor.transformer.DataFormatTransformer`.
The class `org.apache.camel.impl.validator.ValidatorKey` moved to `org.apache.camel.impl.engine.ValidatorKey`.
The class `org.apache.camel.impl.transformer.TransformerKey` moved to `org.apache.camel.impl.engine.TransformerKey`.

The class `org.apache.camel.impl.DefaultExecutorServiceManager` was moved from `camel-core-engine` JAR to
`org.apache.camel.impl.engine.DefaultExecutorServiceManager` in the `camel-base` JAR.

The class `org.apache.camel.processor.ConvertBodyProcessor` was moved
to `org.apache.camel.support.ConvertBodyProcessor` in the `camel-support` JAR.

The class `org.apache.camel.impl.engine.DefaultClaimCheckRepository` moved
to `org.apache.camel.processor.DefaultClaimCheckRepository` in the `camel-core-processor` JAR.

The class `org.apache.camel.impl.engine.DefaultProducerCache` was moved to `org.apache.camel.support.cache.DefaultProducerCache`.
The class `org.apache.camel.impl.engine.DefaultConsumerCache` was moved to `org.apache.camel.support.cache.DefaultConsumerCache`.
The class `org.apache.camel.impl.engine.EmptyProducerCache` was moved to `org.apache.camel.support.cache.EmptyProducerCache`.
The class `org.apache.camel.impl.engine.ServicePool` was moved to `org.apache.camel.support.cache.ServicePool`.
The class `org.apache.camel.impl.engine.ProducerServicePool` was moved to `org.apache.camel.support.cache.ProducerServicePool`.
The class `org.apache.camel.impl.engine.PollingConsumerServicePool` was moved to `org.apache.camel.support.cache.PollingConsumerServicePool`.
The class `org.apache.camel.impl.engine.EventNotifierCallback` was moved to `org.apache.camel.support.cache.EventNotifierCallback`.

Two methods related to adding and removing error handlers were removed from the interface `org.apache.camel.spi.LifecycleStrategy`.

=== Type Converters

Camel 3.7 has optimized its type converter system, which can impact 3rd party components which contain type converters.
Previously, the type converter system would attempt to find a type converter that would be capable of
converting between two given types (also by walking up the parent classes and super interfaces).
But this leads to slower performance, and Camel now relies on there being converter methods with the exact combo
of converting from/to types.

==== Converting to milliseconds from text

When converting to milliseconds using the shorthands for time precision with hours, minutes and seconds, support
for fractions was removed. For example `delay=0.5m` (half minute) is no longer supported, use `delay=30s` instead.

Support for using units as `days`, `hours`, `minutes`, `seconds`, and `millis` has been removed.
Units must now be one of `d` for days, `h` for hours, `m` for minutes, `s` for seconds, and `ms` for millis (can be omitted).
So you can use `1h12m37s42ms` for 1 hour, 12 minutes, 37 seconds and 42 milliseconds.

=== JMX

The MBeans for error handlers have been removed.

=== ProcessorFactory

If a custom `org.apache.camel.spi.ProcessorFactory` is in use, the factory should extend the default implementation
`org.apache.camel.processor.DefaultProcessorFactory` and in the overridden methods, super should be called to let
the default implementation create the processor when no custom processors is created.

The class `org.apache.camel.impl.engine.TypedProcessorFactor` moved from `camel-base` JAR
to `org.apache.camel.support.TypedProcessorFactor` in the `camel-support` JAR.

=== AdviceWith

Advice routes moved the `adviceWith` method from `org.apache.camel.reifier.RouteReifier` to `org.apache.camel.builder.AdviceWith`.
Also `adviceWith` methods on `org.apache.camel.builder.AdviceWithRouteBuilder` are deprecated in favour
of using methods on `org.apache.camel.builder.AdviceWith`.

=== toD EIP

Support for using multiple languages in the toD EIP has been removed as it was a rarley used feature and was causing
problems for maintenance. `toD` uses simple language by default, but an alternative language can still be specified.

=== Components

The deprecated option `basicPropertyBinding` has been removed.

=== camel-couchbase

The original URI path has been changed, now the bucket part is simply a required option and it's not part of the URI anymore.

=== camel-file-watch

The event type header is no longer an enum, but it is now the explicit event as a `String` value.

=== camel-leveldb

Component uses a different serialization mechanism, which is not backwards compatible with the original one.
For full compatibility, use the camel-leveldb-legacy component (the legacy component will be removed in a future release).

=== camel-mock

The class `InterceptSendToMockEndpointStrategy` in `camel-base` JAR was moved from `org.apache.camel.impl.engine.InterceptSendToMockEndpointStrategy`
to `org.apache.camel.component.mock.InterceptSendToMockEndpointStrategy` in the `camel-mock` JAR.

=== camel-saga

The class `org.apache.camel.impl.saga.InMemorySagaService` was moved to `org.apache.camel.saga.InMemorySagaService`.
The class `org.apache.camel.impl.saga.InMemorySagaCoordinator` was moved to `org.apache.camel.saga.InMemorySagaCoordinator`.

=== camel-management

The `listTypeConverters` operation on `ManagedTypeConverterRegistryMBean` has been removed.

=== camel-kafka

We changed some option's naming because they were a bit misleading:

- From kafkaHeaderDeserializer to headerDeserializer
- From kafkaHeaderSerializer to headerSerializer
- From keySerializerClass to keySerializer
- From serializerClass to valueSerializer

For more information, have a look at CAMEL-15770

=== camel-git

The Camel Git Commit consumer has been changed a bit.

For each exchange now in the body, you'll get the commit full message as a String and the Commit Object like before.

Other information has been stored in headers declared in GitConstants class:

* `GIT_COMMIT_ID` - "CamelGitCommitId" - The commit Id
* `GIT_COMMIT_AUTHOR_NAME` - "CamelGitAuthorName" - The commit Author name
* `GIT_COMMIT_COMMITTER_NAME` - "CamelGitCommiterName" - The commit committer name
* `GIT_COMMIT_TIME` - "CamelGitCommitTime" - The commit time

The Camel Git Branch consumer has been changed a bit.

For each exchange now in the body, you'll get the branch ref name and not the full ref like before.

Other information has been stored in headers declared in `GitConstants` class:

* `GIT_BRANCH_LEAF` - "CamelGitBranchLeaf" - Leaf
* `GIT_BRANCH_OBJECT_ID` - "CamelGitBranchObjectId" - Object Id

The Camel Git Tag consumer has been changed a bit.

For each exchange now in the body, you'll get the tag ref name and not the full ref like before.

Other information has been stored in headers declared in GitConstants class:

* `GIT_TAG_LEAF` - "CamelGitTagLeaf" - Leaf
* `GIT_TAG_OBJECT_ID` - "CamelGitTagObjectId" - Object Id

=== camel-github

Login using username and password is no longer supported by GitHub and these options have been removed
(https://developer.github.com/changes/2020-02-14-deprecating-password-auth/).

Login must be done using the `oauthToken` option.

=== Camel-AWS2-S3 Autowire support

The camel-aws2-s3 component now has support for autowiring the `amazonS3Client` option with a `S3Client` instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-S3 UseIamCredentials

The option useIamCredentials has been renamed to `useDefaultCredentialsProvider`, since we changed to a `DefaultCredentialsProvider` approach.

=== Camel-AWS2-Cloudwatch Autowire support

The camel-aws2-cw component now has support for autowiring the `amazonCwClient` option with a CloudWatchClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-DDB Autowire support

The camel-aws2-ddb component now has support for autowiring the `amazonDDBClient` option with a DynamoDbClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

The camel-aws2-ddbstreams component now has support for autowiring the `amazonDynamoDbStreamsClient` option with a DynamoDbStreamsClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-EC2 Autowire support

The camel-aws2-ec2 component now has support for autowiring the `amazonEc2Client` option with an Ec2Client instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-ECS Autowire support

The camel-aws2-ecs component now has support for autowiring the `ecsClient` option with an EcsClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-EKS Autowire support

The camel-aws2-eks component now has support for autowiring the `eksClient` option with an EksClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-Eventbridge Autowire support

The camel-aws2-eventbridge component now has support for autowiring the `eventBridgeClient` option with an EventBridgeClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-IAM Autowire support

The camel-aws2-iam component now has support for autowiring the `iamClient` option with an IamClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-Kinesis Autowire support

The camel-aws2-kinesis component now has support for autowiring the `amazonKinesisClient` option with a KinesisClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

The camel-aws2-kinesis-firehose component now has support for autowiring the `amazonKinesisFirehoseClient` option with a FirehoseClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-KMS Autowire support

The camel-aws2-kms component now has support for autowiring the `awsLambdaClient` option with a LambdaClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-Lambda Autowire support

The camel-aws2-kms component now has support for autowiring the `kmsClient` option with a KmsClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-MQ Autowire support

The camel-aws2-mq component now has support for autowiring the `amazonMqClient` option with a MqClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-MSK Autowire support

The camel-aws2-msk component now has support for autowiring the `mskClient` option with a KafkaClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-SES Autowire support

The camel-aws2-ses component now has support for autowiring the `amazonSESClient` option with a SesClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-SNS Autowire support

The camel-aws2-sns component now has support for autowiring the `amazonSNSClient` option with a SnsClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-SNS UseIamCredentials

The option useIamCredentials has been renamed to `useDefaultCredentialsProvider`, since we changed to a DefaultCredentialsProvider approach.

=== Camel-AWS2-SQS Autowire support

The camel-aws2-sqs component now has support for autowiring the 1 `amazonSQSClient` option with a SqsClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-SQS UseIamCredentials

The option useIamCredentials has been renamed to `useDefaultCredentialsProvider`, since we changed to a `DefaultCredentialsProvider` approach.

=== Camel-AWS2-STS Autowire support

The camel-aws2-sts component now has support for autowiring the `stsClient` option with a StsClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-Translate Autowire support

The camel-aws2-translate component now has support for autowiring the `translateClient` option with a TranslateClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== Camel-AWS2-Athena Autowire support

The camel-aws2-athena component now has support for autowiring the `amazonAthenaClient` option with an AthenaClient instance coming from the registry.
In this context, it wasn't making sense to maintain the `autodiscoverClient` option, which has been removed.

=== camel-salesforce

The default API version for camel-salesforce has been updated to 50.0. Older versions are still 
supported and can be set via the `apiVersion` component option. 

The `packages` option must be set if using the XML `format` option. This change is a result of 
adopting XStream's Security Framework.

CAMEL-15890 fixed a bug in which values for External Ids that contained spaces would have spaces converted to "{plus}". This has been fixed. 
However, any such values that now have the plus sign in salesforce will no longer match as Camel will now preserve the space. Therefore
you may need to have a transformation that explicitly converts spaces to "{plus}" if you need to preserve the old behavior.

=== camel-google-bigquery

The camel-google-bigquery component was updated to use the latest version of `google-cloud-bigquery`. Some features of `GoogleBigQueryConnectionFactory` are no longer supported.

It is no longer possible to provide the service account private key as a String parameter to `GoogleBigQueryConnectionFactory`. Instead, you should use `setCredentialsFileLocation` to 
discover the private key from your credential's file. Or use the fallback mechanism for discovering credentials by setting the `GOOGLE_APPLICATION_CREDENTIALS` environment variable. Refer to the
component documentation for more information. 
= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.7 to 3.8

=== Route startup procedure change

Camel will now initialize all routes during initialization of `CamelContext` itself.
Before all routes where lazy initialized when they were started, which happens in the starting phase of `CamelContext`.
By moving this forward to initialization phase, we ensure all is done together.

This means that all the resources used in the routes such as EIPs, processors, beans, components, data formats, languages etc.
are also initialized. An affect of this change is that any custom Camel component that may do initialization logic in
the constructors of `Consumer` or `Producer` should *not* do this, but move this logic to `doInit` or `doStart` where
such logic belongs.

=== API changes

The following type names are renamed in `CamelEvent.Type` enum:

- `CamelContextRoutesStarting` to `RoutesStarting`
- `CamelContextRoutesStarted` to `RoutesStarted`
- `CamelContextRoutesStopping` to `RoutesStopping`
- `CamelContextRoutesStopped` to `RoutesStopped`

The method `isOnlyDynamicQueryParameters` was removed from `org.apache.camel.spi.SendDynamicAware` and
`org.apache.camel.support.component.SendDynamicAwareSupport` classes.

The class `PackageScanResourceResolver` has been revisited and the method `findResources` now returns a collection of `org.apache.camel.spi.Resource`
which provide both the location of the resolved resources and a method to open the related `InpuStream`:

[source,java]
----
Collection<Resource> findResources(String location) throws Exception;
----

=== OnCompletion EIP

The `onCompletion` EIP has been fixed. It could trigger multiple completions for a given `Exchange` before.

=== Transactions and Multicast, Splitter, or Recipient List EIPs

When using `transacted` in Camel routes with Multicast, Splitter, or Recipient List EIPs, the exection strackframe
could grown deep and this could cause a stack overflow exception. This has been fixed by refactoring the EIP into a special
transacted mode and the existing reactive mode.

We do not anticipate any issues but if you are using transactions and these EIPs then we would like to have feedback
if you encounter any problems with upgrading.

=== Configuration changes

The configuration for specifying directory for loading XML routes have been consolidation into a single option (supporting all kinds):

For Spring Boot users:

`camel.springboot.xml-routes` to `camel.springboot.routes-include-pattern`
`camel.springboot.xml-route-templates` to `camel.springboot.routes-include-pattern`
`camel.springboot.xml-rests` to `camel.springboot.routes-include-pattern`

For Camel Main users:

`camel.main.xml-routes` to `camel.springboot.routes-include-pattern`
`camel.main.xml-route-templates` to `camel.springboot.routes-include-pattern`
`camel.main.xml-rests` to `camel.springboot.routes-include-pattern`


=== camel-jackson

In the XML DSL `jsonView` has been renamed to `jsonViewTypeName` and made general available in the model
and for the lightweight `camel-xml-io` route parser.

=== camel-caffeine-lrucache

This LRUCache implementation is using an algorithm where elements that are removed may not be in strict order, and therefore
not ideal for LRU caches assuming ordering.

The implementation is not needed anymore in Camel 3, as we are using a simpler default implementation internally.
This component was deprecated, and has been removed as Maven dependency in `camel-core` pom.xml file.

=== camel-activemq and camel-jms

The JMS and ActiveMQ components now support the optimized toD EIP pattern by using a single endpoint/producer for dynamic destination names.

=== camel-sjms and camel-sjms2

These two components have been overhauled and re-written with the goal of being more feature complete with the Spring JMS component.
They no longer uses their own connection pooling, but let you use the existing 3rd party pooling for `ConnectionFactory` which is common practice.
The components are now reactive and non-blocking, and support the optimized toD EIP pattern by using a single endpoint/producer for dynamic destination names.

Many of the previous features and configuration options have been removed/renamed.
The sjms-batch sub component has been removed and is scheduled to be reimplemented in the future.
To migrate you need to read their documentation and see what options they now offer.

=== camel-aws2-sns

The policy option now expects a file, since the policy is going to be complex. It can be from classpath:, http: or file: etc.

=== camel-aws2-sqs

The policy option now expects a file, since the policy is going to be complex. It can be from classpath:, http: or file: etc.

=== camel-github

The Camel Github Commit consumer has been changed a bit.

For each exchange now in the body you'll get the commit full message as a String and not the Commit Object like before.

Other information has been stored in headers declared in `GitHubConstants` class:

* GITHUB_COMMIT_AUTHOR - `CamelGitHubCommitAuthor` - The commit Author
* GITHUB_COMMIT_COMMITTER - `CamelGitHubCommitCommitter` - The committer name
* GITHUB_COMMIT_SHA - `CamelGitHubCommitSha` - The commit sha
* GITHUB_COMMIT_URL - `CamelGitHubCommitUrl` - The commit url

The Camel Github Events consumer has been changed a bit.

For each exchange now in the body you'll get the event type as a String and not the Event Object like before.

Other information has been stored in headers declared in GitHubConstants class:

* GITHUB_EVENT_PAYLOAD - `CamelGitHubEventPayload` - The event payload

=== camel-infinispan

There are now two components for Infinispan:

- *camel-infinispan* to integrate with remote caches through the Hot Rod protocol (scheme: *infinispan*).
- *camel-infinispan-embedded* to integrate with local/embedded caches (scheme: *infinispan-embedded*).

As consequence of the refactor:

The remote and embedded endpoints provide support the same capabilities, as example queries were only possible on a remote cache and now they are supported on both remote and local/embedded caches.
The configuration options for the endpoint are now specific to the context which remove the possibility to mix unrelated properties.
Some classes have been relocated (such as indempotent and aggregation repositories) have been moved from `org.apache.camel.component.infinispan.processor.*` to `org.apache.camel.component.infinispan.embedded` or `org.apache.camel.component.infinispan.remote`:
- `org.apache.camel.component.infinispan.embedded.InfinispanEmbeddedAggregationRepository`
- `org.apache.camel.component.infinispan.embedded.InfinispanEmbeddedIdempotentRepository`
- `org.apache.camel.component.infinispan.remote.InfinispanRemoteAggregationRepository`
- `org.apache.camel.component.infinispan.remote.InfinispanRemoteIdempotentRepository`

=== camel-aws

All the camel-aws components except camel-aws-xray have been deprecated. We suggest migrating to camel-aws2-* components,
because in future releases the AWS components will be removed and with the next LTS release (3.10 probably)
camel-aws2 components will be renamed to camel-aws.


= Apache Camel 3.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

== Upgrading Camel 3.8 to 3.9

=== API changes

The `Consumer` API in `camel-api` has been enhanced to help support Camel reducing the footprint during routing.
One aspect is that we allow recycling `Exchange` instances created by the consumers. This avoids creating new `Exchange`
instances in the memory for each incoming message consumers process. By recycling `Exchange`s we reduce the overhead
on the JVM garbage collector. This requires Camel to know if the `Exchange` should be recycled or not,
and some API changes took place.

The `Consumer` API has two new methods which a consumer must use to create an `Exchange` with `createExchange`.
Default the exchange is auto released when its complete in use, but some consumers needs custom control,
and can turn off auto release, which then requires the consumer to manually release the exchange by calling `releaseExchange`
when the consumer is done with the exchange.

The default implementations in `DefaultConsumer` has adapted this API and 3rd party components can continue as is, by using
the older APIs. For these 3rd party components to support recycling exchanges, then they must be updated to use this new API.

A new `org.apache.camel.spi.ResourceLoader` has been introduced as part of https://issues.apache.org/jira/browse/CAMEL-16285[CAMEL-16285] which provide a way to support additional schemas to resolve resources. As a consequece:

- `org.apache.camel.support.ResourceHelper` has been updated to use such mechanism instead fo the old one.
- it is not more possible to provide support for additional schemas using the URL protocol handler mechanism but instead, custom schemas can be added by implementing `org.apache.camel.spi.ResourceResolver` and either bind an instance to the Camel Registry (using `resource-loader-` as a prefix) or using the Service Factory mechanism (under the path `META-INF/services/org/apache/camel/resource-resolver/`)

As example, assuming you want to provide a support for the schema `foo`, then you either have to binbd your instance to the Camel Registry with `resource-loader-foo` as a key, or create a factory finder file with path `META-INF/services/org/apache/camel/resource-resolver/foo`
The method for retrieving a resource URL provided by the `org.apache.camel.support.ResourceHelper` class, i.e. `resolveMandatoryResourceAsUrl` ad ` resolveResourceAsUr` have been amended to accept a `CamelContext` instance instead of a `ClassResolver`.

=== Exchange properties

The properties on `Exchange` have been optimized to separate into two: internal state vs user properties.

The method `getProperties()` now only returns user properties. To include internal properties as well,
then use `getAllProperties()`.

The other APIs such as `getProperty(String)` works the same way as before, being able to lookup a property
regardless if it is internal or custom.

The internal properties is a fixed set of known keys defined in the `ExchangePropertyKey` enum class.
These keys are used in camel-core such as the routing engine, EIPs and others that needs to store internal
state on the `Exchange` which is done as exchange properties. Because Camel end users can also store
exchange properties then before they would get mixed together. What we have done now is to separate them.

=== Choice and Filter EIP

The `choice` and `filter` EIPs no longer store exchange property `Exchange.FILTER_MATCHED`.
The reason is the information is seldom in use, and by removing we were able to optimize camel-core.

=== OnCompletion EIP

Camel now validates that a route has only 1 onCompletion. Previously users could have code such as:

[source,java]
----
from("direct:start")
        .onCompletion().onCompleteOnly().to("mock:ok").end()
        .onCompletion().onFailureOnly().to("mock:error").end()
        .to("mock:result");
----

Which would lead to the last onCompletion override the first, meaning that only `onCompletion().onFailureOnly()`
would be active. Now this is checked on startup and Camel reports an error.

=== Modularized camel-spring

The `camel-spring` component has been modularized into:

- `camel-spring` - Core module for Camel Spring support
- `camel-spring-xml` - XML DSL when using Spring XML (eg `<beans>`)

Also for Camel on Spring Boot:

- `camel-spring-boot-starter` - Camel with Spring Boot
- `camel-spring-boot-xml-starter` - XML DSL when using Spring XML (eg `<beans>`) with Spring Boot

The motivation is to move out the XML DSL from `camel-spring` which reduces the number of dependencies and makes
the module lighter.

Users that use the Spring XML DSL (eg the top XML tag is Spring `<beans>`) should migrate from using `camel-spring`
to `camel-spring-xml` as dependency.

Users that do not use Spring XML should not be affected.

In Spring XML `<proxy>` and <remote>` have been removed. They were only available in Spring XML
and not in the other XML DSLs (Blueprint and CDI).

=== camel-spring-boot-starter vs camel-spring-boot-engine-starter

Based on the modularization of camel-spring we have made two starters available when using Camel on Spring Boot

- camel-spring-boot-starter - The regular starter that includes all the core components (similar to camel-core)
- camel-spring-boot-engine-starter - A minimal starter with just Camel core engine (similar to camel-core-engine)

We also made all the component -starter JARs not depend on any of the above starters, which means you must pick
the one to use above, and then add which -starter JARs you want to use in your Camel spring boot applications.

=== Camel-AWS components removed

- Camel-AWS-SDB has been removed. There will be no substitution for this, because there isn't a SDK v2 client for this and furthermore the service is not listed in the AWS console anymore.
- Camel-AWS-Translate has been removed. Please switch to Camel-AWS2-Translate.
- Camel-AWS-SQS has been removed. Please switch to Camel-AWS2-SQS.
- Camel-AWS-SNS has been removed. Please switch to Camel-AWS2-SNS.
- Camel-AWS-MSK has been removed. Please switch to Camel-AWS2-MSK.
- Camel-AWS-MQ has been removed. Please switch to Camel-AWS2-MQ.
- Camel-AWS-KMS has been removed. Please switch to Camel-AWS2-KMS.
- Camel-AWS-Kinesis has been removed. Please switch to Camel-AWS2-Kinesis.
- Camel-AWS-Kinesis Firehose has been removed. Please switch to Camel-AWS2-Kinesis-firehose.
- Camel-AWS-IAM has been removed. Please switch to Camel-AWS2-IAM.
- Camel-AWS-EKS has been removed. Please switch to Camel-AWS2-EKS.
- Camel-AWS-ECS has been removed. Please switch to Camel-AWS2-ECS.
- Camel-AWS-EC2 has been removed. Please switch to Camel-AWS2-EC2.
- Camel-AWS-DDB has been removed. Please switch to Camel-AWS2-DDB.
- Camel-AWS-DDB Streams has been removed. Please switch to Camel-AWS2-DDB Streams.
- Camel-AWS-CW has been removed. Please switch to Camel-AWS2-CW.
- Camel-AWS-S3 has been removed. Please switch to Camel-AWS2-S3.
- Camel-AWS-SWF has been removed. There won't be a replacement for it.

=== camel-aws2-sqs

The option `deleteIfFiltered` has been changed to use a different exchange property with key `Sqs2Constants.SQS_DELETE_FILTERED`
which must be set. Beforehand a property by Filter EIP was being used, however this property has been removed due
to optimizing core Camel.

=== Camel-Azure component

- Camel-Azure has been removed. Please switch to Camel-Azure-Storage-Blob and Camel-Azure-Storage-Queue.

=== camel-freemarker component

The freemarker component now has turned off localized lookup for templates.
This can be turned back on by setting `localizedLookup=true` on the component.

=== Camel-AWS2 components

- Camel-AWS2-sqs has now the autoCreateQueue option set to false as default, so you'll need to create entities before or set the option explicitly to true
- Camel-AWS2-sns has now the autoCreateTopic option set to false as default, so you'll need to create entities before or set the option explicitly to true
- Camel-AWS2-s3 has now the autoCreateBucket option set to false as default, so you'll need to create entities before or set the option explicitly to true

=== Camel-jmh, camel-performance and camel-itest-performance

Camel-jmh, camel-performance and camel-itest-performance have been moved to a new repository https://github.com/apache/camel-performance-tests

=== Camel-Debezium

The camel-debezium-parent module has been renamed to camel-debezium-common-parent, while the old the name is now used as parent name for the middle folder. This is an internal change that shouldn't affect end users, added here for tracking purpose anyway.

=== camel-jclouds

The camel-jclouds feature for Camel on Karaf has been removed.

=== camel-kafka

The camel-kafka consumer has been improved to be more roboust and have more confirations how to deal with exceptions while polling from Kafka Brokers.
In case of any exception thrown, then previously the consumer will re-connect and therefore try again. This leads to Kafka broker would reasign the partions,
but it may assign back the same consumer again, or another standby consumer.

The new behavior is to only retry certain kind of exceptions which Kafka has marked as retryable. Any other exceptions is now
causing Camel error handler to handle the caused exception (will log by default but you can use onException etc), and then
skip to next offset so the next message can be polled and processed by Camel.

See the updated camel-kafka documentation for more details.

= Apache Camel 3.x Upgrade Guide

IMPORTANT: If you are migrating from Camel 2.x then use the
xref:camel-3-migration-guide.adoc[Camel 2.x to 3.0 Migration Guide] first.

This document is for helping you upgrade your Apache Camel application
from Camel 3.x to 3.y. For example if you are upgrading Camel 3.0 to 3.2, then you should follow the guides
from both 3.0 to 3.1 and 3.1 to 3.2.

You can find upgrade guide for each release in the following pages:

- xref:camel-3x-upgrade-guide-3_1.adoc[Upgrade guide 3.0 -> 3.1]
- xref:camel-3x-upgrade-guide-3_2.adoc[Upgrade guide 3.1 -> 3.2]
- xref:camel-3x-upgrade-guide-3_3.adoc[Upgrade guide 3.2 -> 3.3]
- xref:camel-3x-upgrade-guide-3_4.adoc[Upgrade guide 3.3 -> 3.4]
- xref:camel-3x-upgrade-guide-3_5.adoc[Upgrade guide 3.4 -> 3.5]
- xref:camel-3x-upgrade-guide-3_6.adoc[Upgrade guide 3.5 -> 3.6]
- xref:camel-3x-upgrade-guide-3_7.adoc[Upgrade guide 3.6 -> 3.7]
- xref:camel-3x-upgrade-guide-3_8.adoc[Upgrade guide 3.7 -> 3.8]
- xref:camel-3x-upgrade-guide-3_9.adoc[Upgrade guide 3.8 -> 3.9]
- xref:camel-3x-upgrade-guide-3_10.adoc[Upgrade guide 3.9 -> 3.10]
- xref:camel-3x-upgrade-guide-3_11.adoc[Upgrade guide 3.10 -> 3.11]
- xref:camel-3x-upgrade-guide-3_12.adoc[Upgrade guide 3.11 -> 3.12]
- xref:camel-3x-upgrade-guide-3_13.adoc[Upgrade guide 3.12 -> 3.13]
- xref:camel-3x-upgrade-guide-3_14.adoc[Upgrade guide 3.13 -> 3.14]
- xref:camel-3x-upgrade-guide-3_15.adoc[Upgrade guide 3.14 -> 3.15]
- xref:camel-3x-upgrade-guide-3_16.adoc[Upgrade guide 3.15 -> 3.16]
- xref:camel-3x-upgrade-guide-3_17.adoc[Upgrade guide 3.16 -> 3.17]
- xref:camel-3x-upgrade-guide-3_18.adoc[Upgrade guide 3.17 -> 3.18]
- xref:camel-3x-upgrade-guide-3_19.adoc[Upgrade guide 3.18 -> 3.19]
- xref:camel-3x-upgrade-guide-3_20.adoc[Upgrade guide 3.19 -> 3.20]
- xref:camel-3x-upgrade-guide-3_21.adoc[Upgrade guide 3.20 -> 3.21]
- xref:camel-3x-upgrade-guide-3_22.adoc[Upgrade guide 3.21 -> 3.22]
= Apache Camel 3.x to 4.0 Migration Guide

This document is intended to help you migrate your Apache Camel applications
from version 3.20 or higher to 4.0. If you are upgrading from an older Camel 3.x release,
such as 3.14, then make sure to read the individual xref:camel-3x-upgrade-guide.adoc[Camel 3.x Upgrade Guide]
to upgrade to the 3.20 release, prior to upgrade to Camel 4.

IMPORTANT: If you are upgrading Camel 4.x to 4.y then use the
xref:camel-4x-upgrade-guide.adoc[Camel 4.x Upgrade Guide].

== Java versions

Camel 4 supports Java 17. Support for Java 11 is dropped.

== Removed Components

The following components have been removed:

[options="header"]
|===
| Component | Alternative component(s)
| camel-any23                          | none
| camel-atlasmap                       | none
| camel-atmos                          | none
| camel-caffeine-lrucache              | camel-cache, camel-ignite, camel-infinispan
| camel-cdi                            | camel-spring-boot, camel-quarkus
| camel-corda                          | none
| camel-directvm                       | camel-direct
| camel-dozer                          | camel-mapstruct
| camel-elasticsearch-rest             | camel-elasticsearch
| camel-gora                           | none
| camel-hbase                          | none
| camel-hyperledger-aries              | none
| camel-iota                           | none
| camel-ipfs                           | none
| camel-jbpm                           | none
| camel-jclouds                        | none
| camel-johnzon                        | camel-jackson, camel-fastjson, camel-gson
| camel-microprofile-metrics           | camel-micrometer, camel-opentelemetry
| camel-milo                           | none
| camel-opentracing                    | camel-micrometer, camel-opentelemetry
| camel-rabbitmq                       | spring-rabbitmq-component
| camel-rest-swagger                   | camel-openapi-rest
| camel-restdsl-swagger-plugin         | camel-restdsl-openapi-plugin
| camel-resteasy                       | camel-cxf, camel-rest
| camel-spark                          | none
| camel-spring-integration             | none
| camel-swagger-java                   | camel-openapi-java
| camel-websocket                      | camel-vertx-websocket
| camel-websocket-jsr356               | camel-vertx-websocket
| camel-vertx-kafka                    | camel-kafka
| camel-vm                             | camel-seda
| camel-weka                           | none
| camel-xstream                        | camel-jacksonxml
| camel-zipkin                         | camel-micrometer, camel-opentelemetry
|===

== Logging

Camel 4 has upgraded logging facade API `slf4j-api` from 1.7 to 2.0.

== JUnit 4

All the `camel-test` modules that were JUnit 4.x based has been removed. All test modules now use JUnit 5.

== API Changes

[options="header"]
|===
| Type of Change | API | Alternative
| Removed   | `InOptionalOut` from `org.apache.camel.ExchangePattern` | `InOut`
| Removed   | `@FallbackConverter` | `@Converter(fallback = true)`
| Removed   | `getEndpointMap()` |
| Removed   | `uri` attribute on `@EndpointInject`, `@Produce`, and `@Consume` | Use `value` (default) instead. For example `@Produce(uri = "kafka:cheese")` should be changed to `@Produce("kafka:cheese")`
| Removed   | `label` on `@UriEndpoint` | use `category` instead.
| Removed   | `consumerClass` on `@UriEndpoint` |
| Removed   | all `asyncCallback` methods on `ProducerTemplate` | `asyncSend` or `asyncRequest`.
| Removed   | `org.apache.camel.spi.OnCamelContextStart` | `org.apache.camel.spi.OnCamelContextStarting`
| Removed   | `org.apache.camel.spi.OnCamelContextStop` | `org.apache.camel.spi.OnCamelContextStopping`
| Removed   | `Discard` and `DiscardOldest` from `org.apache.camel.util.concurrent.ThreadPoolRejectedPolicy` |
| Removed   | `org.apache.camel.builder.SimpleBuilder` | This API was mostly used internally in Camel with the Java DSL in some situations.
| Removed   | `archetypeCatalogAsXml` method from `org.apache.camel.catalog.CamelCatalog` |
| Removed   | `configure` from the interface `org.apache.camel.main.Listener` |
| Removed   | `getExtension` from the interface `CamelContext` | Use `getCamelContextExtension` instead. For example `ManagedCamelContext managed = context.getCamelContextExtension().getContextPlugin(ManagedCamelContext.class);`
| Moved   | Moved `org.apache.camel.support.IntrospectionSupport` to `camel-core-engine` for internal use only | End users should use `org.apache.camel.spi.BeanIntrospection` instead.
| Moved   | Exchange failure handling status has moved from being a property defined as `ExchangePropertyKey.FAILURE_HANDLED` to a member of the ExtendedExchange, accessible via `isFailureHandled()`method.
 |
| Replaced   | Replaced `adapt()` from `org.apache.camel.CamelContext` with `getCamelContextExtension` |
| Replaced   | Replaced `adapt()` from `org.apache.camel.ExtendedExchange` with `getExchangeExtension` |
| Added   | Added `position` method to `org.apache.camel.StreamCache` |
| Decoupled   |Decoupled the `org.apache.camel.ExtendedCamelContext` from the `org.apache.camel.CamelContext` |
| Decoupled   | Decoupled the `org.apache.camel.ExtendedExchange` from the `org.apache.camel.Exchange`. |
| Changed   | The type for `dumpRoutes` on `CamelContext` has changed from `boolean` to `String` to allow specifying either xml or yaml. |
| Changed   | The `org.apache.camel.health.HealthCheck` method `isLiveness` is now default `false` instead of `true`. |
| Added   | Added `position` method to `org.apache.camel.StreamCache` |
| Added   | The `org.apache.camel.support.EventNotifierSupport` abstract class now implements `CamelContextAware`. |
|===

TIP: The `org.apache.camel.support.PluginHelper` gives easy access to various extensions and context plugins, that
was available previously in Camel v3 directly from `CamelContext`.

NOTE: You can get access to the advanced APIs in `CamelContext` known as `ExtendedCamelContext` via `context.getCamelContextExtension()`.

To get hold of `ManagedCamelContext` then you should use the following way:

[source,java]
----
ManagedCamelContext managed = camelContext.getCamelContextExtension().getContextPlugin(ManagedCamelContext.class);
----

This can be done by many other advanced Camel features such as `RoutesLoader` or `ModelToXMLDumper`:

[source,java]
----
RoutesLoader loader = camelContext.getCamelContextExtension().getContextPlugin(RoutesLoader.class);
----

== EIP Changes

Removed `lang` attribute for the `<description>` on every EIPs.

The `InOnly` and `InOut` EIPs has been removed.
Instead, use `SetExchangePattern` or `To` where you can specify exchange pattern to use.

=== Poll Enrich EIP

The polled endpoint URI is now stored as property on the `Exchange` (with key `CamelToEndpoint`) like all other EIPs.
Before the URI was stored as a message header.

== CircuitBreaker EIP

The following options in `camel-resilience4j` was mistakenly not defined as attributes:

|===
| *Option*
| bulkheadEnabled
| bulkheadMaxConcurrentCalls
| bulkheadMaxWaitDuration
| timeoutEnabled
| timeoutExecutorService
| timeoutDuration
| timeoutCancelRunningFuture
|===

These options were not exposed in YAML DSL, and in XML DSL you need to migrate from:

[source,xml]
----
<circuitBreaker>
    <resilience4jConfiguration>
        <timeoutEnabled>true</timeoutEnabled>
        <timeoutDuration>2000</timeoutDuration>
    </resilience4jConfiguration>
...
</circuitBreaker>
----

To use attributes instead:

[source,xml]
----
<circuitBreaker>
    <resilience4jConfiguration timeoutEnabled="true" timeoutDuration="2000"/>
...
</circuitBreaker>
----


== XML DSL

The `<description>` to set a description on a route or node, has been changed from an element to an attribute.

Before:

[source,xml]
----
<route id="myRoute">
  <description>Something that this route do</description>
  <from uri="kafka:cheese"/>
  ...
</route>
----

After:

[source,xml]
----
<route id="myRoute" description="Something that this route do">
  <from uri="kafka:cheese"/>
  ...
</route>
----

== Type Converter

The `String` -> `java.io.File` converter has been removed.

== Tracing

The xref:tracer.adoc[Tracer] and xref:backlog-tracer.adoc[Backlog Tracer] no longer includes internal tracing events
from routes that was created by Rest DSL or route templates or Kamelets. You can turn this on, by setting
`traceTemplates=true` in the tracer.

The xref:backlog-tracer.adoc[Backlog Tracer] has been enhanced and _fixed_ to trace message headers (also streaming types).
This means that previously headers of type `InputStream` was not traced before, but is now included. This could mean that
the header stream is positioned at the end, and logging the header afterward may appear as the header value is empty.

== UseOriginalMessage / UseOriginalBody

When `useOriginalMessage` or `useOriginalBody` is enabled in `OnException`, `OnCompletion` or error handlers,
then the original message body is defensively copied and if possible converted to `StreamCache` to ensure
the body can be re-read when accessed. Previously the original body was not converted to `StreamCache` which
could lead to the body not able to be read or the stream has been closed.

== Camel Health

Health checks are now by default only readiness checks out of the box.

Camel provides the `CamelContextCheck` as both readiness and liveness checks, so there is at least
one of each out of the box.

Only consumer-based health checks are enabled by default.

=== Producer Health Checks

The option `camel.health.components-enabled` has been renamed to `camel.health.producers-enabled`.

Some components, in particular AWS, also provide health checks for producers. In Camel 3.x
these health checks did not work properly and has been disabled in the source.
To continue this behaviour in Camel 4, then producer-based health checks are disabled.

Notice that `camel-kafka` comes with producer based health-check that worked in Camel 3,
and therefore this change in Camel 4, means that this health-check is disabled.

You *MUST* enable producer health-checks globally, such as in `application.properties`:

[source,properties]
----
camel.health.producers-enabled = true
----

== JMX

Camel now also include MBeans for `doCatch` and `doFinally` in the tree of processor MBeans.

The `ManagedChoiceMBean` have renamed `choiceStatistics` to `extendedInformation`.
The `ManagedFailoverLoadBalancerMBean` have renamed `exceptionStatistics` to `extendedInformation`.

The `CamelContextMBean` and `CamelRouteMBean` has removed method `dumpRouteAsXml(boolean resolvePlaceholders, boolean resolveDelegateEndpoints)`.

== YAML DSL

The backwards compatible mode Camel 3.14 or older, which allowed to have _steps_ as child to _route_ has been removed.

The old syntax:

[source,yaml]
----
- route:
    from:
      uri: "direct:info"
    steps:
    - log: "message"
----

should be changed to:

[source,yaml]
----
- route:
    from:
      uri: "direct:info"
      steps:
      - log: "message"
----

== Backlog Tracing

The option `backlogTracing=true` now automatic enabled the tracer on startup. The previous behavior
was _surprisingly_ that the tracer was only made available, and had to be manually enabled afterward.
The old behavior can be archived by setting `backlogTracingStandby=true`.

Move the following class from `org.apache.camel.api.management.mbean.BacklogTracerEventMessage` in `camel-management-api` JAR
to `org.apache.camel.spi.BacklogTracerEventMessage` in `camel-api` JAR.

The `org.apache.camel.impl.debugger.DefaultBacklogTracerEventMessage` has been refactored into an interface `org.apache.camel.spi.BacklogTracerEventMessage`
with some additional details about traced messages. For example Camel now captures a _first_ and _last_ trace
that contains the input and outgoing (if `InOut`) messages.

== XML serialization

The default XML serialization using `ModelToXMLDumper` has been improved and now uses a generated XML
serializer located in the `camel-xml-io` module instead of the JAXB based one from `camel-jaxb`.

== OpenAPI Maven Plugin

The `camel-restdsl-openapi-plugin` Maven plugin now uses `platform-http` as the default rest component
in the generated Rest DSL code. Previously, the default was servlet. However, platform-http is a better
default that works out of the box with Spring Boot and Quarkus.

== Component changes

=== Category

The number of enums for `org.apache.camel.Category` has been reduced from 83 to 37, which means custom components
that are using removed values need to choose one of the remainder values. We have done this to consolidate
the number of categories of components in the Camel community.

=== camel-openapi-rest-dsl-generator

This dsl-generator has updated the underlying model classes (`apicurio-data-models`) from 1.1.27 to 2.0.3.

=== camel-atom

The `camel-atom` component has changed the third party atom client from Apache Abdera to RSSReader.
This means the feed object is changed from `org.apache.abdera.model.Feed` to `com.apptasticsoftware.rssreader.Item`.

=== camel-azure-cosmosdb

The `itemPartitionKey` has been updated. It's now a String a not a PartitionKey anymore. More details in CAMEL-19222.

=== camel-bean

When using the `method` option to refer to a specific method, and using parameter types and values, such as:
`"bean:myBean?method=foo(com.foo.MyOrder, true)"` then any class types must now be using `.class` syntax,
i.e. `com.foo.MyOrder` should now be `com.foo.MyOrder.class`.

The example from above should now be as follows:

    "bean:myBean?method=foo(com.foo.MyOrder.class, true)"

This also applies to Java types such as String, int, etc.:

    "bean:myBean?method=bar(String.class, int.class)"

=== camel-box

Upgraded from Box Java SDK v2 to v4, which have some method signature changes.
The method to get a file thumbnail is no longer available.

=== camel-caffeine

The `keyType` parameter has been removed. The Key for the cache will now be only `String` type. More information in CAMEL-18877.

=== camel-fhir

The underlying `hapi-fhir` library has been upgraded from 4.2.0 to 6.2.4. Only the `Delete` API method has changed and now returns `ca.uhn.fhir.rest.api.MethodOutcome` instead of `org.hl7.fhir.instance.model.api.IBaseOperationOutcome`. See https://hapifhir.io/hapi-fhir/blog/ for a more detailed list of underlying changes (only the hapi-fhir client is used in Camel).

=== camel-google

The API-based components `camel-google-drive`, `camel-google-calendar`, `camel-google-sheets` and `camel-google-mail`
has been upgraded from Google Java SDK v1 to v2 and to latest API revisions. The `camel-google-drive` and `camel-google-sheets`
have some API methods changes, but the others are identical as before.

=== camel-http

The component has been upgraded to use Apache HttpComponents v5 which has an impact on how the underlying client is configured. There are 4 different
timeouts (`connectionRequestTimeout`, `connectTimeout`, `soTimeout` and `responseTimeout`) instead of initially 3
(`connectionRequestTimeout`, `connectTimeout` and `socketTimeout`) and the default value of some of them has changed so please refer to the documentation
for more details.

Please note that the `socketTimeout` has been removed from the possible configuration parameters of `HttpClient`, use `responseTimeout` instead.

Finally, the option `soTimeout` along with any parameters included into `SocketConfig`, need to be prefixed by `httpConnection.`,
the rest of the parameters including those defined into `HttpClientBuilder` and `RequestConfig` still need to be prefixed by `httpClient.` like before.

=== camel-http-common

The API in `org.apache.camel.http.common.HttpBinding` has changed slightly to be more reusable.
The `parseBody` method now takes in `HttpServletRequest` as input parameter. And all `HttpMessage`
has been changed to generic `Message` types.

=== camel-kubernetes

The `io.fabric8:kubernetes-client` library has been upgraded and some deprecated API usage has been removed. Operations previously prefixed with `replace` are now prefixed with `update`.

For example `replaceConfigMap` is now `updateConfigMap`, `replacePod` is now `updatePod` etc. The corresponding 
constants in class `KubernetesOperations` are also renamed. `REPLACE_CONFIGMAP_OPERATION` is now `UPDATE_CONFIGMAP_OPERATION`, `REPLACE_POD_OPERATION` is now `UPDATE_POD_OPERATION` etc.

=== camel-web3j

The `camel-web3j` has upgraded the `web3j` JAR from 3.x to 5.0 which has many API changes, and so
some previous API calls are no long provided.

=== camel-main

The following constants has been moved from `BaseMainSupport` / `Main` to `MainConstants`:

|===
| Old Name | New Name
| Main.DEFAULT_PROPERTY_PLACEHOLDER_LOCATION | MainConstants.DEFAULT_PROPERTY_PLACEHOLDER_LOCATION
| Main.INITIAL_PROPERTIES_LOCATION | MainConstants.INITIAL_PROPERTIES_LOCATION
| Main.OVERRIDE_PROPERTIES_LOCATION | MainConstants.OVERRIDE_PROPERTIES_LOCATION
| Main.PROPERTY_PLACEHOLDER_LOCATION | MainConstants.PROPERTY_PLACEHOLDER_LOCATION
|===


=== camel-micrometer

The metrics has been renamed to follow Micrometer naming convention https://micrometer.io/docs/concepts#_naming_meters[Naming Meters].

|===
| Old Name | New Name
| CamelExchangeEventNotifier | camel.exchange.event.notifier
| CamelExchangesFailed | camel.exchanges.failed
| CamelExchangesFailuresHandled | camel.exchanges.failures.handled
| CamelExchangesInflight | camel.exchanges.external.redeliveries
| CamelExchangesSucceeded | camel.exchanges.succeeded
| CamelExchangesTotal | camel.exchanges.total
| CamelMessageHistory | camel.message.history
| CamelRoutePolicy | camel.route.policy
| CamelRoutePolicyLongTask | camel.route.policy.long.task
| CamelRoutesAdded | camel.routes.added
| CamelRoutesRunning | camel.routes.running
|===

=== camel-jbang

The command `camel dependencies` has been renamed to `camel dependency`.

In Camel JBang the `-dir` parameter for `init` and `run` goal has been renamed to require 2 dashes `--dir` like all the other options.

The `camel stop` command will now by default stop all running integrations (the option `--all` has been removed).

The _Placeholders substitutes_ is changed to use `#name` instead of `$name` syntax.

=== camel-jpa

The option `transactionManager` has been removed, and a new option named `transactionStrategy`
has been added, that acts as vendor neutral abstraction to make it easier to configure Spring Transaction
or Quarkus Transaction.

=== camel-openapi-java

The `camel-openapi-java` component has been changed to use `io.swagger.v3` libraries instead of `io.apicurio.datamodels`.
As a result, the return type of the public method org.apache.camel.openapi.RestOpenApiReader.read() is now `io.swagger.v3.oas.models.OpenAPI` instead of `io.apicurio.datamodels.openapi.models.OasDocument`.
When an OpenAPI 2.0 (swagger) specification is parsed, it is automatically upgraded to OpenAPI 3.0.x by the swagger parser.
This version also supports OpenAPI 3.1.x specifications.
The related spring-boot starter components have been modified to use the new return type.

=== camel-optaplanner

The `camel-optaplanner` component has been change to use `SolverManager`. If you were using `SoverManager` in Camel 3, you don't need anymore the boolean useSolverManager in the Route.
Deprecated `ProblemFactChange` has been replaced by `ProblemChange`.

The new URI path is:

[source,java]
----
from("optaplanner:myProblemName")
  .to("...")
----

You can pass the OptaPlanner SolverManager in 2 ways:

- as #parameter
- as header

When running `camel-optaplanner` on Spring Boot or Quarkus, it is preferable to use the Spring Boot or Quarkus way of creating the SolverManager.

It is possible to migrate legacy Camel OptaPlanner Routes, by putting the XML config file, as show in the code below. Camel OptaPlanner will handle creating the SolverManager for those legacy Routes:

[source,java]
----
from("optaplanner:myProblemName?configFile=PATH/TO/CONFIG.FILE.xml")
  .to("...")
----

Solver Daemon solutions should be migrated to use SolverManager.

=== camel-platform-http-vertx

If the route or consumer is suspended, then http status 503 is now returned instead of 404.

=== camel-salesforce

Property names of blob fields on generated DTOs no longer have 'Url' affixed. E.g., the `ContentVersionUrl` property is now just `ContentVersion`.

=== camel-slack

The default delay (on Slack consumer) is changed from 0.5s to 10s to avoid being rate limited to often by Slack.

=== camel-spring-rabbitmq

The option `replyTimeout` in `camel-spring-rabbitmq` has been fixed and the default value from 5 to 30 seconds
(this is the default used by Spring).


== Camel Spring Boot

The `camel-spring-boot` dependency no longer includes `camel-spring-xml`. To use legacy Spring XML files `<beans>`
with Camel on Spring Boot, then include the `camel-spring-boot-xml-starter` dependency.

=== Graceful Shutdown

Apache Camel shutdowns a bit later during Spring Boot shutdown. This allows Spring Boot graceful shutdown
to complete first (stopping Spring Boot HTTP server gracefully),
and then afterward Camel is doing its own xref:graceful-shutdown.adoc[].

Technically `camel-spring` has changed `getPhase()` from returning `Integer.MAX_VALUE` to
`Integer.MAX_VALUE - 2049`. This gives room for Spring Boot services to shut down first.

=== camel-micrometer-starter

The `uri` tags are now static instead of dynamic (by default), as potential too many tags generated due to URI with dynamic values.
This can be enabled again by setting `camel.metrics.uriTagDynamic=true`.

=== camel-platform-http-starter

The `platform-http-starter` has been changed from using `camel-servlet` to use Spring HTTP server directly.
Therefore, all the HTTP endpoints are no longer prefixed with the servlet context-path (default is `camel`).

For example:

[source,java]
----
from("platform-http:myservice")
  .to("...")
----

Then calling _myservice_ would before require to include the context-path, such as `http://localhost:8080/camel/myservice`.
Now the context-path is not in use, and the endpoint can be called with `http://localhost:8080/myservice`.

NOTE: The `platform-http-starter` can also be used with Rest DSL.

If the route or consumer is suspended, then http status 503 is now returned instead of 404.

=== camel-twitter

The component was updated to use Twitter4j version 4.1.2, which https://twitter4j.org/2022/10/21/264[has moved the packages] used by a few of its classes. If accessing certain twitter-related data, such as the Tweet status, you need to update the packages used from `twitter4j.Status` to `twitter4j.v1.Status`.


== Upgrading Camel 4.0.1 to 4.0.2

=== camel-file

The `readLock=changed` with using `readLockMinAge` has been restored to same behaviour as 3.x.

For example, using `readLockMinAge=5s` would pick up files that are older than 5 seconds from startup time.
If you have many existing files on startup that are old, then Camel will now again be fast,
and pick up these files immediately.


== Upgrading Camel 4.0.0 to 4.0.1

=== camel-aws2-sns

The `queueUrl` parameter has been replaced by the `queueArn` parameter

For Example before

----
from("direct:start")
  .to("aws2-sns://mytopic?subject=mySubject&autoCreateTopic=true&subscribeSNStoSQS=true&queueUrl=https://xxxx")
----

Should be changed to

----
from("direct:start")
  .to("aws2-sns://mytopic?subject=mySubject&autoCreateTopic=true&subscribeSNStoSQS=true&queueArn=arn:aws:sqs:xxxxx")
----
= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading Camel 4.0 to 4.1

=== camel-api

Added method `newInstance(Class<T> type, Class<?> factoryClass, String factoryMethod)`
to `org.apache.camel.spi.Injector`.

Added `isIgnoreLoadingError` and `setIgnoreLoadingError` methods to `org.apache.camel.spi.RoutesLoader`,
and `org.apache.camel.main.RoutesCollector`.

Added `getDuration` method to `org.apache.camel.StartupStep`.

=== XML and YAML DSL

==== Creating beans from script

In route templates (or kamelets), for advanced use cases, you are able to create beans from an inlined script.

The name of the script was defined in `type`, but has been changed to a new `scriptLanguage` attribute.
And `beanType` has been removed as you must use `type` instead.

Before:

[tabs]
====
XML::
+
[source,xml]
----
    <bean name="myBean" type="groovy" beanType="com.foo.MyBean">
        <script>
          <!-- groovy code here to create the bean -->
        </script>
    </bean>
----
YAML::
+
[source,yaml]
----
- beans:
  - name: "myClient"
    beanType: "com.foo.MyBean"
    type: "groovy"
    script: |
      # groovy script here
----
====

After:

[tabs]
====
XML::
+
[source,xml]
----
    <bean name="myBean" type="com.foo.MyBean"
          scriptLanguage="groovy">
        <script>
          <!-- groovy code here to create the bean -->
        </script>
    </bean>
----
YAML::
+
[source,yaml]
----
- beans:
  - name: "myClient"
    type: "com.foo.MyBean"
    scriptLanguage: "groovy"
    script: |
      # groovy script here
----
====

=== camel-management

Dumping routes to JMX no longer includes `customId="true"` in the XML nodes.

=== camel-scheduler

The `scheduler` no longer includes header with the timestamp of when the exchange was fired.
This means the exchange by default has no headers, and `null` body.

The option `includeMetadata` can be set to `true` on the endpoint or component level, to turn on
these additional metadata headers again.

=== camel-timer

The `timer` no longer includes header `firedTime` with the timestamp of when the exchange was fired.
This means the exchange by default has no headers, and `null` body.

The `firedTime` header has been renamed to `CamelTimerFireTime`.

The option `includeMetadata` can be set to `true` on the endpoint or component level, to turn on
these additional metadata headers again.

=== camel-aws2-step-functions

The following Message Headers of `camel-aws2-step-functions` component have been renamed to follow standard camel naming convention.

[cols="1,1"]
|===
|Old Name|New Name

|CamelAwsStateMachineOperation
|CamelAwsStepFunctionsOperation

|CamelAwsStateMachinesMaxResults
|CamelAwsStepFunctionsStateMachinesMaxResults

|CamelAwsStepFunctionsStateMachineActivityName
|CamelAwsStepFunctionsActivityName

|CamelAwsStepFunctionsStateMachineActivityArn
|CamelAwsStepFunctionsActivityArn

|CamelAwsStateMachineActivitiesMaxResults
|CamelAwsStepFunctionsActivitiesMaxResults

|CamelAwsStateMachineExecutionArn
|CamelAwsStepFunctionsExecutionArn

|CamelAwsStateMachineExecutionName
|CamelAwsStepFunctionsExecutionName

|CamelAwsStateMachineExecutionInput
|CamelAwsStepFunctionsExecutionInput

|CamelAwsStateMachineExecutionTraceHeader
|CamelAwsStepFunctionsExecutionTraceHeader

|CamelAwsStateMachineExecutionHistoryMaxResults
|CamelAwsStepFunctionsExecutionHistoryMaxResults

|CamelAwsStateMachineExecutionHistoryIncludeExecutionData
|CamelAwsStepFunctionsExecutionHistoryIncludeExecutionData

|CamelAwsStateMachineExecutionHistoryReverseOrder
|CamelAwsStepFunctionsExecutionHistoryReverseOrder

|CamelAwsStateMachineExecutionMaxResults
|CamelAwsStepFunctionsExecutionMaxResults
|===

This is applicable only if literal constant headers are used such as `CamelAwsStateMachinesMaxResults`. If the headers are used from StepFunctions2Constants Interface like StepFunctions2Constants.STATE_MACHINES_MAX_RESULTS , then there is no change;

For Example before

----
from("direct:listActivities")
  .setHeader("CamelAwsStepFunctionsActivitiesMaxResults",5)
   .to("aws2-step-functions://test?awsSfnClient=#awsSfnClient&operation=listActivities")
----

Should be changed to

----
from("direct:listActivities")
  .setHeader("CamelAwsStepFunctionsActivitiesMaxResults",5)
    .to("aws2-step-functions://test?awsSfnClient=#awsSfnClient&operation=listActivities")
----

=== camel-aws2-sns

The `queueUrl` parameter has been replaced by the `queueArn` parameter

For Example before

----
from("direct:start")
  .to("aws2-sns://mytopic?subject=mySubject&autoCreateTopic=true&subscribeSNStoSQS=true&queueUrl=https://xxxx")
----

Should be changed to

----
from("direct:start")
  .to("aws2-sns://mytopic?subject=mySubject&autoCreateTopic=true&subscribeSNStoSQS=true&queueArn=arn:aws:sqs:xxxxx")
----

=== camel-pdf

The Camel-PDF component has been updated to Apache PDFBox 3.0.0, and the font parameter is now defined through the following enum values: COURIER,COURIER_BOLD,COURIER_OBLIQUE,COURIER_BOLD_OBLIQUE, HELVETICA,HELVETICA_BOLD,HELVETICA_OBLIQUE,HELVETICA_BOLD_OBLIQUE,TIMES_ROMAN,TIMES_BOLD,TIMES_ITALIC,TIMES_BOLD_ITALIC,SYMBOL and ZAPF_DINGBATS

=== camel-jbang

The `pipe` command has been renamed to `script`.

The `--secrets-refresh` and `--secret-refresh-providers` have been removed, since they were logically incorrect in the export command context. More information at CAMEL-19927 issue.

The generated XML route, created using the command `camel init`, now uses `<camel>` as the root tag instead of `<routes>`.

=== camel-jetty / camel-servlet / camel-atmosphere-websocket / camel-http-common

By default, stack traces will not be included in HTTP responses,
exceptions are muted.
Stack traces can be included in HTTP responses by disabling `muteException`.
For example:

----
from("jetty:http://localhost:{{port}}/myapp/myservice?muteException=false")
----

When exceptions are muted stack traces may be logged by enabling `logException`.
For example

----
from("jetty:http://localhost:{{port}}/myapp/myservice?logException=true")
----

=== YAML DSL

The kebab-case style schema file,  `camel-yaml-dsl.json` has been removed from the distribution in favor of the camelCase style schema file, `camelYamlDsl.json`. While the Camel runtime stays supporting kebab-case style also for the moment, it is recommended to migrate to camelCase style. Any tooling should encourage users to use camelCase style.

=== camel-tracing

The `Tag` Enum containing constants for tagging spans has been deprecated.
Instead,
use constants from the `TagConstants` Class that align to Open Telemetry v1.21.0 semantic conventions.

For example, instead of

----
span.setTag(Tag.URL_SCHEME, scheme);
----

use

----
span.setTag(TagConstants.URL_SCHEME, scheme);
----

=== camel-kafka

The default value for `sessionTimeoutMs` has been updated to  `45000` ms, while the default value for `consumerRequestTimeoutMs` has been updated to `30000`. More information in CAMEL-19921 issue.

=== camel-core, rest

A new rest configuration option, `enableNoContentResponse`,
allows HTTP 204 to be returned with an empty body if a Message contains an empty JSON object or empty XML root object when set to `true`.
= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading from 4.10.1 to 4.10.2

=== EIPs

==== Recipient List, Split and Multicast EIP

In parallel processing mode, you can also enable `synchronous=true` to force these EIPs to process
the sub-tasks using the upper bounds of the thread-pool. If using `synchronous=false` then Camel
will allow its reactive routing engine to use as many threads as possible, which may be available
due to sub-tasks using other thread-pools such as `CompletableFuture.runAsync` or others.

Setting `synchronous=true` is the same behaviour is in Camel 2 which did not have the reactive routing engine.

==== WireTap and OnCompletion EIP

When MDC is enabled, then the WireTap and OnCompletion (in parallel mode) will now propagate MDC
context when creating threads to process the exchanges. This makes these EIPs similar to how
other EIPs such as Multicast EIP already does this.

=== camel-bean

The header `Exchange.BEAN_METHOD_NAME` with constant value `CamelBeanMethodName` has been deprecated, and support for using this header has been removed.
Instead, you can specify the `method` option directly as shown, or using any other header of your choosing as follows.

[source,java]
----
    toD("bean:myBean?method=${header.myMethodName}");
----

=== camel-sql

When inserting or updating many rows in `batch=true` mode (producer) then this component
has been optimized to execute the entire batch operation in a single transaction; by turning off auto-commit
on the SQL Connection, and doing a manual `commit` or `rollback`. This can dramatically improve performance
on some databases. The old behaviour can be restored by setting the `batchAutoCommitDisabled=false` on the component or endpoint.

== Upgrading from 4.10.0 to 4.10.1

=== camel-api

Added `removeTraits` method to `org.apache.camel.Message`.

Added `bind` method that accepts `Supplier` for the bean and also accepts init and destroy methods,
to the `org.apache.camel.spi.Registry` interface.

=== camel-attachments

The attachments have been refactored to be stored internally as a _message trait_,
and the `org.apache.camel.attachment.AttachmentMessage` is only a facade to provide
end user access to the fine-grained Attachment APIs. The underlying message implementation
such as `DefaultMessage` in the `Exchange` is un-affected when converting from `Message` to `AttachmentMessage` via:

[source,java]
----
AttachmentMessage am = exchange.getMessage(AttachmentMessage.class);
am.addAttachment("message1.xml", new DataHandler(new FileDataSource(new File("src/test/data/message1.xml"))));
----

The class `org.apache.camel.attachment.AttachmentMap` has been removed.
Removed `getDelegateMessage` method from `org.apache.camel.attachment.AttachmentMessage`.

=== camel-ftp

The file name header `Exchange.FILE_NAME` now includes the relative path such as `subdir/hello.txt`
when using `recursive=true`, to be similar to how `camel-file` component behaves.

=== camel-kafka

The camel-kafka option `recordMetadata` has changed default from `true` to `false`.

=== camel-jbang

The option `lazy-bean` has changed to be default `true` when exporting to make the export
work in more situations out of the box.

== Upgrading Camel 4.9 to 4.10

=== XML DSL changes

In `<intercept`> and `<interceptSendToEndpoint>` then `<when>` has been
renamed to `<onWhen>`.

For example:

[source,xml]
----
<intercept>
  <when>...</when>
  ...
</intercept>
----

Should now be:

[source,xml]
----
<intercept>
  <onWhen>...</onWhen>
  ...
</intercept>
----

In `<circuitBreaker` the `<onFallback>` section must be configured last.

For example:

[source,xml]
----
  <circuitBreaker>
    <resilience4jConfiguration timeoutEnabled="true" timeoutDuration="2000"/>
    <onFallback>
      <transform>
        <constant>Fallback message</constant>
      </transform>
    </onFallback>
    <to uri="direct:foo"/>
    ...
  </circuitBreaker>
----

Should now be:

[source,xml]
----
  <circuitBreaker>
    <resilience4jConfiguration timeoutEnabled="true" timeoutDuration="2000"/>
    <to uri="direct:foo"/>
    ...
    <onFallback>
      <transform>
        <constant>Fallback message</constant>
      </transform>
    </onFallback>
  </circuitBreaker>
----

And `inheritErrorHandler` has been moved from `<loadBalance>` to `<failoverLoadBalancer` which
is the only load balancer support this option.

For example:

[source,xml]
----
  <loadBalance inheritErrorHandler="true">
    <failoverLoadBalancer maximumFailoverAttempts="3" roundRobin="true"/>
    ...
  </loadBalance>
----

Should now be:

[source,xml]
----
  <loadBalance>
    <failoverLoadBalancer maximumFailoverAttempts="3" roundRobin="true" inheritErrorHandler="true"/>
    ...
  </loadBalance>
----

=== camel-kamelet

The error handling when using kamelets has been refactored to let Kamelets re-use the same error handling
that are from the route where the kamelets are being used. Previously Kamelets did not have
any error handling.

Suppose you have kamelets that would cause an exception during processing, such
as the source below. Now because the route has been configured with a _dead letter channel_
as the error handler, then the exception from the kamelet will be handled by the route error handler.
Which means you will se a WARN being logged.

Previously the exception would **not** be handled by the route error handler, and the kamelet source
would always fail internally and cause a WARN being logged. Meaning that you did not have
any power to handle these errors.

Now the kamelets are _first class_ and gives users the full power to handle errors as they see fit.

[source,yaml]
----
- route:
    errorHandler:
      deadLetterChannel:
        deadLetterUri: log:dead?level=WARN
    id: myRoute
    from:
      uri: "kamelet:my-error-source/source"
      steps:
        - log: "${body}"
----

This change has most an effect on source Kamelets. For sink or action Kamelets,
then any error would be propagated back to the route, that could still handle the error.
However, if the error handler is configured to perform retries, then the retry would be
starting all over again calling the sink Kamelet. This change will let the error handler
perform retries at the original of the error (also inside the Kamelet), the same as
regular Camel routes.

So suppose you have the following route:

[source,yaml]
----
- route:
    errorHandler:
      deadLetterChannel:
        deadLetterUri: log:dead?level=WARN
        redeliveryPolicy:
          maximumRedeliveries: 5
          redeliveryDelay: "5000"
    id: myRoute
    from:
      uri: "direct:start"
      steps:
        - to:
            uri: "kamelet:my-error-sink/sink"
        - log: "${body}"
----

Then notice the error handler has been configured to do redeliveries up till 5 times with 5 sec delay between.
Suppose the sink kamelet is throwing an exception, then Camel will now perform the redelivery attempt
at the point of origin, which means inside the Kamelet. Previously the redelivery will
only happen at the route level, calling the kamelet all over again.

The option `noErrorHandler` has changed default from `true` to `false`. You should only
use this option if you want to turn on error handling inside Kamelets all together. However,
this should only be used in advanced/rare use-cases. This option may in the future be deprecated and removed.

=== camel-azure-files

The class `org.apache.camel.component.file.azure.FilesHeaders` has been renamed to `org.apache.camel.component.file.azure.FilesConstants`.

=== camel-aws2-s3

The header `CamelAwsS3BucketName` for setting a bucket to write to, on the producer side, cannot be used anymore: the header `CamelAwsS3OverrideBucketName` must be used 
instead. This was done to avoid situation in which you're moving a file from a bucket to a different one, and the header coming from the S3 consumer is used as bucket name for S3 Producer.
You can find more information on CAMEL-21680. 

=== camel-file

The `camel-file` consumer has been optimized when filtering file names using name matching only,
to avoid creating an `GenericFile` object that represent the file. This is unnessasary if the file
is to be excluded due the filtering.

This optimization has changed APIs in the `camel-file` component to let methods that accept
`GenericFile` as parameter, has been changed to use a `Supplier<GenericFile>` to lazy create the wrapper.

Camel users who have created 3rd party component extending `camel-file` may need to migrate your components.

=== camel-google-storage

The header `CamelGoogleCloudStorageBucketName` for setting a bucket to write to, on the producer side, cannot be used anymore: the header `CamelGoogleCloudStorageOverrideBucketName` must be used 
instead. This was done to avoid situation in which you're moving a file from a bucket to a different one, and the header coming from the Google Storage consumer is used as bucket name for Google Storage Producer.
You can find more information on CAMEL-21682. 

=== camel-jgroups

The cluster lock has been removed as it has been removed in JGroups 5.4 onwards, and it was
not recommended to be used in older JGroups releases. You can use another Camel component such as
`camel-infinispan` that has cluster locking.

The `camel-jgroups-cluster-service-starter` in Camel Spring Boot has been removed.

=== camel-jbang

The camel-jbang commands for `camel-k` has been removed.

The `camel dependency update` has removed the option `--source` to specify the source file,
but to refer to the source file directly such as:

`camel dependency update --source=MyRoute.java` to be `camel dependency update MyRoute.java`.

=== camel-micrometer

We have fixed a flawed behavior when using dynamic endpoints which made the generation of endpoint events to grow in an uncontrolled way. From now on the component will generate events for the endpoint base URI as a default behavior. If you still want to collect events for the extended URI (including the parameters), then, you can use the `camel.metrics.baseEndpointURIExchangeEventNotifier=false` configuration. Mind that this is strongly discouraged as it can make your number of events growing out of control.

=== camel-mina

If using object codec, then you should configure the `objectCodecPattern` configuration to specify
which java classes (FQN) to allow for Object serialization. You can use `*` to accept all patterns.

=== camel-minio

The header `CamelMinioBucketName` for setting a bucket to write to, on the producer side, cannot be used anymore: the header `CamelMinioOverrideBucketName` must be used 
instead. This was done to avoid situation in which you're moving a file from a bucket to a different one, and the header coming from the Minio consumer is used as bucket name for Minio Producer.
You can find more information on CAMEL-21678. 

=== camel-google-pubsub-lite

The component `camel-google-pubsub-lite` has been deprecated following the deprecation of the corresponding service by Google Cloud Platform.

Google recommends migrating your Pub/Sub Lite service to either Google Cloud Managed Service for Apache Kafka or Google Cloud Pub/Sub. Depending on your choice, you should use `camel-kafka` or `camel-google-pubsub component`, respectively.

=== camel-tracing

We have deprecated the setting of MDC `trace_id` and `span_id` in favour of implementation specific feature. You need to check the specific tracing/telemetry component configuration to learn how to switch from the deprecated configuration to the new one. Most of the time you will need to remove the `camel.main.use-mdc-logging` Camel property (or set it to `false`) and add dependencies and configuration settings to enable the specific component instrumentation.

=== camel-langchain4j-chat

The function calling feature was removed. Please use the `camel-langchain4j-tools` component for function calling.

=== camel-smb

The `camel-smb` component has been updated to extend `GenericFile` classes and now supports more consumer and producer options.
The Consumer includes options for filtering, pre and post processing, duplicate handling, directory traversal, polling, and readlocks.
The Producer includes options for writing to temporary files, writing content, and handling existing files.

=== camel-solr

The `camel-solr` component has been refactored. The `solrs` and `solrCloud` schemes have been deprecated in the uri format (but can still be enabled via the enableSSL and solrClient configuration options).
The solr operations have been simplified and some solr operations will be no longer be available in the next release. For those operations, a warning message will tell you how to get the same results with the new operations.
The Solr component exchange headers have been renamed and extended. As a consequence, the user should review the use of the Solr exchange headers and rename them when applicable.

All the solr headers has been renamed to use `CamelSolr` as prefix, such as `operation` -> `CamelSolrOperation`.

== camel-spring-boot

The `camel-k-starter` has been removed.

= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading Camel 4.10 to 4.11

=== EIPs

==== Recipient List, Split and Multicast EIP

In parallel processing mode, you can also enable `synchronous=true` to force these EIPs to process
the sub-tasks using the upper bounds of the thread-pool. If using `synchronous=false` then Camel
will allow its reactive routing engine to use as many threads as possible, which may be available
due to sub-tasks using other thread-pools such as `CompletableFuture.runAsync` or others.

Setting `synchronous=true` is the same behaviour is in Camel 2 which did not have the reactive routing engine.

==== WireTap and OnCompletion EIP

When MDC is enabled, then the WireTap and OnCompletion (in parallel mode) will now propagate MDC
context when creating threads to process the exchanges. This makes these EIPs similar to how
other EIPs such as Multicast EIP already does this.

=== camel-api

Added `removeTraits` method to `org.apache.camel.Message`.

Added `bind` method that accepts `Supplier` for the bean and also accepts init and destroy methods,
to the `org.apache.camel.spi.Registry` interface.

=== camel-attachments

The attachments have been refactored to be stored internally as a _message trait_,
and the `org.apache.camel.attachment.AttachmentMessage` is only a facade to provide
end user access to the fine-grained Attachment APIs. The underlying message implementation
such as `DefaultMessage` in the `Exchange` is un-affected when converting from `Message` to `AttachmentMessage` via:

[source,java]
----
AttachmentMessage am = exchange.getMessage(AttachmentMessage.class);
am.addAttachment("message1.xml", new DataHandler(new FileDataSource(new File("src/test/data/message1.xml"))));
----

The class `org.apache.camel.attachment.AttachmentMap` has been removed.
Removed `getDelegateMessage` method from `org.apache.camel.attachment.AttachmentMessage`.

=== camel-bean

The header `Exchange.BEAN_METHOD_NAME` with constant value `CamelBeanMethodName` has been deprecated, and support for using this header has been removed.
Instead, you can specify the `method` option directly as shown, or using any other header of your choosing as follows.

[source,java]
----
    toD("bean:myBean?method=${header.myMethodName}");
----

=== camel-main

Remove the deprecated `camel.main.lightweight` option that was not in use.

=== file based components

The file based component such as `camel-file`, `camel-ftp`, `camel-smb`, and `camel-azure-files` has
been improved to allow optimized dynamic poll when using dynamic `fileName` header.

This change means that there is a new `DynamicPollingConsumer` API the consumer implements.
And as such some APIs inside these components has been changed.

This will only affect if you have built your own custom Camel component on top of `camel-file`.
And if so, your custom code may need to be changed slightly as well.

=== camel-ftp

The file name header `Exchange.FILE_NAME` now includes the relative path such as `subdir/hello.txt`
when using `recursive=true`, to be similar to how `camel-file` component behaves.

=== camel-as2

The `camel-as2` component has been made more tooling friendly to configure options.

The option `signedReceiptMicAlgorithms` is changed from a `String[]` to a single `String` using comma to separate algorithm names.

The option `ediMessageType` is changed from `ContentType` into two options as `String` fields.
This allows to define the content-type and charset separately and more user-friendly.

=== camel-kafka

The camel-kafka option `recordMetadata` has changed default from `true` to `false`.

=== camel-jbang

The option `lazy-bean` has changed to be default `true` when exporting to make the export
work in more situations out of the box.

From this version onward the `export` command add the `camel-observability-services` dependency (which includes telemetry, metrics, health and JMX management services out of the box).

The `--health` and `--metrics` flags of `run` command have been deprecated in favor of the newly `--observe` flag which add the `camel-observability-services` dependency (hence including telemetry, metrics, health and JMX management out of the box). For the run command, this has to be explicitly enabled (ie, `camel run  ... --observe`).

=== camel-sql

When inserting or updating many rows in `batch=true` mode (producer) then this component
has been optimized to execute the entire batch operation in a single transaction; by turning off auto-commit
on the SQL Connection, and doing a manual `commit` or `rollback`. This can dramatically improve performance
on some databases. The old behaviour can be restored by setting the `batchAutoCommitDisabled=false` on the component or endpoint.

=== camel-etcd3

This deprecated component was removed in this release.

=== camel-platform-http

The `org.apache.camel.component.platform.http.PlatformHttpHeaderFilterStrategy` class has been removed. Use the `org.apache.camel.http.base.HttpHeaderFilterStrategy`

=== camel-undertow

The `org.apache.camel.component.undertow.UndertowHeaderFilterStrategy` class has been deprecated. The default header filter strategy is now the `org.apache.camel.http.base.HttpHeaderFilterStrategy`

=== camel-metrics

A new gauge metric, `app.info` is available by default. This is providing a few information related to the runtime provider such as:

```
# HELP app_info
# TYPE app_info gauge
app_info{camel_context="camel-1",camel_runtime_provider="Spring-Boot",camel_runtime_version="3.4.3",camel_version="4.10.2"} 1
```

This information is evaluated at runtime startup and available through the usual metrics endpoint. To disable this metric you need to use the `camel.metrics.skipCamelInfo=true` property.

=== camel-observability-services

In this version we're moving the telemetry component from `camel-opentelemetry` to `camel-opentelemetry2`.
= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading Camel 4.11 to 4.12

=== camel-as2

Add options allowing the addition of an `Authorization` header for Basic or Bearer authentication to client and
asynchronous MDN requests.
= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading Camel 4.1 to 4.2

=== camel-api

Added `boolean` parameter to `matchProcess` method on `org.apache.camel.spi.Condition`.

=== camel-base-engine

The class `org.apache.camel.impl.DebuggerBacklogDebugger` has been refactored to an interface `org.apache.camel.spi.BacklogDebugger` and a default implementation `org.apache.camel.impl.debugger.DefaultBacklogDebugger`.

=== camel-main

The option `camel.main.debugger` has been renamed to `camel.debug.enabled`.

=== camel-management-api

The `org.apache.camel.api.management.mbean.ManagedBacklogDebuggerMBean.dumpTracedMessagesAsXml(String, boolean)` has been deprecated.
The second parameter is ignored with default implementation.

To continue to have access to exchange properties, call `setIncludeExchangeProperties(true)` before messages
are sent to have access to exchange properties.

=== camel-file

The `readLock=changed` with using `readLockMinAge` has been restored to same behaviour as 3.x.

For example, using `readLockMinAge=5s` would pick up files that are older than 5 seconds from startup time.
If you have many existing files on startup that are old, then Camel will now again be fast,
and pick up these files immediately.

=== camel-kafka

The consumer will now pre-validate `hostname:port` and DNS resolution on startup, and fail-fast
in case of mis-configuration or invalid hostname.

This can be disabled by setting `preValidateHostAndPort=false`, which will postpone validation
to consumer is started, and will instead re-connect endlessly (5 sec delay by default) until success.

=== camel-observation / camel-opentelemetry

The `excludePatterns` option has changed from `Set<String>` to be `String` where multiple patterns are separated by comma.
This is more configuration and tooling friendly and used by other components.

=== camel-saga, camel-lra

The `org.apache.camel.service.lra.LRAClient` can now access `Exchange` to retrieve further context information. Therefore, there are following changes in interface methods
- `org.apache.camel.saga.CamelSagaService.compensate()` changed to `org.apache.camel.saga.CamelSagaService.compensate(Exchange exchange)`
- `org.apache.camel.saga.CamelSagaService.complete()` changed to `org.apache.camel.saga.CamelSagaService.complete(Exchange exchange)`
- `org.apache.camel.saga.CamelSagaCoordinator.newSaga` is now `org.apache.camel.saga.CamelSagaCoordinator.newSaga(Exchange exchange)`
to support the transport of `Exchange`.

As a result of interface changes, also the known implementation classes and usages have been adopted.

=== camel-ignite

The Apache Ignite project (v2.15) is not yet Java 21 compatible and therefore `camel-ignite` is not
expected to function correctly if using Java 21.

A new release of Apache Ignite is expected that will start to support Java 21.

=== camel-dynamic-router EIP component (non-core)

The Dynamic Router EIP component has been refactored to use the Multicast Processor for sending messages to recipients,
and this brought some additional configuration options:

- `parallelProcessing`, `parallelAggregate`, `stopOnException`, `ignoreInvalidEndpoints`, `streaming`, `timeout`,
`onPrepare`, `shareUnitOfWork`, `executorService`, and `aggregationStrategy`.  These configuration items are for
configuring the Multicast Processor within the Dynamic Router EIP component, so their description, meaning, and effect
are identical to that of the Multicast Processor.

When upgrading to this version, you should still be able to use this component with the configuration from previous
versions.  The new options allow more specific configuration if you need it.

=== camel-spring & camel-spring-boot

==== Autowiring Primary beans

Camel will now take into account `@Primary` beans from Spring when autowiring by type.
For example, a JDBC `DataSource` in the SQL component will now use the `@Primary` data source
when multiple data sources are defined.

Previously, Camel would not autowire if there are two or more beans for a given type.

NOTE: This is a change in behaviour, that can affect your applications when upgrading.

==== Properties

The `initialProperties` and `overrideProperties` on Camel `PropertiesComponent` will now
take precedence over Spring Boot properties. This can be used for testing purpose,
to allow overriding properties when using `CamelTestSupport` for unit testing.

=== camel-opentelemetry-starter

The `excludePatterns` option has changed from `Set<String>` to be `String` where multiple patterns are separated by comma.
This is more configuration and tooling friendly and used by other components.
= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading Camel 4.2 to 4.3

=== camel-core

Moved class `org.apache.camel.impl.engine.MemoryStateRepository` from camel-base-engine to `org.apache.camel.support.processor.state.MemoryStateRepository` in camel-support.

Moved class `org.apache.camel.impl.engine.FileStateRepository` from camel-base-engine to `org.apache.camel.support.processor.state.FileStateRepository` in camel-support.

=== Resequence EIP

The configuration for batch and stream has been renamed from `batch-config` to `batchConfig` and `stream-config` to `streamConfig`.

For example before:

[source,xml]
----
<resequence>
    <stream-config timeout="1000" deliveryAttemptInterval="10"/>
    <simple>${header.seqnum}</simple>
    <to uri="mock:result" />
</resequence>
----

And now after:

[source,xml]
----
<resequence>
    <streamConfig timeout="1000" deliveryAttemptInterval="10"/>
    <simple>${header.seqnum}</simple>
    <to uri="mock:result" />
</resequence>
----

=== Throttle EIP

Throttle now uses the number of concurrent requests as the throttling measure instead of the number of requests
per period.

Update throttle expressions configured with `maxRequestsPerPeriod` to use `maxConcurrentRequests` instead,
and remove any `timePeriodMillis` option.

For example, update the following:

[source,java]
----
long maxRequestsPerPeriod = 100L;

from("seda:a")
  .throttle(maxRequestsPerPeriod).timePeriodMillis(500)
  .to("seda:b")

// 1000 ms default time period
from("seda:c")
  .throttle(maxRequestsPerPeriod)
  .to("seda:d")
----

to use `maxConcurrentRequests`:

[source,java]
----
long maxConcurrentRequests = 30L;

from("seda:a")
  .throttle(maxConcurrentRequests)
  .to("seda:b")

from("seda:c")
  .throttle(maxConcurrentRequests)
  .to("seda:d")
----

=== Consumer health checks

The scheduled consumers have been improved to mark the consumer as _ready_ sooner, when possible. Previously a consumer
would mark as ready after the first poll was completed. For example, an FTP consumer downloading a big file on the first poll
could take so long time that the readiness check would timeout and fail during the startup of your Camel application.

The following components are now marking the consumer as ready sooner:

- camel-aws
- camel-azure
- camel-box
- camel-dhis2
- camel-fhir
- camel-couchbase
- camel-ftp
- camel-google
- camel-ironmq
- camel-jooq
- camel-jpa
- camel-mail
- camel-minio
- camel-mybatis
- camel-olingo2
- camel-olingo4
- camel-slack
- camel-splunk
- camel-sql
- camel-twilio
- camel-zendesk

=== camel-management

If the `nodeIdPrefix` has been configured on routes, then the MBeans for the processors will now use the prefix
in their `ObjectName` also.

=== camel-console

The context and route consoles have changed some values in their JSON output data for timestamp for created, completed and failed exchanges.

|===
|**Old Key** |**New Key**
| `sinceLastCreatedExchange` | `lastCreatedExchangeTimestamp`
| `sinceLastCompletedExchange` | `lastCompletedExchangeTimestamp`
| `sinceLastFailedExchange` | `lastFailedExchangeTimestamp`
|===

The values are also changed from String ago to timestamp in millis.For example, old value `3m5s` is now `1701599263337`.

=== camel-jbang

The `camel transform` command has been renamed to `camel transform route` as this command is used for transforming
routes between DSLs such as XML to YAML.

There is a new `camel transform message` command to do message transformation.

=== camel-jetty

Jetty has been upgraded from v11 to v12. End users may need to adjust to changes in Jetty.

=== camel-kafka

The behavior for `breakOnFirstError` was altered as numerous issues were fixed. The behavior related to committing
the offset is now determined by the `CommitManager` that is configured.

When the default `CommitManager` is used (`NoopCommitManager`) then no commit is performed. The route implementation will
be responsible for managing the offset using `KafkaManualCommit` to manage the retrying of the payload.

When using the `SyncCommitManager` then the offset will be committed so that the payload is continually retried. This was
the behavior described in the documentation.

When using the `AsyncCommitManager` then the offset will be committed so that the payload is continually retried. This was
the behavior described in the documentation.

=== camel-yaml-dsl

Using kebab-case in general has been deprecated, and you will see a WARN logs. Please migrate to camelCase.

The language for exchange property now only supports camelCase style, i.e. `exchange-property` is now `exchangeProperty`.

The `camelYamlDsl.json` Schema file has removed `inheritErrorHandler` option for all EIPs where it was not applicable.
This option is only intended for the Load Balancer EIP. This makes the YAML schema in-line with the XML DSL schema.

=== camel-hdfs

The HDFS component has been deprecated, and planned to be removed in 4.4 (see CAMEL-20196).

=== camel-kafka

The header name for the `List<RecordMetadata>` metadata has changed from
`org.apache.kafka.clients.producer.RecordMetadata` to `kafka.RECORD_META`,
and the header constant from `KAFKA_RECORDMETA` to `KAFKA_RECORD_META`.= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading from 4.4.4 to 4.4.5

=== camel-mina

If using object codec, then you should configure the `objectCodecPattern` configuration to specify
which java classes (FQN) to allow for Object serialization. You can use `*` to accept all patterns.

== Upgrading from 4.4.3 to 4.4.4

The `camel-opentelemetry` component has had significant bug fixes to handle span activation/deactivations
better when Camel route messages synchronously and asynchronously. This component should also work better
on Spring Boot.

== Upgrading Camel 4.3 to 4.4

=== camel-core

The `org.apache.camel.spi.DataFormat` has changed exception thrown from `IOException` to `Exception`
in the unmarshal(Exchange exchange, InputStream stream)` method.

Removed the deprecated constructor from the internal class `org.apache.camel.util.StopWatch`. Users of this class are advised to use the default constructor if necessary.

The method `getCreated` from the `org.apache.camel.Exchange` is now deprecated. Access to the time-related information from the exchange should be done via `getClock`.

We standardized and consolidated code computing durations so that they use a monotonic clock.

Durations and some time-related information were consolidated in a new internal Clock API.

The `lookup` method in `org.apache.camel.component.properties.PropertiesLookup` now has a 2nd parameter for the default value.

Some of the Java DSL for `tokenize`, `xmlTokenize`, `xpath`, `xquery` and `jsonpath` has been removed as part of making the DSL model consistent.

Here are a few examples of migration before vs after:

[source,java]
----
 from("direct:in")
    .choice()
        .when().xpath("/invoice/@orderType = 'premium'", "invoiceDetails")
            .to("mock:premium")
        .when() .xpath("/invoice/@orderType = 'standard'", "invoiceDetails")
            .to("mock:standard")
        .otherwise()
            .to("mock:unknown")
    .end();
----

You can use the _fluent expression_ builder to configure all the options:

[source,java]
----
// use fluent builder expression to create the languages
var premium = expression().xpath().expression("/invoice/@orderType = 'premium'").source("header:invoiceDetails").end();
var standard = expression().xpath().expression("/invoice/@orderType = 'standard'").source("header:invoiceDetails").end();

from("direct:in")
    .choice()
        .when(premium)
            .to("mock:premium")
        .when(standard)
            .to("mock:standard")
        .otherwise()
            .to("mock:unknown")
    .end();
----

In the example above notice how we use `source` to specify the input to use, in this case a header named invoiceDetails.
The `source` can also be variable, or exchange property.

And another example with `tokenize`:

[source,java]
----
from("direct:start")
    .split().tokenize("\r\n|\n", true, 2, "\n", true)
        .log("${body}")
        .to("mock:line");
----

You can use the _fluent expression_ builder to configure all the options:

[source,java]
----
// use fluent builder expression to create the languages
var token = expression().tokenize().token("\r\n|\n").regex(true).group(2).groupDelimiter("\n").skipFirst(true).end();

from("direct:start")
    .split(token)
        .log("${body}")
        .to("mock:line");
----

==== Languages

The way languages are created and configured by Camel has been refactored to be aligned and avoid a thread-safety issues
when using Java DSL. The setter/getter on the `Language` classes for options that are not general has been removed (such as in `TokenizeLanguage`).

In XML and YAML DSL the `type` option in `<xquery>` has been renamed to `resultType` to be aligned with the other languages.

In XML and YAML DSL The `headerName` on `<xpath>`, `<xquery>` has been renamed to `source` and you should prefix the value with `header:name` to declare
it is a header, because other kind of sources can be specified also. The same change has applied to `@XPath` and `@XQuery`
language annotations.

==== WireTap EIP

The copied exchange is no longer having exchange property CORRELATION_ID set that links to the original exchange.
The reason is that this link should only be for EIPs with sub exchanges such as Splitter and Multicast.

==== Throttle EIP

Previously, Camel used a throttler based on the total number of requests over a period of time ("TotalRequests" mode). That was
the default on Camel up to version 4.2.0. On Camel 4.3.0 we introduced a new one based on the number of concurrent requests and
replaced the former.

With Camel 4.4.0 we refactored the xref:components:eips:throttle-eip.adoc[Throttle EIP] implementation so that Camel can support two different modes of throttling.

Check the component documentation for details about how to use each mode.

==== MDC logging

When using custom MDC keys (need to configure `MDCLoggingKeysPattern`) then these custom keys are cleared at the end of routing.
Also, custom keys is allowed to be changed during routing, using the `MDC.set(myKey, ...)` Java API.

=== camel-main

The route controller configuration has been moved from general main to its own group.
All keys started with `camel.main.routesController` should be renamed to `camel.routecontroller.`, for example
`camel.main.routeControllerBackOffDelay` should be renamed to `camel.routecontroller.backOffDelay`.
And the option `camel.main.routeControllerSuperviseEnabled` has been renamed to `camel.routecontroller.enabled`.

=== camel-kamelet

All Kamelets are now turned off error handling in the route templates. This is done to make using Kamelets
the same as calling a regular Camel component endpoint. Backwards mode can be enabled by setting `noErrorHandler=false`
on the `KameletComponent` or as URI parameter `to("kamelet:http-sink?noErrorHandler=false&uri=xxxxx")`.

=== camel-azure-cosmosdb

The `useDefaultIdentity` parameter has been removed in favor of the credentialType parameter.
Now user should select between `SHARED_ACCOUNT_KEY` and `AZURE_IDENTITY`.
This is part of the effort explained in CAMEL-18590.

=== camel-azure-eventhubs

The credentialType parameter has been introduced with three possible values: `AZURE_IDENTITY`, `CONNECTION_STRING` and `TOKEN_CREDENTIAL`.
With the `CONNECTION_STRING` mode the user could explicitly set the `connectionString` parameters or use the `sharedAccessName` and `sharedAccessKey` to automatically build the connection string.
With the `TOKEN_CREDENTIAL` mode the user could pass a `TokenCredential` instance.
With the `AZURE_IDENTITY` mode the user will be able to use the Default Azure Credentials Chain.
This is part of the effort explained in CAMEL-18590.

=== camel-azure-servicebus

The credentialType parameter has been introduced with three possible values: `AZURE_IDENTITY`, `CONNECTION_STRING` and `TOKEN_CREDENTIAL`.
With the `CONNECTION_STRING` mode the user could explicitly set the `connectionString` parameter.
With the `TOKEN_CREDENTIAL` mode the user could pass a `TokenCredential` instance.
With the `AZURE_IDENTITY` mode the user will be able to use the Default Azure Credentials Chain.
This is part of the effort explained in CAMEL-18590.

=== camel-azure-files

The credentialType parameter has been introduced with three possible values: `AZURE_IDENTITY`, `SHARED_ACCOUNT_KEY` and `AZURE_SAS`.
With the `SHARED_ACCOUNT_KEY` mode the user could explicitly set the `sharedKey` parameter.
With the `AZURE_IDENTITY` mode the user will be able to use the Default Azure Credentials Chain.
With the `AZURE_SAS` mode the user could explicitly set the token parameter.
This is part of the effort explained in CAMEL-18590.

=== camel-azure-storage-datalake

The useDefaultIdentity parameter has been removed in favor of the `credentialType` parameter. Now user should select between `AZURE_IDENTITY`, `CLIENT_SECRET`, `SHARED_KEY_CREDENTIAL`, `AZURE_SAS` and `SERVICE_CLIENT_INSTANCE`.
With the `SHARED_KEY_CREDENTIAL` mode the user could explicitly set the `sharedKey` parameter or a `SharedKeyCredential` instance.
With the `AZURE_IDENTITY` mode the user will be able to use the Default Azure Credentials Chain.
With the `AZURE_SAS` mode the user could explicitly set the `sasSignature` or `sasCredential` parameter.
With the `CLIENT_SECRET` mode the user could explicitly set `clientId`, `clientSecret` and `tenantId` or specify a `ClientSecretCredential` instance.
With the `SERVICE_CLIENT_INSTANCE` the user could explicitly set a `serviceClient` parameter by passing a `DataLakeServiceClient` instance.
This is part of the effort explained in CAMEL-18590.

=== camel-azure-storage-queue

The `useDefaultIdentity` parameter has been removed in favor of the `credentialType` parameter. Now user should select between `AZURE_IDENTITY`, `SHARED_KEY_CREDENTIAL` and `SHARED_ACCOUNT_KEY`.
With the `SHARED_KEY_CREDENTIAL` mode the user could explicitly set the `SharedKeyCredential` instance.
With the `AZURE_IDENTITY` mode the user will be able to use the Default Azure Credentials Chain.
With the `SHARED_ACCOUNT_KEY` mode the user could explicitly set the `accessKey` parameter.
This is part of the effort explained in CAMEL-18590.

=== camel-cassandraql

The `NamedCassandraAggregationRepository` now provides a `deserializationFilter` parameter.
The default value for it is allowing all java packages and subpackages and all `org.apache.camel` packages and subpackages.
If you plan to use particular classes, and you want to expand the filter, you should change the value according to your needs.
More details in CAMEL-20306.

=== camel-coap

Upgraded from `org.eclipse.californium` v2 to v3 which was a painful upgrade. Removed the `"CamelCoapUri` header that would
allow a producer to create the dynamic client to send to another URL. Use Camel's existing `toD` EIP for that instead.

=== camel-consul

This component has migrated from `com.orbitz.consul:consul-client` to `org.kiwiproject:consul-client` as the former is no longer maintained,
and kiwiproject took over.

=== camel-dynamic-router

The dynamic router EIP component now handles control messages through a separate control component: `dynamic-router-control`.
These changes were made after a user reported a bug that resulted in query-parameter-based subscriptions being ignored
after the first URI control message was processed.
All control message parameters can be submitted as query parameters when subscribers are within the same JVM as the
dynamic router instance. Users must use "dynamic to", or `toD` when sending these control message properties as query
parameters.
Predicates that are not string expressions may be specified in the message body, or bound to the registry and specified
as a reference with the `predicateBean` parameter.
Control messages can still be sent in the message body, as in the previous version.
The `DynamicRouterControlMessage` no longer has separate builders for `subscribe` and `unsubscribe` messages, so there
is only one builder that you can use for any type of control message.
The control channel will now report subscription details for a routing channel if a message with a control action of
`list` is submitted, along with the dynamic router channel of interest.
Please see the `dynamic-router-eip` module in the `camel-spring-boot-examples` repository for
useful examples of how you might need to change your code to be compatible with the changes in this version.

=== camel-hdfs

The component has been removed after deprecation in 4.3.0

=== camel-jms

The header with key `JMSCorrelationIDAsBytes` has changed value from `String` to `byte[]`.

=== camel-jsonata

Replaced the previous JSONata library with a new one that offers complete compatibility with the JSONata reference implementation's features.

=== camel-sql

The JdbcAggregationRepository now provides a deserializationFilter parameter. The default value for it is allowing all java packages and subpackages and all org.apache.camel packages and subpackages. If you plan to use particular classes and you want to expand the filter, you should change the value according to your needs. More details in CAMEL-20303.

=== camel-facebook

The component was removed without deprecation. The library supporting this component has been unmaintained for a long time. We found no indications that the library itself nor the component are working with modern Facebook, along with the absence of community interest, which lead us to decide to remove this component without deprecation.

=== camel-kafka

The component now has support for batch processing.

=== camel-json-validator

Removed deprecated `org.apache.camel.component.jsonvalidator.DefaultJsonSchemaLoader`,
use `org.apache.camel.component.jsonvalidator.DefaultJsonUriSchemaLoader` instead.

=== camel-splunk-hec

Removed `token` from the URI's path in favor of setting it through a `token` query parameter. While the `token` was in the URI path, it could potentially be leaked within the logs.

=== camel-openapi-java and camel-rest-openapi

Deprecated support for the old Swagger 2.0 spec. Only OpenAPI v3 specs is supported from Camel 4.5 onwards.

== Camel Spring Boot

=== Ordering of BOM imports

When using Camel on Spring Boot, it's recommended to use BOMs to import Camel and Spring dependencies.
In Camel 4.4 onwards we changed the order to let Camel be first as shown below:

[source,xml]
----
<dependencyManagement>
    <dependencies>
        <!-- Camel BOM -->
        <dependency>
            <groupId>org.apache.camel.springboot</groupId>
            <artifactId>camel-spring-boot-bom</artifactId>
            <version>${camel-version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <!-- Spring Boot BOM -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>${spring-boot-version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
----

In previous versions, then we would have `spring-boot-dependencies` before `camel-spring-boot-bom`. However, to better
align and ensure Camel starters are using supported dependencies, then it's recommended to let Camel be first.

=== Auto Configuration

The route controller configuration has been moved from general main to its own group.
All keys started with `camel.springboot.routesController` should be renamed to `camel.routecontroller.`, for example
`camel.springboot.routeControllerBackOffDelay` should be renamed to `camel.routecontroller.backOffDelay`.
And the option `camel.springboot.routeControllerSuperviseEnabled` has been renamed to `camel.routecontroller.enabled`.

=== Routes Collector

Camel Spring Boot will not honor the `camel.springboot.includeNonSingletons` option (default false). This means
that only singleton `RouteBuilder` beans is added by default. Previously then prototype scoped beans would be added as well.

=== camel-platform-http-vertx

Added configuration to enable Vert.x session handling.
Sessions are disabled by default, but can be enabled by setting the `enabled` property on `VertxPlatformHttpServerConfiguration.SessionConfig`
to `true`.
Other properties include `sessionCookieName`, `sessionCookiePath`, `sessionTimeout`, `cookieSecure`, `cookieHttpOnly`
`cookieSameSite` and `storeType`.
The session `storeType` defaults to the Vert.x `LocalSessionStore` and `cookieSameSite` to `Strict`. The remainder
of the properties are configured with Vert.x defaults if not set.
= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading Camel 4.4 to 4.5

=== camel-core

Camel startup summary will now report total number of routes without (internal routes created by Kamelets or Rest DSL).
This ensures the total number better reflect the total number of user created routes. The summary now includes a separate
number of Kamelets and Rest DSL routes. See also the camel-kamelet section.

The following deprecated methods from the `AbstractCamelContext`, deprecated on 4.2 as part of CAMEL-19998, were finally removed:

* `setTypeConverter`
* `getOrCreateTypeConverter`
* `setManagementMBeanAssembler`
* `getRestRegistryFactory`
* `setRestRegistryFactory`
* `setTransformerRegistry`
* `setValidatorRegistry`
* `setName`
* `setDescription`
* `getBootstrapFactoryFinder`
* `getFactoryFinder`
* `addInterceptStrategy`
* `getStartupStepRecorder`
* `setStartupStepRecorder`
* `resolvePropertyPlaceholders`
* `getBasePackageScan`
* `setBasePackageScan`

Users of these methods should use the respective operations from the `ExtendedCamelContext` (accessed via `getCamelContextExtension()`),
instead.

The following deprecated methods from the `CamelContext`, deprecated on 4.4 as part of CAMEL-20225, were finally removed and/or modified:

* `getUptime`: modified to return a regular `Duration` instance.
* `getUptimeMillis`: removed.
* `getStartDate` removed.

Users of this method should proceed as following:

* `getUptime`: use `ContextHelper.getUptime`.
* `getUptimeMillis`: use `getUptime().toMillis()`.
* `getStartDate`: use `ContextHelper.getStartDate`.

=== Rest DSL

Camel has changed the default value for `inlineRoutes=false` to `inlineRoutes=true` in `restConfiguration`.
It is very typical to define Rest DSL and for each service api, then call a Camel route via `direct` endpoints.
By inlining these two, then you only have 1 route in Camel instead of 2. This helps reduce the clutter of routes
that otherwise is in use when using Rest DSL and many services. You can restore to old behaviour by setting the option back to `inlineRoutes=false`.

However, the inlining requires that each REST endpoint inlined with `direct` endpoints must use unique direct names, ie.

[source,java]
----
rest("/rest")
    .get("/").to("direct:printMethod")
    .post("/").to("direct:printMethod")
    .put("/").to("direct:printMethod");
----

Should be changed to:

[source,java]
----
rest("/rest")
    .get("/").to("direct:printMethod1")
    .post("/").to("direct:printMethod2")
    .put("/").to("direct:printMethod3");
----

Or to keep old behaviour, you can turn off inlining.

Rest DSL will now eagerly resolve property placeholders that are used during building the `rest:` endpoint.

For example with a Rest DSL using a placeholder (`app.mypath = helloapp`) in the `path`:

[source,yaml]
----
- rest:
    path: "{{app.mypath}}"
    post:
      - to: direct:demo
----

Will not be resolved in the `rest` endpoint which can be seen during startup logging:

[source,text]
----
Routes startup (total:2)
Started demo (rest://post:%7B%7Bapp.mypath%7D%7D)
----

The placeholder is now resolved eagerly, and you will see _nicer_ startup logs such as:

[source,text]
----
Routes startup (total:2)
Started demo (rest://post:helloapp)
----

The `restConfiguration` has changed default value in the `useXForwardHeaders` option from `true` to `false`.
Using X-Forward headers is only used in special use-cases such as involving reverse proxies.


=== Avro Data Format

The default library for the `avro` data format has changed from Apache Avro to Jackson Avro. We also use Jackson as default for the JSon dataformat.


=== Intercept EIP

The `interceptFrom` and `interceptSentToEndpoint` EIPs is now storing the intercepted endpoint using key `Exchange.INTERCEPTED_ENDPOINT`
as exchange property instead of a header.

Before:

[source,java]
----
String uri = exchange.getIn().getHeader(Exchange.INTERCEPTED_ENDPOINT, String.class);
----

After:

[source,java]
----
String uri = exchange.getProperty(Exchange.INTERCEPTED_ENDPOINT, String.class);
----

=== camel-bom / camel-spring-boot-bom

The Camel Maven BOMs (`camel-bom` and `camel-spring-boot-bom`) has been changed to use hardcoded
Camel release versions to ensure the BOM is always correct.

=== camel-main

The options `camel.main.backlogTracing`, `camel.main.backlogTracingStandby`, and `camel.main.backlogTracingTemplates` has been
moved into a new group `camel.trace` with more options to configure the backlog tracer.

To enable backlog tracing you should now set `camel.trace.enabled=true` instead of `camel.main.backlogTracing=true`.

=== camel-console

The `@DevConsole` annotation has been enhanced to include more information.

Migrate from

[source,java]
----
@DevConsole("stub")
----

To

[source,java]
----
@DevConsole(name = "stub", description = "Browse messages on stub endpoints")
----

We also renamed the `route-curcuit-breaker` console to `circuit-breaker`.

=== camel-jbang

The `--profile` option on `export` command has been removed.

The `--profile` option on `run` command is now used by `camel-main` to choose profile mode when running Camel with JBang,
or standalone with Camel Main. The default mode is `dev` for development which comes with some additional features enabled
in Camel to gather more information that are relevant for development and the Camel JBang CLI.

You can run with `--profile=prod` to turn off all of this, which makes Camel run more similar to a production situation.

The command `camel generate rest` have removed all the shorthand arguments `such as `-i -o` instead use the long names `--input --output`.

The shorthand `-p` option from `run` and `script` command has been removed. Use `--prop` instead.

=== camel-jsonpath

The `camel-jsonpath` will now work more similar as `camel-jq` when you specify a `resultType` and have a list of entities.
Before `camel-jsonapath` would attempt to convert the `List` to the given `restultType` which often is not usable. What
users want is to be able to convert each entry in the list to a given type such as a POJO.

For example, the snippet below selects all books from a JSON document, which will be in a `List<Map>` object where each
book is an entry as a `Map`. Before Camel would attempt to convert `List` to `Book` which would not be possible.
From this release onwards, Camel will convert each entry to a `Book` so the result is `List<Book>`.

This is also how `camel-jq` works.

[source,java]
----
.transform().jsonpath(".book", Book.class)
----

=== camel-kamelet

Routes created by Kamelets are no longer registered as JMX MBeans to avoid cluttering up with unwanted MBeans, as a Kamelet
is intended to act like a Camel component, despite its implementation is Camel routes. This means that the number of routes
listed from JMX will no longer include Kamelet routes.

The old behaviour can be enabled by setting `registerRoutesCreateByKamelet=true`
on the `ManagementAgent` object. See more in the xref:jmx.adoc[JMX] documentation.

=== camel-micrometer and camel-metrics

The `camel-micrometer` have renamed tag `serviceName` to `kind` and use naming that indicate that its from Camel:

|===
|**Before** | **After**
| serviceName="MicrometerEventNotifierService" | kind="CamelExchangeEvent"
| serviceName="MicrometerMessageHistoryService" | kind="CamelMessageHistory"
| serviceName="MicrometerRoutePolicyService" | kind="CamelRoute"
|===

Because the Kamelets were changed to act more like a Camel component, and not expose internal details as JMX MBeans, then
micrometer and metrics no longer include statistics for those Kamelet routes.

The old behaviour can be enabled by setting `registerRoutesCreateByKamelet=true`
on the `ManagementAgent` object. See more in the xref:jmx.adoc[JMX] documentation.

Added context level metrics to `camel-micrometer`. The metrics with key `camel.route.policy` now include
tag `eventType` that specifies if the metrics is for a route or the entire camel context.
You can turn off context level metrics, by setting `contenxtEnabled=false` on the factory such as:

[source,java]
----
factory.getPolicyConfiguration().setContextEnabled(false);
----

This can also be done easily from `application.properties` such as:

[source,properties]
----
camel.metrics.routePolicyLevel=route
----

=== camel-openapi-java and camel-rest-openapi

Dropped support for the old Swagger 2.0 spec. Only OpenAPI v3 specs is supported now.
Fixed maven dependencies to be JakartaEE compatible.

When using Rest DSL and have `api-doc` enabled via `camel-rest` and `camel-openapi-java`, then
the OpenAPI specification is now generated once during startup instead of on-demand when a client
calls the `/api-doc` endpoint.

=== camel-platform-http-vertx

Added a Cookie Handler allowing the addition, retrieval and expiry of Cookies.

=== camel-shiro

Upgraded Apache Shiro from 1.13 to 2.0.

=== camel-twilio

Upgraded to Twilio 10.1.0 which removed `call-feedback` and `call-feedback-summary` from the available APIs,
to use from Camel.

=== camel-elasticsearch / camel-opensearch

The class `org.apache.camel.component.opensearch.aggregation.BulkRequestAggregationStrategy` has been renamed to `org.apache.camel.component.opensearch.aggregation.OpensearchBulkRequestAggregationStrategy`
The class `org.apache.camel.component.es.aggregation.BulkRequestAggregationStrategy` has been renamed to `org.apache.camel.component.es.aggregation.ElastichsearchBulkRequestAggregationStrategy`

=== camel-spring-redis

The class `org.apache.camel.component.redis.processor.idempotent.RedisIdempotentRepository` has been renamed to `org.apache.camel.component.redis.processor.idempotent.SpringRedisIdempotentRepository`
The class `org.apache.camel.component.redis.processor.idempotent.RedisStringIdempotentRepository` has been renamed to `org.apache.camel.component.redis.processor.idempotent.SpringRedisStringIdempotentRepository`


== Camel Spring Boot

The autoconfiguration with `camel.springboot.xxx` properties has been harmonized to use same naming for
all the Camel runtimes (`camel-main`, `camel-quarkus`, and `camel-spring-boot`). These options have been marked
as deprecated, and you can migrate to use `camel.main.xxx` naming instead.

For example, `camel.springboot.name = Foo` to `camel.main.name = Foo`.

Only the special Spring Boot options are still named `camel.springboot.xxx`.
= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading Camel 4.5 to 4.6

=== variables

When using `variableReceive` then the variable is only set if processing the `Exchange` was completely successfully.

For example, calling a route that fails due to an exception being thrown (even if `onException` or `errorHandler` are in use)
then the variable is no longer set. Also, if the route is marked for rollback, or to stop continuing routing with `.stop()`.

This is the same logic that the routing engine uses, whether to continue routing the `Exchange` or not.

=== camel-core-model

Harmonized model for defining custom beans to be the same for Kamelets and generic beans in XML/YAML DSLs.
Before, there used to be three specialized model classes that have been refactored into a single class, offering the same capabilities
for configuring beans (constructors, properties, builder classes, init/destroy methods etc.)

=== XML DSL

When using XML DSL to define properties on `<bean>` then `<property>` must now be declared inside `<properties>`.

=== YAML DSL

When using YAML DSL to define properties on `bean` then `property` has been removed in favour of using `properties`.

Before:
[source,yaml]
----
    beans:
      - name: "myProcessor"
        type: "#class:com.foo.MyClass"
        property:
          - key: "payload"
            value: "test-payload"
----

After:
[source,yaml]
----
    beans:
      - name: "myProcessor"
        type: "#class:com.foo.MyClass"
        properties:
          payload: "test-payload"
----

Renamed `streamCaching` to `streamCache` on the `route`

Before:

[source,yaml]
----
route:
  streamCaching: false
  from:
    uri: "direct:foo"
    steps:
      - to: "mock:bar"
----

After:

[source,yaml]
----
route:
  streamCache: false
  from:
    uri: "direct:foo"
    steps:
      - to: "mock:bar"
----

=== camel-elasticsearch

The class `org.apache.camel.component.es.aggregation.ElastichsearchBulkRequestAggregationStrategy` has been renamed to `org.apache.camel.component.es.aggregation.ElasticsearchBulkRequestAggregationStrategy`.

=== camel-rest-openapi

The `specifciationUri` in the `rest-api` component has changed from being a `java.net.URI` to a `String` type
, as it uses Camels `ResourceLoader` to load from pluggable resources and also more tooling friendly.

The validator using Atlassian `swagger-request-validator` JAR has been removed, as this library is not JakartaEE compatible,
and was causing classloading problems. The validator is now using a similar validation as Rest DSL. However, the validator
no longer checks for JSON payloads if any required nodes are missing.

=== camel-langchain4j-chat

The Camel Langchain4j Chat component name has been changed from `camel-langchain-chat`to `camel-langchain4j-chat` to adhere to the standardized naming conventions within the LangChain4j ecosystem.

If you are migrating from Camel 4.5, please ensure the following:

- Update your maven dependencies, changing from `camel-langchain-chat`to `camel-langchain4j-chat`
- Adjust your endpoints, replacing `langchain-chat` with `langchain4j-chat`
- Transfer any Camel class references from `org.apache.camel.component.chat.ChatLangchain*` to `org.apache.camel.component.langchain4j.chat.ChatLangchain4j*`
- Modify the header name `The prompt Template`  from  `CamelLangChainChatPromptTemplate` to `CamelLangChain4jChatPromptTemplate`

=== camel-langchain4j-embeddings

The Camel Langchain4j Embeddings component name has been changed from `camel-langchain-embedings` to `camel-langchain4j-embedings` to adhere to the standardized naming conventions within the LangChain4j ecosystem.

If you are migrating from Camel 4.5, please ensure the following

- Update your maven dependencies, changing from  `camel-langchain-embedings`to `camel-langchain4j-embedings`
- Adjust your endpoints, replacing `langchain-embedings` with `langchain4j-embedings`
- Transfer any Camel class references from `org.apache.camel.component.langchain.embeddings.LangChainEmbeddings*` to `org.apache.camel.component.langchain4j.embeddings.LangChain4jEmbeddings*`
- Modify the header name `The Finish Reason` from  `CamelLangChainEmbeddingsFinishReason` to `CamelLangChain4jEmbeddingsFinishReason`
- Modify the header name `The Input Token Count` from  `CamelLangChainEmbeddingsInputTokenCount` to `CamelLangChain4jEmbeddingsInputTokenCount`
- Modify the header name `The Output Token Count` from  `CamelLangChainEmbeddingsOutputTokenCount` to `CamelLangChain4jEmbeddingsOutputTokenCount`
- Modify the header name `The Total Token Count` from  `CamelLangChainEmbeddingsTotalTokenCount` to `CamelLangChain4jEmbeddingsTotalTokenCount`
- Modify the header name `A dense vector embedding of a text` from  `CamelLangChainEmbeddingsVector` to `CamelLangChain4jEmbeddingsVector`

=== camel-platform-http

The `PlatformHttpEngine` class has changed the `createConsumer` method to return a `org.apache.camel.component.platform.http.spi.PlatformHttpConsumer` type,
instead of `org.apache.camel.Consumer`.

=== camel-platform-http-vertx

The id used for multipart file upload attachments on `AttachmentMessage` has changed from being the name of the uploaded file, to the value specifed on the `name` field of the `Content-Disposition` header sent in the request body.

=== camel-google-sheets

The option `scopes` is changed from a `Collection` to be a `String` type to make it easy to configure in endpoint URI from all DSLs and tooling.
Multiple scopes can be separated by comma.

=== camel-kafka

The Kafka component now supports custom subscription adapters for applications with very complex subscription logic.

=== camel-azure-servicebus

The Camel Azure ServiceBus consumer has been refactored to internally use the high-level client instead of the low-level client to more easily support automatic reconnection, competing consumers and high availability, amongst other concerns. The corresponding changes to configuration options are:

- The consumer now supports the Competing Consumers EIP. This can be enabled by increasing the newly added `maxConcurrentCalls` option to a value greater than 1.
- The `disableAutoComplete` option has been removed. Auto-complete is always disabled on the underlying client to ensure that Camel is able to correctly complete, abandon or dead-letter consumed messages as appropriate. The presence of the `disableAutoComplete` option made little sense, since it is not propagated to the underlying client and enabling this option caused Camel not to take any steps to acknowledge/reject consumed messages. Enabling this option would result in message locks being held indefinitely, which is almost certainly not the desired behaviour.
- The high level client always operates in `receiveMessages` mode (peek mode is not supported), so the `consumerOperation` option has been removed, along with the `ServiceBusConsumerOperationDefinition` enum. The associated `peekNumMaxMessages` option has also been removed.
- The `receiverAsyncClient` option has been replaced with a `processorClient` option to enable use of a custom-configured client. The parameter type accepted by this option is `ServiceBusProcessorClient`.
- The `reconnectDelay` option has been removed, since reconnection is now handled internally by the client.

=== camel-jbang

When running using `camel run --source-dir=mydir` then Camel JBang will now preload existing files on startup, such as `application.properties`,
and beans and routes (same as if you run with `cd mydir; camel run *`). This allows configuring settings on Camel on startup, which was not possible beforehand.

The `--open-api` option has changed from _code-first_ to use the new _contract-first_ Rest DSL style by using the specification file direct as-is.

=== camel-as2

The `camel-as2` component has upgraded HTTP Client 4.x to 5.x, and because of that, there are some options that have changed.

Changes for AS2-MDN asynchronous delivery:

 - Added an option allowing clients to request an asynchronous receipt by including a 'Receipt-Delivery-Option' header specifying
the return URL in the request that is sent to the server.
 - Added a consumer capable of receiving signed or unsigned asynchronous message disposition notifications sent by the
message receiver confirming receipt of the message.

=== camel-spring-boot

The autoconfiguration of xref:clustering.adoc[Cluster Service] implementations has been moved to dedicated starters:

[%header, cols="1,2"]
|===
| Type         | Starter
| Consul       | camel-consul-cluster-service-starter
| File         | camel-file-cluster-service-starter
| Infinispan   | camel-infinispan-cluster-service-starter
| JGroups Lock | camel-jgroups-cluster-service-starter
| JGroups Raft | camel-jgroups-raft-cluster-service-starter
| Kubernetes   | camel-kubernetes-cluster-service-starter
| Zookeeper    | camel-zookeeper-cluster-service-starter
|===


The Cluster Services are turned on by default unless they are explicitly disabled, for example:

[source, properties]
----
camel.cluster.consul.enabled = false
----

= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading Camel 4.6 to 4.7

=== API changes

The class `org.apache.camel.impl.engine.ValidatorKey` moved to `org.apache.camel.spi.ValidatorKey`.
The class `org.apache.camel.impl.engine.TransformerKey` moved to `org.apache.camel.spi.TransformerKey`.

The `org.apache.camel.spi.RestRegistry` method `addRestService` has added `boolean contractFirst` parameter to define
if the Rest service is _contract-first_ or _code-first_.

=== camel-core

Add default values to `ThrottlingExceptionRoutePolicy` route policy.

The `EndpointRegistry` interface has been slightly changed to now directly extends `Map<NormalizedEndpointUri, Endpoint>` 
instead of being a parameterized type. This may cause some compilation failures if the code is declaring a variable for the registry.

The statistics collector in the registry has been made immutable. As such, enabling collection of statistics has to be done
prior to creating the type converter registry

=== camel-health

Routes that have been set to **not** auto-startup are reported as UP in health-checks.
We have now implemented similar logic for the consumer health check as well. In this case, the route and consumer health check
are linked together.

Previously a route that has not been started due to `auto-startup=false` would still have its consumer health-check being executed,
which could lead to DOWN due to consumer failing the check.

The `SupervisingRouteController` has now been pre-configured to report `DOWN` during restart attempts, and also when
giving up starting a route. It is the `UnhealthyOnExhausted` and `UnhealthyOnRestarting` options that have been changed to be default `true`.
To have previous behavior, you can set these options to `false`.

== camel-cloud

The camel-cloud component has been deprecated.

=== camel-crypto

PGP dataformat functionality was extracted from `camel-crypto` JAR and placed into `camel-crypto-pgp`.

=== DSL

The WireTap EIP in copy mode, will now do a deep-copy if the message body is of `StreamCache` type to make access to the message body thread-safe.

The Load Balancer EIP has aligned naming and the following balancers has been renamed in XML and YAML DSL:

|===
|*Old Name* |*New Name*

| failOver | failOverLoadBalancer
| random | randomLoadBalancer
| roundRobin | roundRobinLoadBalancer
| sticky | stickyLoadBalancer
| topic | topicLoadBalancer
| weighted | weightedLoadBalancer
|===

For example in XML, you need to change from:

[source,xml]
----
<route>
  <from uri="direct:start"/>
  <loadBalance>
      <failover>
          <exception>java.io.IOException</exception>
      </failover>
      <to uri="direct:x"/>
      <to uri="direct:y"/>
      <to uri="direct:z"/>
  </loadBalance>
</route>
----

To:

[source,xml]
----
<route>
  <from uri="direct:start"/>
  <loadBalance>
      <failoverLoadBalancer>
          <exception>java.io.IOException</exception>
      </failoverLoadBalancer>
      <to uri="direct:x"/>
      <to uri="direct:y"/>
      <to uri="direct:z"/>
  </loadBalance>
</route>
----

=== camel-file

When using `idempotent=true` then the file consumer will now run in eager mode, and `add` the file to the repository
before processing, and call `confirm` when done. Setting `idempotentEager=false` will use the old behaviour.

=== camel-jbang

The `generate` commands has been moved into separate plugin which you need to install first to be able to use.

[source,bash]
----
camel plugin add generate
----

TIP: You can see the list of available plugins using `camel plugin get --all`.

=== camel-jetty / camel-servlet / camel-undertow

When using embedded HTTP server (consumer) then the headers `CamelHttpServletRequest` and `CamelHttpServletResponse`
has been removed.

To gain access to these, then you need to use the `HttpMessage` API instead as shown below:

[source,java]
----
ServletRequest request = exchange.getIn().getHeader(Exchange.HTTP_SERVLET_REQUEST, ServletRequest.class);
ServletResponse request = exchange.getIn().getHeader(Exchange.HTTP_SERVLET_RESPONSE, ServletResponse.class);
----

Should be changed to:

[source,java]
----
ServletRequest request = exchange.getMessage(HttpMessage.class).getRequest();
ServletResponse response = exchange.getMessage(HttpMessage.class).getResponse();
----

=== camel-seda / camel-disruptor

When using `InOnly` exchange pattern then the producer makes a copy of the message to be added to the queue.
Camel will now do a deep-copy if the message body is of `StreamCache` type to make access to the message body thread-safe.

=== camel-debug

The debugger (using `org.apache.camel.spi.BacklogDebugger`) used for tooling such as IDEA and Visual Studio, is fixed
to work better out-of-the-box by just having `camel-debug` JAR or `camel-debug-starter` (for Spring Boot) on the classpath.

An internal change is that the MBean operation `messageHistoryOnBreakpointAsXml` on `ManagedBacklogDebugger` now includes
the current node as last message history, which was expected by IDEA tooling, to make it function again.

=== camel-spring-security

The `camel-spring-security` component has been updated to improve readiness for Spring Security 7.x. Since Spring Security 5.8 the `AccessDecisionManager` interface and the related cooperating classes have been deprecated in favor of `AuthorizationManager` based patterns.
If you are creating Spring Security route policies in your code, you must now refactor them to be based on an `AuthorizationManager`.

For example, you might have a route policy defined as follows:

[source,java]
----
SpringSecurityAuthorizationPolicy authorizationPolicy = new SpringSecurityAuthorizationPolicy();
authorizationPolicy.setAuthenticationManager(authenticationManager);
authorizationPolicy.setSpringSecurityAccessPolicy(new SpringSecurityAccessPolicy("ROLE_ADMIN"));
authorizationPolicy.setAccessDecisionManager(new AffirmativeBased(Collections.singletonList(new RoleVoter())));
----

With the changes implemented in this release, that must be refactored to:

[source,java]
----
SpringSecurityAuthorizationPolicy authorizationPolicy = new SpringSecurityAuthorizationPolicy();
authorizationPolicy.setAuthenticationManager(authenticationManager);
authorizationPolicy.setAuthorizationManager(AuthorityAuthorizationManager.hasRole("ADMIN"));
----

This new pattern supports a more expressive language to define your own authorization rules, exposing the full power of the Spring Security framework to Camel route policies.
See the https://docs.spring.io/spring-security/reference/5.8/migration/servlet/authorization.html#servlet-replace-permissionevaluator-bean-with-methodsecurityexpression-handler[spring documentation] for further details on how to migrate your custom code from `AccessDecisionManager` to `AuthorizationManager`.

=== camel-cloudevents

Moved the `camel-cloudevents` api into `camel-api` and removed the `camel-cloudevents` dependency from all components that provide CloudEvent transformers.

=== camel-hashicorp-vault

The `HashicorpVaultPropertiesFunction` from the hashicorp vault has been changed to avoid declaring statically the Vault Engine.

This means the `camel.vault.hashicorp.engine` property and the support for `CAMEL_HASHICORP_VAULT_ENGINE` environment variable have been removed.

You can now use the following syntax:

`hashicorp:engine:secret`

Where engine will be the Hashicorp Vault Engine to be used. This means you'll be able to use multiple engines at the same time. More details at CAMEL-20775 issue.

=== camel-test

As part of CAMEL-20785, we have started to rework the `CamelTestSupport` class. At this point, it should be highly compatible with
previous versions, as we are laying down the foundations for greater cleanups in the future. However, several methods have been
marked as deprecated. Users of this class are advised to look at the deprecation notices and adjust the code accordingly.

=== camel-pubnub

Upgraded PubNub client from v6 to v9 and the `wherenow` operation is removed due to no longer present in the client.

=== camel-as2

The `camel-as2` component has been updated so that the client can compress a MIME body before signing or compress a MIME body before signing and encrypting as described in
sections https://datatracker.ietf.org/doc/html/rfc5402/#section-3.2[3.2] and https://datatracker.ietf.org/doc/html/rfc5402/#section-3.5[3.5] of https://datatracker.ietf.org/doc/html/rfc5402/[rfc 5402].

When the AS2 server is configured with a decryption key, all received messages require encryption. Otherwise, the server
will return an 'insufficient-security' error disposition. Only messages with valid encryption will be successfully processed,
for instance, 'encrypted', 'signed-encrypted', 'encrypted-compressed', 'encrypted-compressed-signed' and 
'encrypted-signed-compressed' message types.

Messages that cannot be successfully decrypted will return a 'decryption-failed' error disposition.
This includes messages encrypted with a invalid key or if the server receives encrypted messages but is not 
configured with a decryption key.

When the AS2 server is configured with a message signature validation certificate chain, all received messages
require a signature. Otherwise, the server will return an 'insufficient-security' error disposition.
Only messages with a valid signature will be processed, for instance, 'signed', 'compressed-signed',
and 'signed-compressed' message types.

The server will return an 'authentication-failure' error when a message fails signature validation.

When the AS2 server is configured with a message signature validation certificate chain and a decryption key,
all received messages require encryption and a signature.
Otherwise, the server will return an 'insufficient-security' error disposition.
Only messages with a valid signature and encryption will be processed, for instance, 'signed-encrypted', 'encrypted-compressed-signed', 
and 'encrypted-signed-compressed'.

|===
| *signing cert* | no | yes | no | yes
| *decryption key* | no | no | yes | yes

| *plain* | | insufficient-security | insufficient-security | insufficient-security
| *signed* | | | insufficient-security | insufficient-security
| *encrypted* | decryption-failure | decryption-failure | | insufficient-security
| *signed-encrypted* | decryption-failure | decryption-failure | |
| *plain-compressed* | | insufficient-security | insufficient-security  | insufficient-security
| *compressed-signed* | |  | insufficient-security | insufficient-security
| *signed-compressed* | |  | insufficient-security | insufficient-security
| *encrypted-compressed* | decryption-failure | decryption-failure | | insufficient-security
| *encrypted-compressed-signed* | decryption-failure | decryption-failure | |
| *encrypted-signed-compressed* | decryption-failure | decryption-failure | |
|===


=== Camel Spring Boot

==== camel-debug-starter

Using camel debugger with Spring Boot is now moved from `camel-spring-boot` into `camel-debug-starter` where you can configure the debugger
via `camel.debug.` options in `application.properties`.

The `camel-debug-starter` now has `camel.debug.enabled=true` by default to let the debugger be installed out of the box,
by having the JAR on the classpath (as intended). You can turn this off via `camel.debug.enabled=false`.

=== Camel Kotlin deprecation

Camel Kotlin DSL is deprecated.
= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading from 4.8.2 to 4.8.3

=== camel-mina

If using object codec, then you should configure the `objectCodecPattern` configuration to specify
which java classes (FQN) to allow for Object serialization. You can use `*` to accept all patterns.

== Upgrading from 4.8.1 to 4.8.2

=== camel-management

==== Using Route Templates

Camel will now ensure the created routes via route templates
always use unique _nodePrefixId_ to ensure there are no duplicate id clashes, when the template
is used for creating multiple routes.

=== camel-debezium

To avoid split package that can be a problem in environments like OSGI, each camel-debezium module has its own
sub package corresponding to the database type. So for example, all the classes of the module `camel-debezium-postgres`
have been moved to a dedicated package which is `org.apache.camel.component.debezium.postgres` instead of having
everything under the root package `org.apache.camel.component.debezium`.

== Upgrading from 4.8.0 to 4.8.1

The `camel-opentelemetry` component has had significant bug fixes to handle span activation/deactivations
better when Camel route messages synchronously and asynchronously. This component should also work better
on Spring Boot.

In order to fix the problems reported we had to align the Opentelemetry dependencies to a version which is different from the one used in Spring Boot 3.3.x BOM. 
If you're using such BOM for your **Camel Spring Boot runtime** application, you will need to make sure to force the usage of the Opentelemetry dependencies below:
```
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-sdk</artifactId>
    <version>1.43.0</version>
</dependency>
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-api</artifactId>
    <version>1.43.0</version>
</dependency>
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-context</artifactId>
    <version>1.43.0</version>
</dependency>
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-logs</artifactId>
    <version>1.43.0</version>
</dependency>
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-metrics</artifactId>
    <version>1.43.0</version>
</dependency>
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-sdk-common</artifactId>
    <version>1.43.0</version>
</dependency>
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-sdk-metrics</artifactId>
    <version>1.43.0</version>
</dependency>
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-sdk-logs</artifactId>
    <version>1.43.0</version>
</dependency>
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-sdk-trace</artifactId>
    <version>1.43.0</version>
</dependency>
<dependency>
    <groupId>io.opentelemetry</groupId>
    <artifactId>opentelemetry-api-incubator</artifactId>
    <version>1.43.0-alpha</version>
</dependency>
```

== Upgrading Camel 4.7 to 4.8

=== camel-api

Added `void bind(String id, Class<?> type, Object bean, String initMethod, String destroyMethod)` method to `org.apache.camel.spi.Registry`
to support init and destroy method on beans.

=== camel-core

The `UseOriginalAggregationStrategy` class will now propagate the caught exception stored in the exchange property `Exchange.EXCEPTION_CAUGHT`
as well. For example, when using the Splitter EIP with this, then any caught exception during splitting would be stored
as well, which allows access to this information afterward, for example, in an `onCompletion` where the caught exception
can be used to know some error happened during splitting.

Internally, Camel will now use Java's own `InputStream.transferTo` for copying data between streams whenever such copies don't
require customized buffer sizes or data flushing policies. Additionally, the size of the data buffer used by Camel when
performing these copies has increased from 4096 bytes to 16384 bytes (the default buffer size used by Java 21).

The tracer (`BacklogTracer`) has changed the `backlogSize` default value from `1000` to `100`, and `maxBodySize` from `128kb` to `32kb`.
This reduces the amount of data captured and stored and helps reduce the tracing overhead.

The `org.apache.camel.support.DefaultExchangeHolder` will now include both exchange variables and properties,
if the parameter `includeProperties` is set to true.

=== camel-jbang

The `camel trace` command has changed to show tracing status (by default). To dump traced messages use `camel trace --action=dump`.

*Breaking changes only in 4.8.0* The parameter `--repos` has been renamed `--repository` for `run` and `export` commands. It requires to be updated when using from command-line and in `application.properties`. In 4.8.1, the `--repos` has been set back and  `--repository` removed.

=== Deprecated Components

The following components that were marked as deprecated:

* camel-univocity-parsers

=== camel-as2

The header prefixes have been corrected from `CamelAS2.` -> `CamelAs2.` to be consistent with naming convention
used by other API-based components. The documentation uses the correct naming prefix as `CamelAs2.`.

=== camel-kafka

The `KafkaIdempotentRepository` will now continue to sync cache updates after Camel has been started.
You can configure `startupOnly=true` to only sync the cache once on startup,
(however, then the cache is not synced with other Camel nodes in a cluster).

=== camel-langchain4j-chat

The chat-with-tools feature was deprecated. Use the new `camel-langchain4j-tool` component.

=== camel-tests

Continuing the multi-release tests cleanups, on this one, restricted methods from the `CamelTestSupport` class
have been marked as final and cannot be extended.

=== Preferred JAX-B implementation: `org.glassfish.jaxb:jaxb-runtime`

We stopped relying on `com.sun.xml.bind:jaxb-impl` in favor of `org.glassfish.jaxb:jaxb-runtime`.
This change should have no impact on existing code, because recent versions of the two artifacts bring the same classes.
The main motivation for this change is to allow projects that still require classes from `javax.xml.bind` package
to be able to depend on pre-3.x versions of `com.sun.xml.bind:jaxb-impl` together with the recent version of
`org.glassfish.jaxb:jaxb-runtime` brought by Camel.
= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading Camel 4.8 to 4.9

=== camel-api

Added `setLazyBeanStrategy`/`getLazyBeanStrategy` methods to `org.apache.camel.spi.CamelBeanPostProcessor`.

Renamed `Exchange.ACTIVE_SPAN` to `Exchange.OTEL_ACTIVE_SPAN`.
Renamed `ExchangePropertyKey.ACTIVE_SPAN` to `ExchangePropertyKey.OTEL_ACTIVE_SPAN`.

=== camel-management

The `queueSize` attribute on endpoints which are `ManagedBrowseableEndpoint` is changed from returning a `Long` value
to an `Integer` value.

==== Using Route Templates

Camel will now ensure the created routes via route templates
always use unique _nodePrefixId_ to ensure there are no duplicate id clashes when the template
is used for creating multiple routes.

=== camel-xml-io

The XML dumper no longer includes attributes which are using default values.

=== camel-jackson

The option `useWriter` on JSON data format and camel-jackson,
has been replaced with `combineUnicodeSurrogates` as it is intended for 4-bytes characters such as Japanese.

=== camel-jms

The camel-jms component has changed its default `HeaderFilterStrategy` to also remove any `Camel...` headers,
to act similar to other Camel components. If the old classic behavior is needed then you can configure the `JmsComponent` to use `org.apache.camel.component.jms.ClassicJmsHeaderFilterStrategy`
as header filter strategy which is the old implementation.

Added `int limit` as parameter to the `browse` method in `org.apache.camel.component.jms.QueueBrowseStrategy`.

=== camel-opentelemetry

The `camel-opentelemetry` component has had significant bug fixes to handle span activation/deactivations
better when Camel route messages synchronously and asynchronously. This component should also work better
on Spring Boot.

=== camel-pubnub

Upgraded the pubnub client to 10.x, which removed the `cipherKey` option.

=== camel-smooks

Upgraded Smooks from version 2.0.0-RC4 to version 2.0.1 which has
https://www.smooks.org/documentation/#migrating_from_smooks_1_7_to_2_0[API breaking changes] in Smooks.

=== camel-hashicorp-vault properties function

The syntax for retrieving a single field of a secret has been changed.

From this:

`{{hashicorp:secret:database/username}}`

to this:

`{{hashicorp:secret:database#username}}`

You could find more details on CAMEL-21179 issue

=== camel-aws-secrets-manager properties function

The syntax for retrieving a single field of a secret has been changed.

From this:

`{{aws:database/username}}`

to this:

`{{aws:database#username}}`

You could find more details on CAMEL-21179 issue

=== camel-google-secret-manager properties function

The syntax for retrieving a single field of a secret has been changed.

From this:

`{{gcp:database/username}}`

to this:

`{{gcp:database#username}}`

You could find more details on CAMEL-21179 issue

=== camel-azure-key-vault properties function

The syntax for retrieving a single field of a secret has been changed.

From this:

`{{azure:database/username}}`

to this:

`{{azure:database#username}}`

You could find more details on CAMEL-21179 issue

=== camel-aws

The `camel-aws2-s3` when using `headBucket` operation will now store the result
in a header named `CamelAwsS3BucketExists` whether the bucket exists or not.

Previously an `software.amazon.awssdk.services.s3.model.NoSuchBucketException` was thrown.
However, this would require using error handling to just check whether the bucket existed.
Returning a boolean makes it easier in Camel routes to decide what to do.
You may also set the option `ignoreBody=true` to not change the message body.

=== camel-test

The `CamelTestSupport` class was modified so that the JUnit 5 extension code that was part of the class itself,
was moved to a separate class. This is part of the work being done on https://issues.apache.org/jira/browse/CAMEL-20837[CAMEL-20837]
to modernize the base test code.

In many cases, code should work with no changes provided they are not using any of the API methods that
were deprecated in Camel 4.7.0.
Additionally, starting with Camel 4.9, we strongly recommend users to avoid relying on single-instance contexts (created
via `@TestInstance(TestInstance.Lifecycle.PER_CLASS)`), as this is considered a deprecated functionality that will be removed in the
future.
The logs will print a warning message if this behavior is detected.

=== camel-debezium

To avoid split package that can be a problem in environments like OSGI, each camel-debezium module has its own
subpackage corresponding to the database type. So for example, all the classes of the module `camel-debezium-postgres`
have been moved to a dedicated package which is `org.apache.camel.component.debezium.postgres` instead of having
everything under the root package `org.apache.camel.component.debezium`.

=== Deprecated components

The following components were marked as deprecated:

- `camel-etcd3`

=== Removed deprecated components

The following experimental DSL has been removed:

- `camel-groovy-dsl`
- `camel-js-dsl`
- `camel-jsh-dsl`

The Camel team is only focusing on Java, XML and YAML DSL.

=== Removed API

==== Kotlin DSL

The Kotlin DSL, which was deprecated in Camel 4.7.0, has now been removed. The routes must be migrated to another DSL such as Java, YAML or XML.

The following modules have been removed:

* `camel-kotlin-dsl`
* `camel-kotlin-api`
= Apache Camel 4.x Upgrade Guide

IMPORTANT: If you are migrating from Camel 3.x then use the
xref:camel-4-migration-guide.adoc[Camel 3.x to 4.0 Migration Guide] first.

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

You can find the upgrade guide for each release in the following pages:

- xref:camel-4x-upgrade-guide-4_1.adoc[Upgrade guide 4.0 -> 4.1]
- xref:camel-4x-upgrade-guide-4_2.adoc[Upgrade guide 4.1 -> 4.2]
- xref:camel-4x-upgrade-guide-4_3.adoc[Upgrade guide 4.2 -> 4.3]
- xref:camel-4x-upgrade-guide-4_4.adoc[Upgrade guide 4.3 -> 4.4]
- xref:camel-4x-upgrade-guide-4_5.adoc[Upgrade guide 4.4 -> 4.5]
- xref:camel-4x-upgrade-guide-4_6.adoc[Upgrade guide 4.5 -> 4.6]
- xref:camel-4x-upgrade-guide-4_7.adoc[Upgrade guide 4.6 -> 4.7]
- xref:camel-4x-upgrade-guide-4_8.adoc[Upgrade guide 4.7 -> 4.8]
- xref:camel-4x-upgrade-guide-4_9.adoc[Upgrade guide 4.8 -> 4.9]
- xref:camel-4x-upgrade-guide-4_10.adoc[Upgrade guide 4.9 -> 4.10]
- xref:camel-4x-upgrade-guide-4_11.adoc[Upgrade guide 4.10 -> 4.11]
- xref:camel-4x-upgrade-guide-4_12.adoc[Upgrade guide 4.11 -> 4.12]
